<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Peeling Shed Supply</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        h2 {
            color: #333;
        }

        .back-button {
            text-decoration: none;
            color: white;
            background-color: #007BFF;
            padding: 10px 15px;
            border-radius: 4px;
            float: right;
            margin-bottom: 20px;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }

        .back-button:hover {
            background-color: #0056b3;
        }

        form {
            background: #fff;
            padding: 30px; /* Increased padding for more space */
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin: 15px 0 5px; /* Increased margin for better spacing */
            font-weight: bold;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 12px; /* Increased padding for larger input fields */
            margin-bottom: 20px; /* Increased margin for better spacing */
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px; /* Increased font size for better readability */
        }

        /* Specific styles for the SpotPurchase fields */
        #id_SpotPurchase_total_boxes,
        #id_SpotPurchase_quantity,
        #id_SpotPurchase_average_box_weight {
            width: 100%; /* Set to 100% for full width */
            padding: 12px; /* Increased padding for better usability */
            font-size: 16px; /* Increased font size for better readability */
        }

        /* Date picker styling */
        input[type="date"] {
            padding: 12px; /* Increased padding for date input */
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            font-size: 16px; /* Increased font size for better readability */
        }

        button {
            background-color: #007BFF;
            color: white;
            padding: 12px 15px; /* Increased padding for button */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .formset-row {
            background: #f9f9f9;
            padding: 15px; /* Increased padding for formset rows */
            margin: 15px 0; /* Increased margin for better spacing */
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .formset-row input[type="text"],
        .formset-row select {
            width: calc(100% - 20px);
            display: inline-block;
            margin-right: 10px;
        }

        .formset-row label {
            display: inline-block;
            margin: 0 10px 0 0;
        }

        h4 {
            margin-top: 20px;
            color: #333;
        }

        #formset-container {
            margin-top: 20px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>

    <a href="{% url 'adminapp:peeling_shed_supply_list' %}" class="back-button">Back to List</a>
    <h2>Create Peeling Shed Supply</h2>

    <form method="post">
        {% csrf_token %}

        {{ form.date.label_tag }} {{ form.date }}<br>
        {{ form.voucher_number.label_tag }} {{ form.voucher_number }}<br>
        {{ form.shed.label_tag }} {{ form.shed }}<br>
        {{ form.vehicle_number.label_tag }} {{ form.vehicle_number }}<br>

        {{ form.spot_purchase_date.label_tag }} {{ form.spot_purchase_date }}<br>

        {{ form.spot_purchase.label_tag }}
        <select id="id_spot_purchase" name="spot_purchase">
            <option value="">---------</option>
        </select><br>

        {{ form.spot_purchase_item.label_tag }}
        <select id="id_spot_purchase_item" name="spot_purchase_item">
            <option value="">---------</option>
        </select><br>

        {{ form.SpotPurchase_total_boxes.label_tag }} 
        <input type="text" id="id_SpotPurchase_total_boxes" name="SpotPurchase_total_boxes"><br>

        {{ form.SpotPurchase_quantity.label_tag }} 
        <input type="text" id="id_SpotPurchase_quantity" name="SpotPurchase_quantity"><br>

        {{ form.SpotPurchase_average_box_weight.label_tag }} 
        <input type="text" id="id_SpotPurchase_average_box_weight" name="SpotPurchase_average_box_weight"><br>

        <label for="id_boxes_received_shed">Boxes Received Shed</label>
        <input type="text" name="boxes_received_shed" id="id_boxes_received_shed"><br>

        <label for="id_quantity_received_shed">Quantity Received Shed</label>
        <input type="text" name="quantity_received_shed" id="id_quantity_received_shed" readonly><br>

        {{ form.peeling_type.label_tag }} {{ form.peeling_type }}<br>
        {{ form.amount.label_tag }} {{ form.amount }}<br>

        <h4>Peeling Charges</h4>
        <div id="formset-container">
            {{ formset.management_form }}
            {% for form in formset %}
            <div class="formset-row">
                {{ form.id }}
                {{ form.item.label_tag }} {{ form.item }}
                {{ form.item_type.label_tag }} {{ form.item_type }}
                {{ form.amount.label_tag }} {{ form.amount }}
                {{ form.unit.label_tag }} {{ form.unit }}
            </div>
            {% endfor %}
        </div>

        <button type="submit">Submit</button>
    </form>

    <script>
        // 1. Spot Purchase Date -> Spot Purchases
        $('#id_spot_purchase_date').on('change', function () {
            $.get("{% url 'adminapp:get_spot_purchases_by_date' %}", {
                'date': $(this).val()
            }, function (data) {
                const select = $('#id_spot_purchase');
                select.empty().append('<option value="">---------</option>');
                data.forEach(p => select.append(`<option value="${p.id}">${p.name}</option>`));
                $('#id_spot_purchase_item').empty().append('<option value="">---------</option>');
            });
        });

        // 2. Spot Purchase -> Items
        $('#id_spot_purchase').on('change', function () {
            $.get("{% url 'adminapp:get_spot_purchase_items' %}", {
                'spot_purchase_id': $(this).val()
            }, function (data) {
                const select = $('#id_spot_purchase_item').empty().append('<option value="">---------</option>');
                data.forEach(i => select.append(`<option value="${i.id}">${i.name}</option>`));
            });
        });

        // 3. Item -> Auto-fill details
        $('#id_spot_purchase_item').on('change', function () {
            $.get("{% url 'adminapp:get_spot_purchase_item_details' %}", {
                'item_id': $(this).val()
            }, function (data) {
                $('#id_SpotPurchase_total_boxes').val(data.total_boxes);
                $('#id_SpotPurchase_quantity').val(data.quantity);
                $('#id_SpotPurchase_average_box_weight').val(data.average_weight);
            });
        });
    </script>

    <!-- shed box Received quantity calculation script -->
    <script>
        function calculateQuantityReceivedShed() {
            let boxesReceived = parseFloat($("#id_boxes_received_shed").val()) || 0;
            let avgWeight = parseFloat($("#id_SpotPurchase_average_box_weight").val()) || 0;
            let quantity = boxesReceived * avgWeight;
            $("#id_quantity_received_shed").val(quantity.toFixed(2));
        }

        $(document).ready(function () {
            // Trigger on change or keyup
            $("#id_boxes_received_shed").on('input', function () {
                calculateQuantityReceivedShed();
            });

            // Also recalculate if average box weight is changed by AJAX (if editable)
            $("#id_SpotPurchase_average_box_weight").on('input', function () {
                calculateQuantityReceivedShed();
            });
        });
    </script>

    <script>
        $('#id_shed').change(function () {
            var shedId = $(this).val();
            if (shedId) {
                $.ajax({
                    url: '/adminapp/ajax/get-peeling-types/',
                    data: {
                        'shed_id': shedId
                    },
                    dataType: 'json',
                    success: function (data) {
                        const peelingTypes = data.peeling_types;
                        const formsetDiv = $('#peeling-type-formset'); // Your formset container
                        formsetDiv.empty(); // Clear existing rows

                        peelingTypes.forEach(function (type, index) {
                            const formHtml = `
                        <div class="formset-row">
                            <input type="hidden" name="peelings-${index}-item" value="${type.item_id}">
                            <input type="hidden" name="peelings-${index}-item_type" value="${type.item_type_id}">
                            <input type="text" value="${type.item_name}" readonly>
                            <input type="text" value="${type.item_type_name}" readonly>
                            <input type="text" name="peelings-${index}-amount" value="${type.amount}">
                            <input type="text" name="peelings-${index}-unit" value="${type.unit}">
                        </div>
                    `;
                            formsetDiv.append(formHtml);
                        });

                        $('#id_peelings-TOTAL_FORMS').val(peelingTypes.length);
                    }
                });
            }
        });
    </script>

    <script>
        function updatePeelingCharges(peelingTypes) {
            const container = $('#formset-container');
            const totalForms = $('#id_form-TOTAL_FORMS');
            const currentCount = parseInt(totalForms.val());
            let newCount = 0;

            // Clear existing dynamic forms (optional: or keep existing and append)
            container.find('.formset-row:gt(0)').remove();

            peelingTypes.forEach((pt, i) => {
                const index = i;
                const newForm = $(`
                    <div class="formset-row">
                        <input type="hidden" name="form-${index}-id" id="id_form-${index}-id">
                        <label for="id_form-${index}-item">Item:</label>
                        <select name="form-${index}-item" id="id_form-${index}-item">
                            <option value="${pt.item_id}" selected>${pt.item_name}</option>
                        </select>

                        <label for="id_form-${index}-item_type">Type:</label>
                        <select name="form-${index}-item_type" id="id_form-${index}-item_type">
                            ${pt.item_type_id ? `<option value="${pt.item_type_id}" selected>${pt.item_type_name}</option>` : `<option value="">------</option>`}
                        </select>

                        <label for="id_form-${index}-amount">Amount:</label>
                        <input type="text" name="form-${index}-amount" id="id_form-${index}-amount" value="${pt.amount}">

                        <label for="id_form-${index}-unit">Unit:</label>
                        <input type="text" name="form-${index}-unit" id="id_form-${index}-unit" value="${pt.unit}">
                    </div>
                `);
                container.append(newForm);
                newCount++;
            });

            totalForms.val(newCount);
        }

        $(document).ready(function () {
            $('#id_shed').change(function () {
                const shedId = $(this).val();
                if (shedId) {
                    $.ajax({
                        url: "{% url 'adminapp:get_peeling_charge_by_shed' %}",
                        data: { 'shed_id': shedId },
                        success: function (response) {
                            updatePeelingCharges(response.peeling_types);
                        }
                    });
                }
            });
        });
    </script>

</body>

</html>