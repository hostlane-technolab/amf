{% extends 'admin_base.html' %}
{% block title %} Peeling Shed Supply List {% endblock %}
{% block content %}

<style>
    .main-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        margin-top: 2rem;
    }

    .top-nav {
        margin-bottom: 20px;
        display: flex;
        justify-content: flex-start;
    }

    .back-button {
        display: inline-block;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        transition: all 0.3s;
        font-weight: 500;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .back-button:hover {
        background-color: #0069d9;
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        color: white;
        text-decoration: none;
    }

    .primary-title {
        color: #007BFF;
        margin-bottom: 30px;
        font-size: 2rem;
        font-weight: 700;
        text-align: center;
    }

    .category-header {
        color: #007BFF;
        margin-bottom: 20px;
        font-size: 1.3rem;
        font-weight: 700;
        border-left: 5px solid #007BFF;
        padding-left: 10px;
    }

    .info-panel {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
    }

    .input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .input-container {
        display: flex;
        flex-direction: column;
    }

    .input-title {
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
        font-size: 0.95rem;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select {
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #fff;
        font-size: 14px;
        transition: all 0.3s;
        width: 100%;
        box-sizing: border-box;
    }

    input:focus,
    select:focus {
        border-color: #007BFF !important;
        outline: 2px solid #007BFF !important;
        outline-offset: 0px;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25) !important;
    }

    select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none'%3e%3cpath d='M1 4l5 5 5-5' stroke='%23333' stroke-width='2'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 35px;
    }

    .dynamic-form-box {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
    }

    .dynamic-item {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        padding: 20px;
        background: #f9fbfd;
        border-radius: 6px;
        margin-bottom: 15px;
        border: 1px solid #e2e6ea;
    }

    .dynamic-input {
        display: flex;
        flex-direction: column;
    }

    .dynamic-input label {
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
        font-size: 0.9rem;
    }

    .submit-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 6px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        font-size: 1rem;
    }

    .submit-btn:hover {
        background-color: #0069d9;
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .submit-btn:active {
        transform: translateY(0);
    }

    .button-area {
        text-align: center;
        margin-top: 30px;
    }

    .disabled-input {
        background-color: #f8f9fa;
        color: #6c757d;
        border-color: #dee2e6;
    }

    @media (max-width: 768px) {
        .input-grid {
            grid-template-columns: 1fr;
        }
        
        .dynamic-item {
            grid-template-columns: 1fr;
        }
        
        .main-wrapper {
            padding: 10px;
            margin-top: 1rem;
        }
    }
</style>

<div class="main-wrapper">
    <div class="top-nav">
        <a href="{% url 'adminapp:peeling_shed_supply_list' %}" class="back-button">‚Üê Back to List</a>
    </div>

    <h2 class="primary-title">Update Peeling Shed Supply</h2>

    <form method="post">
        {% csrf_token %}

        <!-- Basic Details Section -->
        <div class="info-panel">
            <h3 class="category-header">Basic Details</h3>
            <div class="input-grid">
                <div class="input-container">
                    <label class="input-title">{{ form.date.label }}</label>
                    {{ form.date }}
                </div>
                <div class="input-container">
                    <label class="input-title">{{ form.voucher_number.label }}</label>
                    {{ form.voucher_number }}
                </div>
                <div class="input-container">
                    <label class="input-title">{{ form.shed.label }}</label>
                    {{ form.shed }}
                </div>
                <div class="input-container">
                    <label class="input-title">{{ form.vehicle_number.label }}</label>
                    {{ form.vehicle_number }}
                </div>
            </div>
        </div>

        <!-- Spot Purchase Details Section -->
        <div class="info-panel">
            <h3 class="category-header">Spot Purchase Details</h3>
            <div class="input-grid">
                <div class="input-container">
                    <label class="input-title">{{ form.spot_purchase_date.label }}</label>
                    {{ form.spot_purchase_date }}
                </div>
                <div class="input-container">
                    <label class="input-title">{{ form.spot_purchase.label }}</label>
                    <select id="id_spot_purchase" name="spot_purchase">
                        {% if form.spot_purchase.value %}
                            <option value="{{ form.spot_purchase.value }}" selected>
                                {{ form.spot_purchase.instance }}
                            </option>
                        {% else %}
                            <option value="">---------</option>
                        {% endif %}
                    </select>
                </div>
                <div class="input-container">
                    <label class="input-title">{{ form.spot_purchase_item.label }}</label>
                    <select id="id_spot_purchase_item" name="spot_purchase_item">
                        {% if form.spot_purchase_item.value %}
                            <option value="{{ form.spot_purchase_item.value }}" selected>
                                {{ form.spot_purchase_item.instance }}
                            </option>
                        {% else %}
                            <option value="">---------</option>
                        {% endif %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Purchase Information Section -->
        <div class="info-panel">
            <h3 class="category-header">Purchase Information</h3>
            <div class="input-grid">
                <div class="input-container">
                    <label class="input-title">{{ form.SpotPurchase_total_boxes.label }}</label>
                    {{ form.SpotPurchase_total_boxes }}
                </div>
                <div class="input-container">
                    <label class="input-title">{{ form.SpotPurchase_quantity.label }}</label>
                    {{ form.SpotPurchase_quantity }}
                </div>
                <div class="input-container">
                    <label class="input-title">{{ form.SpotPurchase_average_box_weight.label }}</label>
                    {{ form.SpotPurchase_average_box_weight }}
                </div>
            </div>
        </div>

        <!-- Shed Received Details Section -->
        <div class="info-panel">
            <h3 class="category-header">Shed Received Details</h3>
            <div class="input-grid">
                <div class="input-container">
                    <label class="input-title">Boxes Received Shed</label>
                    {{ form.boxes_received_shed }}
                </div>
                <div class="input-container">
                    <label class="input-title">Quantity Received Shed</label>
                    {{ form.quantity_received_shed }}
                </div>
            </div>
        </div>

        <!-- Peeling Charges Section -->
        <div class="dynamic-form-box">
            <h3 class="category-header">Peeling Charges</h3>
            <div id="formset-container">
                {{ formset.management_form }}
                {% for form in formset %}
                <div class="dynamic-item">
                    {{ form.id }}
                    <div class="dynamic-input">
                        <label>{{ form.item.label }}</label>
                        {{ form.item }}
                    </div>
                    <div class="dynamic-input">
                        <label>{{ form.item_type.label }}</label>
                        {{ form.item_type }}
                    </div>
                    <div class="dynamic-input">
                        <label>{{ form.amount.label }}</label>
                        {{ form.amount }}
                    </div>
                    <div class="dynamic-input">
                        <label>{{ form.unit.label }}</label>
                        {{ form.unit }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="button-area">
            <button type="submit" class="submit-btn">Update Peeling Shed Supply</button>
        </div>
    </form>
</div>

<script>
    // Spot Purchase Date -> Spot Purchases
    $('#id_spot_purchase_date').on('change', function () {
        $.get("{% url 'adminapp:get_spot_purchases_by_date' %}", {
            'date': $(this).val()
        }, function (data) {
            const select = $('#id_spot_purchase');
            select.empty().append('<option value="">---------</option>');
            data.forEach(p => select.append(`<option value="${p.id}">${p.name}</option>`));
            $('#id_spot_purchase_item').empty().append('<option value="">---------</option>');
        });
    });

    // Spot Purchase -> Items
    $('#id_spot_purchase').on('change', function () {
        $.get("{% url 'adminapp:get_spot_purchase_items' %}", {
            'spot_purchase_id': $(this).val()
        }, function (data) {
            const select = $('#id_spot_purchase_item').empty().append('<option value="">---------</option>');
            data.forEach(i => select.append(`<option value="${i.id}">${i.name}</option>`));
        });
    });

    // Item -> Auto-fill details
    $('#id_spot_purchase_item').on('change', function () {
        $.get("{% url 'adminapp:get_spot_purchase_item_details' %}", {
            'item_id': $(this).val()
        }, function (data) {
            $('#id_SpotPurchase_total_boxes').val(data.total_boxes);
            $('#id_SpotPurchase_quantity').val(data.quantity);
            $('#id_SpotPurchase_average_box_weight').val(data.average_weight);
        });
    });

    // Shed box Received quantity calculation
    function calculateQuantityReceivedShed() {
        let boxesReceived = parseFloat($("#id_boxes_received_shed").val()) || 0;
        let avgWeight = parseFloat($("#id_SpotPurchase_average_box_weight").val()) || 0;
        let quantity = boxesReceived * avgWeight;
        $("#id_quantity_received_shed").val(quantity.toFixed(2));
    }

    $(document).ready(function () {
        $("#id_boxes_received_shed").on('input', function () {
            calculateQuantityReceivedShed();
        });
        $("#id_SpotPurchase_average_box_weight").on('input', function () {
            calculateQuantityReceivedShed();
        });
    });

    // Load Peeling charges dynamically
    function updatePeelingCharges(peelingTypes) {
        const container = $('#formset-container');
        const totalForms = $('#id_form-TOTAL_FORMS');
        let newCount = 0;

        container.find('.dynamic-item:gt(0)').remove();

        peelingTypes.forEach((pt, i) => {
            const newForm = $(`
                <div class="dynamic-item">
                    <input type="hidden" name="form-${i}-id" id="id_form-${i}-id">
                    <div class="dynamic-input">
                        <label for="id_form-${i}-item">Item:</label>
                        <select name="form-${i}-item" id="id_form-${i}-item">
                            <option value="${pt.item_id}" selected>${pt.item_name}</option>
                        </select>
                    </div>
                    <div class="dynamic-input">
                        <label for="id_form-${i}-item_type">Type:</label>
                        <select name="form-${i}-item_type" id="id_form-${i}-item_type">
                            ${pt.item_type_id ? `<option value="${pt.item_type_id}" selected>${pt.item_type_name}</option>` : `<option value="">------</option>`}
                        </select>
                    </div>
                    <div class="dynamic-input">
                        <label for="id_form-${i}-amount">Amount:</label>
                        <input type="text" name="form-${i}-amount" id="id_form-${i}-amount" value="${pt.amount}">
                    </div>
                    <div class="dynamic-input">
                        <label for="id_form-${i}-unit">Unit:</label>
                        <input type="text" name="form-${i}-unit" id="id_form-${i}-unit" value="${pt.unit}">
                    </div>
                </div>
            `);
            container.append(newForm);
            newCount++;
        });

        totalForms.val(newCount);
    }

    $(document).ready(function () {
        $('#id_shed').change(function () {
            const shedId = $(this).val();
            if (shedId) {
                $.ajax({
                    url: "{% url 'adminapp:get_peeling_charge_by_shed' %}",
                    data: { 'shed_id': shedId },
                    success: function (response) {
                        updatePeelingCharges(response.peeling_types);
                    }
                });
            }
        });
    });
</script>

{%endblock%}