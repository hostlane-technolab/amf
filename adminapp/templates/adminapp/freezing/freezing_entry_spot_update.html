<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Update Freezing Entry</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }

        h2 {
            color: #007BFF;
            margin-bottom: 20px;
        }

        a {
            text-decoration: none;
            color: #007BFF;
            margin-bottom: 20px;
            display: inline-block;
        }

        a:hover {
            text-decoration: underline;
        }

        form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            border-color: #007BFF;
            outline: none;
        }

        .error {
            color: red;
            font-size: 0.9em;
        }

        fieldset {
            border: 1px solid #007BFF;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            background: #f9f9f9;
        }

        legend {
            font-weight: bold;
            color: #007BFF;
        }

        .formset-form {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background: #ffffff;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }

        .button {
            background: #007BFF;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .button:hover {
            background: #0056b3;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
        }

        .remove-btn:hover {
            background: #a71d2a;
        }

        .total-table {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
        }

        .total-table th, .total-table td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
        }

        .total-table th {
            background-color: #007BFF;
            color: white;
        }

        /* Hide specified fields */
        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <h2>Update Freezing Entry</h2>
    <a href="{% url 'adminapp:freezing_entry_spot_list' %}">Back to List</a>

    <form method="post">
        {% csrf_token %}
        <div class="form-grid">
            <div class="form-column">
                <label for="{{ form.freezing_date.id_for_label }}">Freezing Date</label>
                {{ form.freezing_date }}
                {% if form.freezing_date.errors %}
                    <div class="error">{{ form.freezing_date.errors }}</div>
                {% endif %}
            </div>
            <div class="form-column">
                <label for="{{ form.voucher_number.id_for_label }}">Voucher Number</label>
                {{ form.voucher_number }}
                {% if form.voucher_number.errors %}
                    <div class="error">{{ form.voucher_number.errors }}</div>
                {% endif %}
            </div>
            <div class="form-column">
                <label for="{{ form.spot_purchase_date.id_for_label }}">Spot Purchase Date</label>
                {{ form.spot_purchase_date }}
                {% if form.spot_purchase_date.errors %}
                    <div class="error">{{ form.spot_purchase_date.errors }}</div>
                {% endif %}
            </div>
            <div class="form-column">
                <label for="{{ form.spot.id_for_label }}">Spot</label>
                {{ form.spot }}
                {% if form.spot.errors %}
                    <div class="error">{{ form.spot.errors }}</div>
                {% endif %}
            </div>
            <div class="form-column">
                <label for="{{ form.spot_agent.id_for_label }}">Spot Agent</label>
                {{ form.spot_agent }}
                {% if form.spot_agent.errors %}
                    <div class="error">{{ form.spot_agent.errors }}</div>
                {% endif %}
            </div>
            <div class="form-column">
                <label for="{{ form.spot_supervisor.id_for_label }}">Spot Supervisor</label>
                {{ form.spot_supervisor }}
                {% if form.spot_supervisor.errors %}
                    <div class="error">{{ form.spot_supervisor.errors }}</div>
                {% endif %}
            </div>
        </div>

        <fieldset>
            <legend>Items</legend>
            {{ formset.management_form }}
            <div id="formset-container">
                {% for form in formset %}
                    <div class="formset-form">
                        <!-- Hidden fields for update functionality -->
                        {{ form.id }}
                        
                        <div class="form-grid">
                            <div class="form-column">
                                <label for="{{ form.processing_center.id_for_label }}">Processing Centre</label>
                                {{ form.processing_center }}
                                {% if form.processing_center.errors %}
                                    <div class="error">{{ form.processing_center.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.store.id_for_label }}">Store</label>
                                {{ form.store }}
                                {% if form.store.errors %}
                                    <div class="error">{{ form.store.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.shed.id_for_label }}">Shed</label>
                                {{ form.shed }}
                                {% if form.shed.errors %}
                                    <div class="error">{{ form.shed.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.item.id_for_label }}">Item Name</label>
                                {{ form.item }}
                                {% if form.item.errors %}
                                    <div class="error">{{ form.item.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.unit.id_for_label }}">Unit</label>
                                {{ form.unit }}
                                {% if form.unit.errors %}
                                    <div class="error">{{ form.unit.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.glaze.id_for_label }}">Glaze</label>
                                {{ form.glaze }}
                                {% if form.glaze.errors %}
                                    <div class="error">{{ form.glaze.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.freezing_category.id_for_label }}">Freezing Category</label>
                                {{ form.freezing_category }}
                                {% if form.freezing_category.errors %}
                                    <div class="error">{{ form.freezing_category.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.brand.id_for_label }}">Brand</label>
                                {{ form.brand }}
                                {% if form.brand.errors %}
                                    <div class="error">{{ form.brand.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.species.id_for_label }}">Species</label>
                                {{ form.species }}
                                {% if form.species.errors %}
                                    <div class="error">{{ form.species.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.peeling_type.id_for_label }}">Peeling Type</label>
                                {{ form.peeling_type }}
                                {% if form.peeling_type.errors %}
                                    <div class="error">{{ form.peeling_type.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.grade.id_for_label }}">Grade</label>
                                {{ form.grade }}
                                {% if form.grade.errors %}
                                    <div class="error">{{ form.grade.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.slab_quantity.id_for_label }}">Slab Quantity</label>
                                {{ form.slab_quantity }}
                                {% if form.slab_quantity.errors %}
                                    <div class="error">{{ form.slab_quantity.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column hidden">
                                <label for="{{ form.c_s_quantity.id_for_label }}">C/S Quantity</label>
                                {{ form.c_s_quantity }}
                                {% if form.c_s_quantity.errors %}
                                    <div class="error">{{ form.c_s_quantity.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column hidden">
                                <label for="{{ form.kg.id_for_label }}">Kg</label>
                                {{ form.kg }}
                                {% if form.kg.errors %}
                                    <div class="error">{{ form.kg.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.usd_rate_per_kg.id_for_label }}">USD Rate per Kg</label>
                                {{ form.usd_rate_per_kg }}
                                {% if form.usd_rate_per_kg.errors %}
                                    <div class="error">{{ form.usd_rate_per_kg.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column hidden">
                                <label for="{{ form.usd_rate_item.id_for_label }}">USD Rate Item</label>
                                {{ form.usd_rate_item }}
                                {% if form.usd_rate_item.errors %}
                                    <div class="error">{{ form.usd_rate_item.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column hidden">
                                <label for="{{ form.usd_rate_item_to_inr.id_for_label }}">USD Rate Item to INR</label>
                                {{ form.usd_rate_item_to_inr }}
                                {% if form.usd_rate_item_to_inr.errors %}
                                    <div class="error">{{ form.usd_rate_item_to_inr.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-column">
                                <label for="{{ form.yield_percentage.id_for_label }}">Yield Percentage</label>
                                {{ form.yield_percentage }}
                                {% if form.yield_percentage.errors %}
                                    <div class="error">{{ form.yield_percentage.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Delete checkbox for existing forms -->
                        {% if form.instance.pk %}
                            <label>
                                {{ form.DELETE }}
                                Delete this item
                            </label>
                        {% endif %}
                        
                        <button type="button" class="remove-btn">Remove</button>
                    </div>
                {% endfor %}
            </div>

            <button type="button" id="add-more-btn" class="button">+ Add More Item</button>
        </fieldset>

        <table class="total-table">
            <tr>
                <th>Total Yield Percentage</th>
                <td>
                    <input type="number" step="0.01" id="id_total_yield_percentage" name="total_yield_percentage" value="{{ freezing_entry.total_yield_percentage|floatformat:2 }}" readonly>
                </td>
                <th>Total USD</th>
                <td>
                    <input type="number" step="0.01" id="id_total_usd" name="total_usd" value="{{ freezing_entry.total_usd|floatformat:2 }}" readonly>
                </td>
                <th>Total INR</th>
                <td>
                    <input type="number" step="0.01" id="id_total_inr" name="total_inr" value="{{ freezing_entry.total_inr|floatformat:2 }}" readonly>
                </td>
                <th>Total Slab</th>
                <td>
                    <input type="number" step="0.01" id="id_total_slab" name="total_slab" value="{{ freezing_entry.total_slab|floatformat:2 }}" readonly>
                </td>
            </tr>
            <tr>
                <th>Total C/S</th>
                <td>
                    <input type="number" step="0.01" id="id_total_c_s" name="total_c_s" value="{{ freezing_entry.total_c_s|floatformat:2 }}" readonly>
                </td>
                <th>Total KG</th>
                <td>
                    <input type="number" step="0.01" id="id_total_kg" name="total_kg" value="{{ freezing_entry.total_kg|floatformat:2 }}" readonly>
                </td>
                <th>Freezing Status</th>
                <td>
                    {{ form.freezing_status }}
                </td>
                <td colspan="2"></td>
            </tr>
        </table>

        <br>
        <button type="submit" class="button">Update Entry</button>
    </form>

    <script>
        $(document).ready(function () {
            const formsetContainer = $('#formset-container');
            const totalForms = $('#id_form-TOTAL_FORMS');

            // Add CSS classes to existing forms for calculations
            $('.formset-form').each(function() {
                $(this).find('[name*="slab_quantity"]').addClass('slab-quantity');
                $(this).find('[name*="c_s_quantity"]').addClass('cs-quantity');
                $(this).find('[name*="kg"]:not([name*="usd_rate_per_kg"])').addClass('kg');
                $(this).find('[name*="usd_rate_per_kg"]').addClass('usd-rate-per-kg');
                $(this).find('[name*="usd_rate_item"]:not([name*="usd_rate_item_to_inr"])').addClass('usd-rate-item');
                $(this).find('[name*="usd_rate_item_to_inr"]').addClass('usd-rate-item-inr');
                $(this).find('[name*="unit"]').addClass('unit-select');
                $(this).find('[name*="item"]').addClass('item-select');
                $(this).find('[name*="species"]').addClass('species-select');
                $(this).find('[name*="peeling_type"]').addClass('peeling-select');
            });

            // Clone and Add More functionality
            $('#add-more-btn').click(function () {
                let formIndex = parseInt(totalForms.val());
                let lastForm = $('.formset-form:last');
                let newForm = lastForm.clone(true);

                // Fields to preserve from last form
                const fieldsToPreserve = [
                    'processing_center', 'store', 'shed', 'item', 'unit',
                    'glaze', 'freezing_category', 'brand', 'species', 'peeling_type'
                ];

                // Fields to reset
                const fieldsToReset = [
                    'grade', 'slab_quantity', 'c_s_quantity', 'kg', 
                    'usd_rate_per_kg', 'usd_rate_item', 'usd_rate_item_to_inr', 
                    'yield_percentage'
                ];

                // Preserve values
                let preservedValues = {};
                fieldsToPreserve.forEach(function(fieldName) {
                    let element = lastForm.find(`[name*="${fieldName}"]`);
                    if (element.length > 0) preservedValues[fieldName] = element.val();
                });

                // Update form attributes and reset values
                newForm.find(':input').each(function() {
                    let name = $(this).attr('name');
                    if (name) {
                        let oldFieldName = name.split('-').pop();
                        name = name.replace(/-\d+-/, `-${formIndex}-`);
                        let id = 'id_' + name;
                        $(this).attr({ name: name, id: id });

                        if (fieldsToPreserve.includes(oldFieldName) && preservedValues[oldFieldName] !== undefined) {
                            $(this).val(preservedValues[oldFieldName]);
                        } else if (fieldsToReset.includes(oldFieldName)) {
                            if ($(this).is('select')) {
                                $(this).prop('selectedIndex', 0);
                            } else {
                                $(this).val('');
                            }
                        }
                    }
                });

                // Reset DELETE and remove id field for new form
                newForm.find('input[name$="-DELETE"]').prop('checked', false);
                newForm.find('input[name$="-id"]').val('');

                // Add calculation classes
                newForm.find('[name*="slab_quantity"]').addClass('slab-quantity');
                newForm.find('[name*="c_s_quantity"]').addClass('cs-quantity');
                newForm.find('[name*="kg"]:not([name*="usd_rate_per_kg"])').addClass('kg');
                newForm.find('[name*="usd_rate_per_kg"]').addClass('usd-rate-per-kg');
                newForm.find('[name*="usd_rate_item"]:not([name*="usd_rate_item_to_inr"])').addClass('usd-rate-item');
                newForm.find('[name*="usd_rate_item_to_inr"]').addClass('usd-rate-item-inr');
                newForm.find('[name*="unit"]').addClass('unit-select');
                newForm.find('[name*="item"]').addClass('item-select');
                newForm.find('[name*="species"]').addClass('species-select');
                newForm.find('[name*="peeling_type"]').addClass('peeling-select');

                formsetContainer.append(newForm);
                totalForms.val(formIndex + 1);

                newForm.find('[name*="grade"]').focus();
            });

            // Remove form functionality
            $(document).on('click', '.remove-btn', function () {
                let form = $(this).closest('.formset-form');
                let deleteField = form.find('input[name$="-DELETE"]');
                
                if (deleteField.length > 0) {
                    // Mark for deletion instead of removing
                    deleteField.prop('checked', true);
                    form.hide();
                } else {
                    // Remove new forms completely
                    if ($('.formset-form:visible').length > 1) {
                        form.remove();
                        
                        // Re-number remaining forms
                        $('.formset-form').each(function(index) {
                            $(this).find('input, select, label').each(function() {
                                if ($(this).attr('name')) {
                                    let name = $(this).attr('name').replace(/-\d+-/, '-' + index + '-');
                                    $(this).attr('name', name);
                                    $(this).attr('id', 'id_' + name);
                                }
                                if ($(this).attr('for')) {
                                    let newFor = $(this).attr('for').replace(/-\d+-/, '-' + index + '-');
                                    $(this).attr('for', newFor);
                                }
                            });
                        });
                        
                        totalForms.val($('.formset-form').length);
                    }
                }
                
                calculateTotals();
            });
        });

        // Dollar rate and unit calculations
        let dollarRate = 0;

        $.getJSON("{% url 'adminapp:get_dollar_rate' %}", function (data) {
            if (data.dollar_rate_to_inr) {
                dollarRate = parseFloat(data.dollar_rate_to_inr);
            }
        });

        // Calculate row totals
        function recalcRow($row) {
            let slabQty = parseFloat($row.find('.slab-quantity').val()) || 0;
            let usdPerKg = parseFloat($row.find('.usd-rate-per-kg').val()) || 0;
            let precision = parseFloat($row.data('precision')) || 0;
            let factor = parseFloat($row.data('factor')) || 0;

            if (slabQty && precision) {
                $row.find('.cs-quantity').val((slabQty / precision).toFixed(2));
            } else if (!slabQty) {
                $row.find('.cs-quantity').val('');
            }

            if (slabQty && factor) {
                $row.find('.kg').val((slabQty * factor).toFixed(2));
            } else if (!slabQty) {
                $row.find('.kg').val('');
            }

            let kg = parseFloat($row.find('.kg').val()) || 0;
            if (kg && usdPerKg) {
                $row.find('.usd-rate-item').val((usdPerKg * kg).toFixed(2));
            } else {
                $row.find('.usd-rate-item').val('');
            }

            let usdItem = parseFloat($row.find('.usd-rate-item').val()) || 0;
            if (usdItem && dollarRate) {
                $row.find('.usd-rate-item-inr').val((usdItem * dollarRate).toFixed(2));
            } else {
                $row.find('.usd-rate-item-inr').val('');
            }
        }

        // Unit change handler
        $(document).on('change', '.unit-select', function () {
            let $row = $(this).closest('.formset-form');
            let unitId = $(this).val();

            if (!unitId) {
                $row.removeData('precision').removeData('factor');
                recalcRow($row);
                return;
            }

            $.getJSON("{% url 'adminapp:get_unit_details' %}", { unit_id: unitId }, function (data) {
                $row.data('precision', data.precision);
                $row.data('factor', data.factor);
                recalcRow($row);
            });
        });

        // Input change handlers
        $(document).on('input', '.slab-quantity, .usd-rate-per-kg', function () {
            let $row = $(this).closest('.formset-form');
            recalcRow($row);
        });

        // Total calculation
        function calculateTotals() {
            let totalYield = 0, totalUSD = 0, totalINR = 0, totalSlab = 0, totalCS = 0, totalKG = 0;

            $('.formset-form:visible').each(function () {
                // Skip deleted forms
                if ($(this).find('[name$="DELETE"]').is(':checked')) {
                    return;
                }

                const getVal = (name) => {
                    const val = parseFloat($(this).find(`[name$="${name}"]`).val());
                    return isNaN(val) ? 0 : val;
                };

                const yieldPercentage = getVal('yield_percentage');
                const usdRate = getVal('usd_rate_item');
                const inrRate = getVal('usd_rate_item_to_inr');
                const slabQty = getVal('slab_quantity');
                const csQty = getVal('c_s_quantity');
                const kgWeight = getVal('kg');

                if (yieldPercentage > 0) {
                    totalYield += yieldPercentage;
                }
                
                totalUSD += usdRate;
                totalINR += inrRate;
                totalSlab += slabQty;
                totalCS += csQty;
                totalKG += kgWeight;
            });

            // Update the total fields
            $('#id_total_yield_percentage').val(totalYield.toFixed(2));
            $('#id_total_usd').val(totalUSD.toFixed(2));
            $('#id_total_inr').val(totalINR.toFixed(2));
            $('#id_total_slab').val(totalSlab.toFixed(2));
            $('#id_total_c_s').val(totalCS.toFixed(2));
            $('#id_total_kg').val(totalKG.toFixed(2));
        }

        // Trigger calculation on any input change
        $(document).on('input change', '.formset-form :input', calculateTotals);
        $(document).on('change', '.formset-form [name$="DELETE"]', calculateTotals);

        // Populate spots based on date
        $('#id_spot_purchase_date').on('change', function () {
            const date = $(this).val();
            if (!date) return;

            $.get("{% url 'adminapp:get_spots_by_date' %}", { date: date }, function (data) {
                const spotSelect = $('#id_spot').empty().append('<option value="">---------</option>');
                data.spots.forEach(spot => {
                    spotSelect.append(`<option value="${spot.id}">${spot.spot__location_name} - ${spot.voucher_number}</option>`);
                });
            });
        });

        // Populate agent & supervisor based on spot
        $('#id_spot').on('change', function () {
            const spotId = $(this).val();
            if (!spotId) return;

            $.get("{% url 'adminapp:get_spot_details' %}", { spot_id: spotId }, function (data) {
                const agent = $('#id_spot_agent');
                const supervisor = $('#id_spot_supervisor');

                if (!agent.find(`option[value="${data.agent_id}"]`).length) {
                    agent.append(`<option value="${data.agent_id}">${data.agent_name}</option>`);
                }
                agent.val(data.agent_id);

                if (!supervisor.find(`option[value="${data.supervisor_id}"]`).length) {
                    supervisor.append(`<option value="${data.supervisor_id}">${data.supervisor_name}</option>`);
                }
                supervisor.val(data.supervisor_id);
            });
        });

        // Populate sheds and items based on date
        $('#id_spot_purchase_date').on('change', function () {
            const selectedDate = $(this).val();
            if (!selectedDate) return;

            $.get("{% url 'adminapp:get_sheds_by_date' %}", { date: selectedDate }, function (data) {
                const shedSet = new Set();
                const itemSet = new Set();

                data.sheds.forEach(supply => {
                    shedSet.add(`<option value="${supply.shed_id}">${supply.shed_name}</option>`);
                    itemSet.add(`<option value="${supply.item_id}">${supply.item_name}</option>`);
                });

                $('[name$="-shed"]').each(function () {
                    let currentValue = $(this).val();
                    $(this).empty().append('<option value="">---------</option>');
                    shedSet.forEach(opt => $(this).append(opt));
                    if (currentValue) $(this).val(currentValue);
                });

                $('[name$="-item"]').each(function () {
                    let currentValue = $(this).val();
                    $(this).empty().append('<option value="">---------</option>');
                    itemSet.forEach(opt => $(this).append(opt));
                    if (currentValue) $(this).val(currentValue);
                });
            }).fail(() => alert("Failed to load sheds/items for the selected date."));
        });

        // Yield percentage calculation
        $(document).on("input change", "input[name$='kg'], select[name$='shed']", function () {
            let row = $(this).closest(".formset-form");
            let kgField = row.find("input[name$='kg']");
            let yieldField = row.find("input[name$='yield_percentage']");
            let shedSelect = row.find("select[name$='shed']");
            let itemSelect = row.find("select[name$='item']");
            let kg = parseFloat(kgField.val()) || 0;
            let spotDate = $("#id_spot_purchase_date").val();

            if (shedSelect.val() && itemSelect.val() && spotDate) {
                $.ajax({
                    url: "{% url 'adminapp:get_sheds_by_date' %}",
                    data: { date: spotDate },
                    success: function (response) {
                        let sheds = response.sheds || [];
                        let selectedShed = shedSelect.val();
                        let selectedItem = itemSelect.val();

                        let found = sheds.find(s =>
                            s.shed_id == selectedShed && s.item_id == selectedItem
                        );

                        if (found) {
                            let qtyReceived = parseFloat(found.quantity_received_shed) || 0;
                            let yieldPercent = qtyReceived ? (kg / qtyReceived) * 100 : 0;
                            yieldField.val(yieldPercent.toFixed(2));
                        } else {
                            yieldField.val("");
                        }
                    }
                });
            }
        });

        // Load grades for species
        $(document).on("change", "select[name$='species']", function () {
            var speciesId = $(this).val();
            var $gradeSelect = $(this).closest(".formset-form").find("select[name$='grade']");

            if (speciesId) {
                $.ajax({
                    url: "{% url 'adminapp:get_grade_for_species' %}",
                    data: { "species_id": speciesId },
                    dataType: "json",
                    success: function (data) {
                        $gradeSelect.empty();
                        $gradeSelect.append($("<option>", { value: "", text: "---------" }));

                        $.each(data.grades, function (index, grade) {
                            $gradeSelect.append($("<option>", {
                                value: grade.id,
                                text: grade.grade
                            }));
                        });
                    }
                });
            } else {
                $gradeSelect.empty();
                $gradeSelect.append($("<option>", { value: "", text: "---------" }));
            }
        });

        // Load species and peeling types for items
        $(document).on("change", ".item-select", function () {
            let itemId = $(this).val();
            let row = $(this).closest(".formset-form");

            if (!itemId) return;

            // Fetch Species for this item
            $.ajax({
                url: "{% url 'adminapp:get_species_for_item' %}",
                data: { item_id: itemId },
                success: function (response) {
                    let speciesSelect = row.find(".species-select");
                    let currentValue = speciesSelect.val();
                    speciesSelect.empty().append('<option value="">---------</option>');
                    $.each(response.species, function (i, species) {
                        speciesSelect.append('<option value="' + species.id + '">' + species.name + '</option>');
                    });
                    if (currentValue) speciesSelect.val(currentValue);
                }
            });

            // Fetch Peeling Types for this item
            $.ajax({
                url: "{% url 'adminapp:get_peeling_for_item' %}",
                data: { item_id: itemId },
                success: function (response) {
                    let peelingSelect = row.find(".peeling-select");
                    let currentValue = peelingSelect.val();
                    peelingSelect.empty().append('<option value="">---------</option>');
                    $.each(response.peeling_types, function (i, peeling) {
                        peelingSelect.append('<option value="' + peeling.id + '">' + peeling.name + '</option>');
                    });
                    if (currentValue) peelingSelect.val(currentValue);
                }
            });
        });

        // Initialize calculations on page load
        $(document).ready(function() {
            calculateTotals();
            
            // Load unit details for existing forms
            $('.unit-select').each(function() {
                let $row = $(this).closest('.formset-form');
                let unitId = $(this).val();
                
                if (unitId) {
                    $.getJSON("{% url 'adminapp:get_unit_details' %}", { unit_id: unitId }, function (data) {
                        $row.data('precision', data.precision);
                        $row.data('factor', data.factor);
                    });
                }
            });
        });
    </script>

</body>
</html>