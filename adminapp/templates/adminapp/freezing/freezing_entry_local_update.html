{% extends 'admin_base.html' %}
{%block title%} Update Freezing Entry Local{%endblock%}
{% block content %}

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
                /* Dollar Rate Display Styling - Synced with Design */
#dollarRateDisplay {
    background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
    color: white;
    border-radius: 12px;
    padding: 12px 24px !important;
    font-size: 16px;
    font-weight: 600;
    letter-spacing: 0.3px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.25);
    transition: all 0.3s ease;
    text-align: center;
    min-width: 140px;
    margin: 0 !important;
    display: inline-block;
    border: none;
    margin-left: 2rem !important;
}

#dollarRateDisplay:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.35);
}

/* Adjust parent container alignment */
.card-header .d-flex.align-items-center.justify-content-between {
    align-items: center !important;
}

/* Mobile responsive */
@media (max-width: 768px) {
    #dollarRateDisplay {
        font-size: 14px;
        padding: 10px 20px !important;
        min-width: 120px;
    }
}
        /* Page Header Styles */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            /* margin-bottom: 3rem;
            padding: 20px 0; */
        }

        .page-header-left {
            flex: 1;
        }

        .page-header-right {
            margin-left: 20px;
            display: flex;
            align-items: flex-start;
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Header Buttons */
        .header-btn {
            display: inline-flex;
            align-items: center;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap;
            min-height: 44px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 
                0 4px 15px rgba(0,0,0,0.1),
                0 2px 4px rgba(0,0,0,0.06),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .header-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .header-btn:hover::before {
            left: 100%;
        }

        .header-btn i {
            margin-right: 10px;
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .header-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.15),
                0 4px 8px rgba(0,0,0,0.08),
                inset 0 1px 0 rgba(255,255,255,0.2);
            text-decoration: none;
        }

        .header-btn:hover i {
            transform: scale(1.1);
        }

        .header-btn:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 
                0 4px 15px rgba(0,0,0,0.2),
                0 2px 4px rgba(0,0,0,0.1),
                inset 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Button Color Variants */
        .btn-primary {
            background: #4A90E2;
            color: white;
            box-shadow: 
                0 4px 15px rgba(74, 144, 226, 0.3),
                0 2px 4px rgba(74, 144, 226, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.15);
        }

        .btn-primary:hover {
            background: #357ABD;
            color: white;
            box-shadow: 
                0 8px 25px rgba(74, 144, 226, 0.4),
                0 4px 8px rgba(74, 144, 226, 0.25),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .btn-secondary {
            background: #8E9AAF;
            color: white;
            box-shadow: 
                0 4px 15px rgba(142, 154, 175, 0.3),
                0 2px 4px rgba(142, 154, 175, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.15);
        }

        .btn-secondary:hover {
            background: #7A8599;
            color: white;
            box-shadow: 
                0 8px 25px rgba(142, 154, 175, 0.4),
                0 4px 8px rgba(142, 154, 175, 0.25),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .btn-info {
            background: #50C9CE;
            color: white;
            box-shadow: 
                0 4px 15px rgba(80, 201, 206, 0.3),
                0 2px 4px rgba(80, 201, 206, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.15);
        }

        .btn-info:hover {
            background: #3FB4B9;
            color: white;
            box-shadow: 
                0 8px 25px rgba(80, 201, 206, 0.4),
                0 4px 8px rgba(80, 201, 206, 0.25),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .btn-warning {
            background: #FFB84D;
            color: #ffffff;
            box-shadow: 
                0 4px 15px rgba(255, 184, 77, 0.3),
                0 2px 4px rgba(255, 184, 77, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .btn-warning:hover {
            background: #FF9F33;
            color: #ffffff;
            box-shadow: 
                0 8px 25px rgba(255, 184, 77, 0.4),
                0 4px 8px rgba(255, 184, 77, 0.25),
                inset 0 1px 0 rgba(255,255,255,0.25);
        }

        .btn-success {
            background: #58D68D;
            color: white;
            box-shadow: 
                0 4px 15px rgba(88, 214, 141, 0.3),
                0 2px 4px rgba(88, 214, 141, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.15);
        }

        .btn-success:hover {
            background: #45B576;
            color: white;
            box-shadow: 
                0 8px 25px rgba(88, 214, 141, 0.4),
                0 4px 8px rgba(88, 214, 141, 0.25),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        /* Base Styles */
        .freezing-entry-form {
            margin-top: -2rem;
        }

        /* Card Styling */
        .form-card {
            border-radius: 20px;
            background: #ffffff;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            border: none;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        /* Card Header */
        .card-header {
            background: linear-gradient(135deg, #f8f9fd 0%, #ffffff 100%);
            border-bottom: 2px solid #f1f3f7;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
        }

        .icon-wrapper {
            width: 60px;
            height: 60px;
            background: #007bff;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.2);
        }

        .card-title {
            font-size: 26px;
            color: #2c3e50;
            letter-spacing: -0.5px;
            margin-bottom: 0;
        }

        .card-header p {
            color: #6c757d;
            font-size: 14px;
            margin: 0;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 0;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Input Wrapper */
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            color: #6c757d;
            font-size: 14px;
            z-index: 2;
        }

        /* Form Controls Styling */
        .form-control, input, select, textarea {
            padding: 12px 15px 12px 45px !important;
            border: 2px solid #e9ecef !important;
            border-radius: 12px !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            background: #ffffff !important;
            transition: all 0.3s ease !important;
            width: 100% !important;
            box-sizing: border-box;
        }

        /* Special case for inputs without icons */
        .form-control.no-icon, input.no-icon, select.no-icon {
            padding-left: 15px !important;
        }

        .form-control:focus, input:focus, select:focus, textarea:focus {
            border-color: #007bff !important;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1) !important;
            outline: none !important;
        }

        /* Add Button */
        .add-btn {
            background: #007bff;
            color: white;
            border: 2px solid #007bff;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }

        .add-btn:hover {
            background: #0056b3;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
        }

        /* Table Styling */
        .modern-table {
            width: 100%;
            margin: 0;
            font-size: 14px;
            border-collapse: collapse;
        }

        .table-header {
            background:#007bff;
            border: none;
            padding: 17px !important;
            font-weight: 700 !important;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: row;
            text-align: center;
            white-space: nowrap;
        }

        .header-icon {
            color: #6c757d;
            margin-right: 6px;
            font-size: 12px;
            flex-shrink: 0;
            display: none;
        }

        /* Table Rows */
        .table-row {
            border: none;
            transition: all 0.3s ease;
        }

        .table-row:hover {
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.02) 0%, rgba(0, 123, 255, 0.05) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(123, 70, 70, 0.03);
        }

        /* Table cell adjustments */
        .table-cell {
            border: none;
            border-bottom: 1px solid #f1f3f7;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table-cell input, .table-cell select {
            width: 100% !important;
            min-width: 0 !important;
            padding: 8px 6px !important;
            margin: 0 !important;
            border: 2px solid #e9ecef !important;
            border-radius: 6px !important;
            font-size: 12px !important;
            box-sizing: border-box !important;
        }

        /* Action Buttons */
        .action-btn {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
            border: 2px solid;
            background: none;
            cursor: pointer;
        }

        .delete-btn, .remove-btn {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border-color: rgba(220, 53, 69, 0.2);
        }

        .delete-btn:hover, .remove-btn:hover {
            background: #dc3545;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .action-btn i {
    
            font-size: 17px;
        }

        /* Restore button variant */
        .remove-btn.restore {
            background: rgba(88, 214, 141, 0.1);
            color: #58D68D;
            border-color: rgba(88, 214, 141, 0.2);
        }

        .remove-btn.restore:hover {
            background: #58D68D;
            color: white;
            box-shadow: 0 4px 15px rgba(88, 214, 141, 0.3);
        }

                /* Form Actions */
        .form-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }

        .form-actions .row {
  width: 100%;
}


        .submit-btn {
            background: #007bff;
            color: white;
            border: 2px solid #007bff;
            padding: 15px 30px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            text-decoration: none;
            width: 100%;
        }

        .submit-btn:hover {
            background: #0056b3;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
        }

        .cancel-btn {
  background: #dc3545;
  color: white;
  border: 2px solid #dc3545;
  padding: 15px 30px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 16px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  width: 100%;
}

.cancel-btn:hover {
  background: #c82333;
  color: white;
  text-decoration: none;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
}

        /* Hidden class */
        .hidden {
            display: none;
        }

        /* Make calculated fields readonly */
        .calculated-field {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
        }

        /* Basic Entry Table */
        .basic-entry-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }

        .basic-entry-table th,
        .basic-entry-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f7;
        }

        .basic-entry-table th {
            background:#007bff;
            font-weight: 600;
            color: #ffffff;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        /* Responsive adjustments for smaller screens */
        @media (max-width: 1200px) {
            .header-content {
                flex-direction: column;
            }
            
            .header-icon {
                margin-right: 0;
                margin-bottom: 2px;
            }
            
            .table-header {
                font-size: 10px;
                padding: 12px 4px;
            }
            
            .table-cell input, .table-cell select {
                font-size: 11px !important;
                padding: 6px 4px !important;
            }
        }

        /* Items Container */
        .items-container {
            width: 100%;
            max-width: 100%;
            overflow-x: visible;
            overflow-y: visible;
            margin-bottom: 20px;
            border: 1px solid #f1f3f7;
            border-radius: 12px;
            box-sizing: border-box;
            /* padding: 10px; */
            
        }

        .items-table {
            width: 100%;
            min-width: 100%;
            table-layout: auto;
            border-collapse: collapse;
        }

                /* Make inputs and selects fit within their cells */
        .items-table .table-cell input,
        .items-table .table-cell select {
            margin-top: .5rem !important;
            width: 100% !important;
            box-sizing: border-box;
            font-size: 12px !important;
            padding: 8px 6px !important;
        }
        

        /* Column widths */
        .col-pr-centre { min-width: 90px;  max-width: 70px;}
        .col-store { min-width: 70px; max-width: 70px; }
        .col-shed { min-width: 70px; max-width: 70px;  }
        .col-item { min-width: 100px; max-width: 100px;    }
        .col-category { min-width: 120px; }
        .col-unit { min-width: 70px; max-width: 70px;  }
        .col-glaze { min-width: 50px; max-width: 50px;  }
        .col-fr-category { min-width: 110px; max-width: 110px;  }
        .col-brand { min-width: 70px; max-width: 70px;  }
        .col-species { min-width: 70px; max-width: 70px;  }
        .col-type { min-width: 70px; max-width: 70px;  }
        .col-grade { min-width: 70px; max-width: 70px; }
        .col-slab-qty { min-width: 70px; max-width: 70px; }
        .col-cs-qty { min-width: 70px; max-width: 70px; }
        .col-kg { min-width: 70px; max-width: 70px; }
        .col-usd-rate-kg { min-width: 70px; max-width: 70px;  }
        .col-usd-item { min-width: 70px; max-width: 70px;  }
        .col-usd-inr { min-width: 70px; max-width: 70px;  }
        .col-yield { min-width: 70px; max-width: 70px;  }
        .col-action { min-width: 70px; max-width: 70px;  }

        /* Totals Table */
        .totals-card {
            background: linear-gradient(135deg, #f8f9fd 0%, #ffffff 100%);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        .totals-title {
            color: #007bff;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .totals-title i {
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .totals-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .totals-table th,
        .totals-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #f1f3f7;
        }

        .totals-table th {
            background: #007bff;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .totals-table td {
            font-weight: 500;
            background: #f8f9fd;
        }

        .totals-table input {
            font-weight: 600;
            color: #007bff;
            text-align: center;
            background: #eef4ff !important;
            border: 2px solid #ccdfff !important;
            border-radius: 8px !important;
            padding: 10px 15px !important;
        }

        /* Row styling for deleted items */
        .formset-form.to-delete {
            background: #ffe6e6 !important;
            opacity: 0.7;
        }

        /* Responsive Design */
        @media (max-width: 991px) {
            .page-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .page-header-right {
                margin-left: 0;
                margin-top: 20px;
            }
            
            .header-actions {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .header-btn {
                width: 100%;
                justify-content: center;
                min-width: 200px;
            }

            .card-header .d-flex {
                flex-direction: column;
                align-items: stretch !important;
            }
            
            .card-header .d-flex:first-child {
                flex-direction: row !important;
                align-items: center !important;
                margin-bottom: 20px;
            }
            
            .add-btn {
                align-self: center;
                margin-top: 15px;
            }
            
            .icon-wrapper {
                width: 50px;
                height: 50px;
                font-size: 20px;
                margin-right: 15px;
            }
            
            .card-title {
                font-size: 20px;
            }
            
            .form-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .submit-btn, .cancel-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            .card-body {
                padding: 20px;
            }
            
            .card-header {
                padding: 20px;
            }
            
            .table-cell {
                padding: 10px;
            }
        }

        /* Utility classes */
        .d-flex { display: flex; }
        .align-items-center { align-items: center; }
        .justify-content-between { justify-content: space-between; }
        .mb-0 { margin-bottom: 0; }
        .me-4 { margin-right: 1.5rem; }
        .me-2 { margin-right: 0.5rem; }
        .text-center { text-align: center; }
        .text-muted { color: #6c757d; }
        .fw-semibold { font-weight: 600; }
        .mb-4 { margin-bottom: 1.5rem; }
    </style>

        <style>
        /* Mobile Responsive Styles for Freezing Entry Local */
@media (max-width: 768px) {
  /* Container and page structure */
  .container {
    padding: 10px;
  }
  
  .page-inner {
    padding: 10px;
  }
  
  /* Page Header - Mobile */
  .page-header {
    flex-direction: column;
    align-items: stretch;
    margin-bottom: 1.5rem;
    padding: 15px 0;
  }
  
  .page-header-left {
    margin-bottom: 15px;
  }
  
  .page-header h3 {
    font-size: 1.5rem !important;
  }
  
  .page-header-right {
    margin-left: 0;
    width: 100%;
  }
  
  /* Header Actions - Stack vertically */
  .header-actions {
    flex-direction: column;
    gap: 10px;
    width: 100%;
  }
  
  .header-btn {
    width: 100%;
    justify-content: center;
    padding: 10px 16px;
    font-size: 13px;
    min-height: 42px;
  }
  
  .header-btn i {
    font-size: 14px;
    margin-right: 8px;
  }
  
  /* Form Card */
  .form-card {
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }
  
  .card-header {
    padding: 15px !important;
  }
  
  .card-header .d-flex {
    flex-direction: column !important;
    align-items: flex-start !important;
  }
  
  .card-header .d-flex.justify-content-between {
    width: 100%;
  }
  
  .icon-wrapper {
    width: 45px !important;
    height: 45px !important;
    font-size: 18px !important;
    margin-right: 12px !important;
    margin-bottom: 0 !important;
  }
  
  .card-title {
    font-size: 18px !important;
  }
  
  .card-header p {
    font-size: 12px !important;
  }
  
  /* Add button mobile */
  .add-btn {
    width: 50%;
    margin-top: 12px;
    justify-content: center;
  }
  
  /* Basic Entry Table - Stack vertically */
  .basic-entry-table {
    display: block;
    width: 100%;
  }
  
  .basic-entry-table thead {
    display: none;
  }
  
  .basic-entry-table tbody,
  .basic-entry-table tr,
  .basic-entry-table td {
    display: block;
    width: 100%;
  }
  
  .basic-entry-table tr {
    margin-bottom: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    background: #f8f9fd;
  }
  
  .basic-entry-table td {
    border: none !important;
    padding: 10px 0 !important;
    position: relative;
    text-align: left;
  }
  
  .basic-entry-table td:before {
    content: attr(data-label);
    font-weight: 600;
    display: block;
    margin-bottom: 5px;
    color: #495057;
    font-size: 12px;
    text-transform: uppercase;
  }
  
  /* Items Container - Horizontal scroll */
  .items-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding: 15px 10px !important;
    border-radius: 8px;
  }
  
  .items-table {
    min-width: 1200px;
    table-layout: auto;
  }
  
  .items-table th,
  .items-table td {
    font-size: 11px !important;
    padding: 8px 6px !important;
  }
  
  .items-table .table-header {
    padding: 12px 8px !important;
    font-size: 10px !important;
  }
  
  .items-table .header-icon {
    font-size: 10px !important;
    margin-right: 4px !important;
  }
  
  /* Table cell inputs */
  .table-cell input,
  .table-cell select {
    font-size: 12px !important;
    padding: 8px 10px !important;
  }
  
  /* Action buttons in table */
  .action-btn {
    padding: 6px 10px !important;
    font-size: 11px !important;
  }
  
  .action-btn i {
    font-size: 11px !important;
    margin-right: 4px;
  }
  
  .action-btn span {
    display: none;
  }
  
  /* Totals Card - Mobile Responsive */
  .totals-card {
    padding: 15px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .totals-title {
    font-size: 1.25rem !important;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  
  .totals-title i {
    font-size: 1.25rem !important;
    margin-right: 10px;
  }
  
  /* Totals Table - Make it scrollable OR stack it */
  
  /* Option 1: Horizontal scroll (keeps table structure) */
  .totals-table {
    min-width: 600px;
    font-size: 11px;
  }
  
  .totals-table th,
  .totals-table td {
    padding: 10px 8px !important;
    font-size: 11px !important;
    white-space: nowrap;
  }
  
  .totals-table input {
    padding: 8px 10px !important;
    font-size: 12px !important;
    min-width: 80px;
  }
  
  /* Option 2: Stack totals vertically (uncomment if preferred) */
  /*
  .totals-table,
  .totals-table thead,
  .totals-table tbody,
  .totals-table tr,
  .totals-table th,
  .totals-table td {
    display: block;
    width: 100%;
  }
  
  .totals-table thead {
    display: none;
  }
  
  .totals-table tr {
    margin-bottom: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 10px;
    background: #f8f9fd;
  }
  
  .totals-table td {
    border: none !important;
    padding: 10px 0 !important;
    text-align: left !important;
    position: relative;
  }
  
  .totals-table td:before {
    content: attr(data-label);
    font-weight: 600;
    display: block;
    margin-bottom: 5px;
    color: #495057;
    font-size: 12px;
    text-transform: uppercase;
  }
  
  .totals-table input {
    width: 100% !important;
    text-align: left !important;
  }
  */
  
  /* Form Actions */
  .form-actions {
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
  }
  
  .submit-btn,
  .cancel-btn {
    width: 100%;
    justify-content: center;
    padding: 12px 20px !important;
    font-size: 14px !important;
  }
  
  /* Card body */
  .card-body {
    padding: 15px !important;
  }
}

@media (max-width: 480px) {
  /* Extra small devices */
  .page-header h3 {
    font-size: 1.25rem !important;
  }
  
  .card-title {
    font-size: 16px !important;
  }
  
  .icon-wrapper {
    width: 40px !important;
    height: 40px !important;
    font-size: 16px !important;
  }
  
  .header-btn {
    font-size: 12px;
    padding: 8px 12px;
  }
  
  .items-table th,
  .items-table td {
    font-size: 10px !important;
    padding: 6px 4px !important;
  }
  
  .totals-table th,
  .totals-table td {
    font-size: 10px !important;
    padding: 8px 6px !important;
  }
  
  .submit-btn,
  .cancel-btn {
    font-size: 13px !important;
  }
}

/* Add data labels for basic entry table on mobile */
@media (max-width: 768px) {
  .basic-entry-table tbody tr td:nth-child(1):before { content: "Freezing Date"; }
  .basic-entry-table tbody tr td:nth-child(2):before { content: "Local Purchase Date"; }
  .basic-entry-table tbody tr td:nth-child(3):before { content: "Voucher Number"; }
  .basic-entry-table tbody tr td:nth-child(4):before { content: "Party"; }
}

/* Add data labels for totals table on mobile (if using stacked version) */
@media (max-width: 768px) {
  /* Uncomment if using stacked totals table
  .totals-table tbody tr td:nth-child(1):before { content: "Total USD"; }
  .totals-table tbody tr td:nth-child(2):before { content: "Total INR"; }
  .totals-table tbody tr td:nth-child(3):before { content: "Total Slab"; }
  .totals-table tbody tr td:nth-child(4):before { content: "Total C/S"; }
  .totals-table tbody tr td:nth-child(5):before { content: "Total KG"; }
  .totals-table tbody tr td:nth-child(6):before { content: "Freezing Status"; }
  */
}

/* Horizontal scroll indicators */
@media (max-width: 768px) {
  .items-container:after {
    content: "← Scroll horizontally to see all columns →";
    display: block;
    text-align: center;
    color: #6c757d;
    font-size: 11px;
    padding: 10px;
    font-style: italic;
    background: #f8f9fd;
    border-top: 1px solid #e9ecef;
    margin-top: 10px;
  }
  
  .totals-card:after {
    content: "← Scroll to see all totals →";
    display: block;
    text-align: center;
    color: #6c757d;
    font-size: 11px;
    padding: 8px;
    font-style: italic;
    margin-top: 10px;
  }
  
  /* Improve scroll visibility */
  .items-container::-webkit-scrollbar,
  .totals-card::-webkit-scrollbar {
    height: 8px;
  }
  
  .items-container::-webkit-scrollbar-track,
  .totals-card::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  .items-container::-webkit-scrollbar-thumb,
  .totals-card::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
  }
  
  .items-container::-webkit-scrollbar-thumb:hover,
  .totals-card::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
}

/* Improved touch targets for mobile */
@media (max-width: 768px) {
  select, input, textarea, button {
    min-height: 44px;
  }
  
  .action-btn {
    min-height: 36px;
    min-width: 36px;
  }
}

/* Tablet adjustments */
@media (min-width: 769px) and (max-width: 1024px) {
  .header-actions {
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  
  .header-btn {
    flex: 0 1 calc(50% - 6px);
    min-width: 150px;
  }
  
  .items-table th,
  .items-table td {
    font-size: 12px !important;
    padding: 10px 8px !important;
  }
  
  .totals-table th,
  .totals-table td {
    font-size: 12px !important;
    padding: 12px 10px !important;
  }
}
    </style>

        <!-- Page header style -->
<style>
  /* ===== PAGE HEADER STYLES ONLY (Prefixed with ph-) ===== */
  :root {
    --ph-primary-color: #2563eb;
    --ph-primary-hover: #1d4ed8;
    --ph-secondary-color: #64748b;
    --ph-bg-secondary: #f8fafc;
    --ph-bg-tertiary: #f1f5f9;
    --ph-bg-accent: #e2e8f0;
    --ph-text-primary: #0f172a;
    --ph-text-secondary: #4a4a4a;
    --ph-text-light: #94a3b8;
    --ph-border-color: #e2e8f0;
    --ph-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --ph-radius-sm: 8px;
    --ph-radius-md: 12px;
    --ph-radius-lg: 16px;
    --ph-spacing-xs: 8px;
    --ph-spacing-sm: 12px;
    --ph-spacing-md: 16px;
    --ph-spacing-lg: 24px;
    --ph-spacing-xl: 32px;
    --ph-spacing-2xl: 48px;
  }

  /* Page Header Section */
  .page-header-section {
    margin-bottom: var(--ph-spacing-2xl);
  }

  .ph-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    /* Changed from flex-start to center */
    flex-wrap: wrap;
    gap: var(--ph-spacing-lg);
  }

  .ph-header-left {
    display: flex;
    align-items: center;
    gap: var(--ph-spacing-md);
    flex-shrink: 0;
  }

  .ph-icon-wrapper {
    width: 64px;
    height: 64px;
    background: var(--ph-primary-color);
    border-radius: var(--ph-radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    box-shadow: var(--ph-shadow-lg);
    flex-shrink: 0;
  }

  .ph-header-text {
    flex: 1;
  }

  .ph-header-title {
    font-weight: 500;
    font-size: 28px;
    color: #2c3e50;
    margin: 0 0 4px 0;
    letter-spacing: -0.02em;
  }

  .ph-header-subtitle {
    font-size: 16px;
    color: var(--ph-text-secondary);
    margin: 0;
    font-weight: 500;
  }

  .ph-header-stats {
    margin-left: auto;
  }

  .ph-stat-badge {
    display: flex;
    align-items: center;

    padding: var(--ph-spacing-sm) var(--ph-spacing-md);
    background: var(--ph-bg-tertiary);
    border: 2px solid var(--ph-border-color);
    border-radius: var(--ph-radius-md);
    font-weight: 600;
    color: var(--ph-text-secondary);
    font-size: 14px;
  }

  /* Breadcrumbs */
  .ph-breadcrumb-nav {
    margin-top: 3rem;
  }

  .ph-breadcrumb-list {
    display: flex;
    align-items: center;
    margin: 0;
    padding: 0;
    list-style: none;
    flex-wrap: wrap;

  }

  .ph-breadcrumb-item {
    display: flex;
    align-items: center;
  }

  .ph-breadcrumb-link {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--ph-bg-secondary);
    border-radius: var(--ph-radius-sm);
    text-decoration: none;
    color: var(--ph-text-secondary);
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }

  .ph-breadcrumb-link:hover {
    background: var(--ph-bg-accent);
    color: var(--ph-text-primary);
    border-color: var(--ph-border-color);
  }

  .ph-breadcrumb-item.active span {
    color: var(--ph-primary-color);
    font-weight: 600;
    padding: 6px 12px;
    background: rgba(37, 99, 235, 0.1);
    border-radius: var(--ph-radius-sm);
    font-size: 14px;
  }

  .ph-breadcrumb-separator {
    color: var(--ph-text-light);
    margin: 0 4px;
    font-size: 12px;
  }
  @media (max-width: 768px) { /* adjust breakpoint as needed */
  .ph-header-stats {
    display: none !important;
  }
  .ph-breadcrumb-nav {
    margin-top: 5px;
  }
  .ph-header-title {
    font-size: 1.7rem;
  }
}
</style>


    <div class="container">
        <div class="page-inner">
        <div class="page-header-section" style="margin-top: 1rem;">
            <div class="ph-header-content">
                <div class="ph-header-left">
                    <div class="ph-icon-wrapper">
                        <i class="fa-solid fa-snowflake"></i>
                    </div>
                    <div class="ph-header-text">
                        <h3 class="ph-header-title">Freezing Operations</h3>
                        <p class="ph-header-subtitle">Manage your freezing operations.</p>
                    </div>
                </div>

                <!-- Breadcrumbs - Now inline with header -->
                <nav class="ph-breadcrumb-nav">
                    <ol class="ph-breadcrumb-list">
                        <li class="ph-breadcrumb-item">
                            <a href="#" class="ph-breadcrumb-link">
                                <i class="icon-home"></i>
                                <span>Home</span>
                            </a>
                        </li>
                        <li class="ph-breadcrumb-separator">
                            <i class="icon-arrow-right"></i>
                        </li>
                        <li class="ph-breadcrumb-item ">
                            <a href="{%url 'adminapp:freezing_entry_local_list'%}" class="ph-breadcrumb-link">
                                <i class="fa-solid fa-snowflake"></i>
                                <span>Local Freezing Entries</span>
                            </a>
                        </li>
                        <li class="ph-breadcrumb-separator">
                            <i class="icon-arrow-right"></i>
                        </li>
                        <li class="ph-breadcrumb-item active">
                            <a href="">
                                <span>Edit</span>
                            </a>
                        </li>
                    </ol>
                </nav>
                <div class="ph-header-stats">

                </div>
            </div>
        </div>

            <form method="post" id="freezing-form" class="freezing-entry-form" style="margin-top: 2rem;">
                {% csrf_token %}

                <!-- Basic Details Card -->
                <div class="form-card">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <div class="icon-wrapper me-4">
                                <i class="fas fa-snowflake"></i>
                            </div>
                            <div>
                                <h3 class="card-title">Freezing Details</h3>
                                <p class="text-muted mb-0">Update basic freezing information</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <table class="basic-entry-table">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="header-content">
                                            <i class="fas fa-calendar-alt header-icon"></i>
                                            <span>Freezing Date</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-content">
                                            <i class="fas fa-calendar header-icon"></i>
                                            <span>Local Purchase Date</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-content">
                                            <i class="fas fa-hashtag header-icon"></i>
                                            <span>Voucher Number</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-content">
                                            <i class="fas fa-user header-icon"></i>
                                            <span>Party</span>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>{{ form.freezing_date }} {{ form.freezing_date.errors }}</td>
                                    <td>{{ form.local_purchase_date }} {{ form.local_purchase_date.errors }}</td>
                                    <td>{{ form.voucher_number }} {{ form.voucher_number.errors }}</td>
                                    <td>{{ form.party }} {{ form.party.errors }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Items Card -->
                <div class="form-card">
                    <div class="card-header">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="icon-wrapper me-4">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div>
                                    <h4 class="card-title mb-0">Items</h4>
                                    <p class="text-muted mb-0">Update items in your freezing entry</p>
                                </div>
                            </div>
                            <div>
                                <h4 class="card-title mb-0 p-4" id="dollarRateDisplay">
                                    $ (Loading...)
                                </h4>
                                <button type="button" id="add-more-btn" class="add-btn">
                                    <i class="fas fa-plus me-2"></i>Add Item
                                </button>
                            </div>
                        </div>
                    </div>

                    {{ formset.management_form }}

                    <div class="card-body" style="padding: 0;">
                        <div class="items-container">
                            <table class="modern-table items-table" id="formset-table">
                                <thead>
                                    <tr>
                                        <th class="table-header col-pr-centre">
                                            <div class="header-content">
                                                <i class="fas fa-industry header-icon"></i>
                                                <a href="{% url 'adminapp:processing_center_create' %}" target="_blank">
                                                <span>PR Centre</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-store">
                                            <div class="header-content">
                                                <i class="fas fa-store header-icon"></i>
                                                <a href="{% url 'adminapp:store_create' %}" target="_blank">
                                                <span>Store</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-item">
                                            <div class="header-content">
                                                <i class="fas fa-tag header-icon"></i>
                                                <a href="{% url 'adminapp:item_create' %}" target="_blank">
                                                <span>Item</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-quality">
                                            <div class="header-content">
                                                <i class="fas fa-star header-icon"></i>
                                                <a href="{% url 'adminapp:item_quality_create' %}" target="_blank">
                                                <span>Item Sub</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-unit">
                                            <div class="header-content">
                                                <i class="fas fa-ruler header-icon"></i>
                                                <a href="{% url 'adminapp:packing_unit_create' %}" target="_blank">
                                                <span>Unit</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-glaze">
                                            <div class="header-content">
                                                <i class="fas fa-sparkles header-icon"></i>
                                                <a href="{% url 'adminapp:glaze_percentage_create' %}" target="_blank">
                                                <span>Glaze</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-fr-category">
                                            <div class="header-content">
                                                <i class="fas fa-list header-icon"></i>
                                                <a href="{% url 'adminapp:freezing_category_create' %}" target="_blank">
                                                <span>FR Category</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-brand">
                                            <div class="header-content">
                                                <i class="fas fa-trademark header-icon"></i>
                                                <a href="{% url 'adminapp:item_brand_create' %}" target="_blank">
                                                <span>Brand</span>
                                            </div>
                                        </th>
                                        <!-- <th class="table-header col-species">
                                            <div class="header-content">
                                                <i class="fas fa-fish header-icon"></i>
                                                <a href="{% url 'adminapp:species_create' %}" target="_blank">
                                                <span>Species</span>
                                            </div>
                                        </th> -->
                                        <th class="table-header col-type">
                                            <div class="header-content">
                                                <i class="fas fa-layer-group header-icon"></i>
                                                <a href="{% url 'adminapp:item_type_create' %}" target="_blank">
                                                <span>Type</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-grade">
                                            <div class="header-content">
                                                <i class="fas fa-certificate header-icon"></i>
                                                <a href="{% url 'adminapp:item_grade_create' %}" target="_blank">
                                                <span>Grade</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-slab-qty">
                                            <div class="header-content">
                                                <i class="fas fa-layer-group header-icon"></i>
                                                <span>Slab Qty</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-usd-rate-kg">
                                            <div class="header-content">
                                                <i class="fas fa-dollar-sign header-icon"></i>
                                                <span>Price</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-action text-center">
                                            <div class="header-content justify-content-center">
                                                <i class="fas fa-tools header-icon"></i>
                                                <span>Action</span>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="formset-container">
                                    {% for form in formset %}
                                    <tr class="formset-form table-row">
                                        <td class="hidden-fields" style="display: none;">
                                            {% for hidden in form.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}
                                        </td>
                                        
                                        <td class="table-cell col-pr-centre">{{ form.processing_center }} {{ form.processing_center.errors }}</td>
                                        <td class="table-cell col-store">{{ form.store }} {{ form.store.errors }}</td>
                                        <td class="table-cell col-item">{{ form.item }} {{ form.item.errors }}</td>
                                        <td class="table-cell col-quality">{{ form.item_quality }} {{ form.item_quality.errors }}</td>
                                        <td class="table-cell col-unit">{{ form.unit }} {{ form.unit.errors }}</td>
                                        <td class="table-cell col-glaze">{{ form.glaze }} {{ form.glaze.errors }}</td>
                                        <td class="table-cell col-fr-category">{{ form.freezing_category }} {{ form.freezing_category.errors }}</td>
                                        <td class="table-cell col-brand">{{ form.brand }} {{ form.brand.errors }}</td>
                                        <!-- <td class="table-cell col-species">{{ form.species }} {{ form.species.errors }}</td> -->
                                        <td class="table-cell col-type">{{ form.peeling_type }} {{ form.peeling_type.errors }}</td>
                                        <td class="table-cell col-grade">{{ form.grade }} {{ form.grade.errors }}</td>
                                        <td class="table-cell col-slab-qty">{{ form.slab_quantity }} {{ form.slab_quantity.errors }}</td>
                                        <td class="hidden">{{ form.c_s_quantity }} {{ form.c_s_quantity.errors }}</td>
                                        <td class="hidden">{{ form.kg }} {{ form.kg.errors }}</td>
                                        <td class="table-cell col-usd-rate-kg">{{ form.usd_rate_per_kg }} {{ form.usd_rate_per_kg.errors }}</td>
                                        <td class="hidden">{{ form.usd_rate_item }} {{ form.usd_rate_item.errors }}</td>
                                        <td class="hidden">{{ form.usd_rate_item_to_inr }} {{ form.usd_rate_item_to_inr.errors }}</td>
                                        <td class="hidden">{{ form.DELETE }}</td>
                                        <td class="table-cell col-action text-center">
                                            <button type="button" class="action-btn delete-btn remove-btn mt-2">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Totals Card -->
                <div class="form-card">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <div class="icon-wrapper me-4">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div>
                                <h4 class="card-title mb-0">Freezing Entry Summary</h4>
                                <p class="text-muted mb-0">Overview of local freezing summary</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="totals-card">
                            <table class="totals-table">
                                <thead>
                                    <tr>
                                        <th>Total USD</th>
                                        <th>Total INR</th>
                                        <th>Total Slab</th>
                                        <th>Total C/S</th>
                                        <th>Total KG</th>
                                        <th>Freezing Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>{{ form.total_usd }} {{ form.total_usd.errors }}</td>
                                        <td>{{ form.total_inr }} {{ form.total_inr.errors }}</td>
                                        <td>{{ form.total_slab }} {{ form.total_slab.errors }}</td>
                                        <td>{{ form.total_c_s }} {{ form.total_c_s.errors }}</td>
                                        <td>{{ form.total_kg }} {{ form.total_kg.errors }}</td>
                                        <td style="width: 200px;">{{ form.freezing_status }} {{ form.freezing_status.errors }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Submit Section -->
                <div class="form-actions">
                    <div class="row">
                        <div class="col-lg-6 mb-3">
                            <button type="submit" class="submit-btn">
                                <i class="fas fa-save me-2"></i>Update
                            </button>
                        </div>
                        <div class="col-lg-6 mb-3">
                            <a href="{% url 'adminapp:freezing_entry_local_list' %}" class="cancel-btn">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Clone & Add More Formset -->
    <script>
        $(document).ready(function () {
            const formsetContainer = $('#formset-container');
            const totalForms = $('#id_form-TOTAL_FORMS');

            // Add CSS classes to existing forms
            function addCalculationClasses($form) {
                $form.find('[name*="item"]').addClass('item-select');
                $form.find('[name*="species"]').addClass('species-select');
                $form.find('[name*="peeling_type"]').addClass('peeling-select');
                $form.find('[name*="grade"]').addClass('grade-select');
                $form.find('[name*="slab_quantity"]').addClass('slab-quantity');
                $form.find('[name*="c_s_quantity"]').addClass('cs-quantity');
                $form.find('[name*="kg"]:not([name*="usd_rate_per_kg"])').addClass('kg');
                $form.find('[name*="usd_rate_per_kg"]').addClass('usd-rate-per-kg');
                $form.find('[name*="usd_rate_item"]:not([name*="usd_rate_item_to_inr"])').addClass('usd-rate-item');
                $form.find('[name*="usd_rate_item_to_inr"]').addClass('usd-rate-item-inr');
                $form.find('[name*="unit"]').addClass('unit-select');
                
                // Make calculated fields readonly and add styling
                $form.find('.usd-rate-item, .usd-rate-item-inr, .cs-quantity, .kg').addClass('calculated-field').prop('readonly', true);
            }

            // Add classes to initial forms
            $('.formset-form').each(function() {
                addCalculationClasses($(this));
            });

            $('#add-more-btn').click(function () {
                let formIndex = parseInt(totalForms.val());
                let lastForm = $('.formset-form:last');
                let newForm = lastForm.clone(false);

                // Fields to preserve from last form
                const fieldsToPreserve = [
                    'processing_center', 'store', 'item', 'unit','item_quality',
                    'glaze', 'freezing_category', 'brand'
                ];

                // Fields to reset completely
                const fieldsToCompletelyReset = [
                    'usd_rate_per_kg', 'usd_rate_item', 'usd_rate_item_to_inr'
                ];

                // Fields to reset normally
                const fieldsToReset = [
                    'species', 'peeling_type', 'grade', 'slab_quantity', 'c_s_quantity', 'kg'
                ];

                // Preserve values from the last form
                let preservedValues = {};
                fieldsToPreserve.forEach(function(fieldName){
                    let element = lastForm.find(`[name*="${fieldName}"]`);
                    if (element.length > 0) preservedValues[fieldName] = element.val();
                });

                // Update names, ids, reset values
                newForm.find(':input').each(function(){
                    let name = $(this).attr('name');
                    if(name){
                        let oldFieldName = name.split('-').pop();
                        name = name.replace(/-\d+-/, `-${formIndex}-`);
                        let id = 'id_'+name;
                        $(this).attr({name:name, id:id});

                        if(fieldsToPreserve.includes(oldFieldName) && preservedValues[oldFieldName] !== undefined){
                            $(this).val(preservedValues[oldFieldName]);
                        } else if(fieldsToReset.includes(oldFieldName)){
                            if($(this).is('select')) $(this).prop('selectedIndex', 0);
                            else $(this).val('');
                        } else if(fieldsToCompletelyReset.includes(oldFieldName)){
                            $(this).val('');
                        }
                    }
                });

                // Add calculation classes
                addCalculationClasses(newForm);

                // Reset DELETE field and remove ID for new forms
                newForm.find('input[name$="-DELETE"]').prop('checked', false);
                newForm.find('input[name$="-id"]').remove();
                newForm.removeClass('to-delete');

                // Update button text for new rows
                newForm.find('.remove-btn')
  .html('<i class="fas fa-trash-alt"></i>')
  .removeClass('restore');


                // Fetch unit details if needed
                let unitId = preservedValues['unit'];
                if (unitId) {
                    $.getJSON("{% url 'adminapp:get_unit_details_local' %}", { unit_id: unitId }, function (data) {
                        newForm.data('precision', data.precision);
                        newForm.data('factor', data.factor);
                    });
                }

                // Append new form
                formsetContainer.append(newForm);
                totalForms.val(formIndex + 1);

                // Force clear USD fields
                setTimeout(function() {
                    newForm.find('[name*="usd_rate_per_kg"]').val('');
                    newForm.find('[name*="usd_rate_item"]:not([name*="usd_rate_item_to_inr"])').val('');
                    newForm.find('[name*="usd_rate_item_to_inr"]').val('');
                }, 100);

                // Focus first blank field
                newForm.find('[name*="species"]').focus();

                console.log('New form cloned from last form, USD fields cleared');
            });
        });
    </script>

    <!-- Remove Form Script -->
    <script>
        $(document).ready(function () {
            const formsetContainer = $("#formset-container");
            const totalForms = $("#id_form-TOTAL_FORMS");

            // Remove/hide form functionality
            $(document).on("click", ".remove-btn", function () {
                const row = $(this).closest(".formset-form");
                const deleteCheckbox = row.find("input[type=checkbox][name$='-DELETE']");
                const hasIdField = row.find("input[name$='-id']").length > 0;
                
                if (hasIdField && deleteCheckbox.length > 0) {
                    // For existing records with DELETE checkbox
                    if (deleteCheckbox.prop("checked")) {
                        // Unmark for deletion
                        deleteCheckbox.prop("checked", false);
                        row.removeClass("to-delete");
                        $(this).text("Remove").removeClass("restore");
                        console.log('Unmarked form for deletion');
                    } else {
                        // Mark for deletion
                        deleteCheckbox.prop("checked", true);
                        row.addClass("to-delete");
                        $(this).html('<i class="fas fa-undo"></i><span>Restore</span>').addClass("restore");
                        console.log('Marked form for deletion');
                    }
                    
                    // Recalculate totals immediately
                    calculateTotals();
                } else {
                    // For new forms without ID field, remove completely
                    if ($(".formset-form").length > 1) {
                        row.remove();
                        
                        // Re-number forms
                        let forms = $(".formset-form");
                        totalForms.val(forms.length);
                        forms.each(function (index) {
                            $(this).find("input, select, label").each(function () {
                                if ($(this).attr("name")) {
                                    let name = $(this).attr("name").replace(/-\d+-/, "-" + index + "-");
                                    $(this).attr("name", name);
                                    $(this).attr("id", "id_" + name);
                                }
                                if ($(this).attr("for")) {
                                    let newFor = $(this).attr("for").replace(/-\d+-/, "-" + index + "-");
                                    $(this).attr("for", newFor);
                                }
                            });
                        });
                        
                        // Recalculate totals after removal
                        calculateTotals();
                    } else {
                        alert("At least one form is required.");
                    }
                }
            });

            // Handle form submission - show confirmation for deletions
            $("form").on("submit", function(e) {
                const deletedItems = $("input[name$='-DELETE']:checked").length;
                if (deletedItems > 0) {
                    const confirm = window.confirm(
                        `You are about to delete ${deletedItems} item(s). Are you sure you want to continue?`
                    );
                    if (!confirm) {
                        e.preventDefault();
                        return false;
                    }
                }
            });

            // Initialize existing DELETE checkboxes on page load
            $("input[name$='-DELETE']:checked").each(function() {
                const row = $(this).closest(".formset-form");
                row.addClass("to-delete");
                row.find(".remove-btn").html('<i class="fas fa-undo"></i><span>Restore</span>').addClass("restore");
            });

            // Delete key support
            $(document).on("keydown", function (e) {
                if (e.key === "Delete") {
                    let activeElement = $(document.activeElement).closest(".formset-form");
                    if (activeElement.length) {
                        e.preventDefault();
                        activeElement.find('.remove-btn').click();
                    }
                }
            });
        });
    </script>

    <!-- AJAX to get parties by date and party details -->
    <script>
        // Store party items globally for filtering
        let partyItems = [];

        $('#id_local_purchase_date').on('change', function () {
            const date = $(this).val();

            $('#id_party').empty().append('<option value="">---------</option>');
            $('#id_voucher_number').val('');
            partyItems = [];

            if (date) {
                $.get("{% url 'adminapp:get_parties_by_date' %}", { date: date }, function (data) {
                    const partySelect = $('#id_party');
                    data.parties.forEach(party => {
                        partySelect.append(`<option value="${party.id}">${party.party_name}</option>`);
                    });
                });
            }
        });
    </script>

    <!-- Load Item Qualities when Item changes -->
    <script>
        $(document).on("change", ".item-select:not(.quality-select)", function () {
            var itemId = $(this).val();
            var $qualitySelect = $(this).closest(".formset-form").find(".quality-select");

            if (itemId) {
                $.ajax({
                    url: "{% url 'adminapp:get_item_qualities' %}",
                    data: { "item_id": itemId },
                    dataType: "json",
                    success: function (data) {
                        $qualitySelect.empty();
                        $qualitySelect.append($("<option>", { value: "", text: "---------" }));

                        // Handle both array and object responses
                        var qualities = Array.isArray(data) ? data : data.qualities || [];

                        if (qualities.length === 0) {
                            $qualitySelect.append($("<option>", { value: "", text: "No qualities found" }));
                        } else {
                            $.each(qualities, function (index, quality) {
                                $qualitySelect.append($("<option>", {
                                    value: quality.id,
                                    text: quality.quality
                                }));
                            });
                        }

                        // Trigger change event to ensure form recognizes the new options
                        $qualitySelect.trigger('change');
                    },
                    error: function(xhr, status, error) {
                        console.log("Error loading qualities for item " + itemId);
                        console.log("Error details:", xhr.responseJSON);
                        
                        // Clear the select and add error option
                        $qualitySelect.empty();
                        $qualitySelect.append($("<option>", { value: "", text: "Error loading qualities" }));
                    }
                });
            } else {
                $qualitySelect.empty();
                $qualitySelect.append($("<option>", { value: "", text: "---------" }));
            }
        });
    </script>

    <!-- Unit calculation -->
    <script>
        $(document).ready(function () {
            let dollarRate = 0;

            // Fetch dollar rate on page load
            $.getJSON("{% url 'adminapp:get_dollar_rate_local' %}", function (data) {
                if (data.dollar_rate_to_inr) {
                    dollarRate = parseFloat(data.dollar_rate_to_inr);
                }
            });

            // Helper to recalc a single formset row
            function recalcRow($row) {
                let slabQty = parseFloat($row.find('.slab-quantity').val()) || 0;
                let usdPerKg = parseFloat($row.find('.usd-rate-per-kg').val()) || 0;
                let precision = parseFloat($row.data('precision')) || 0;
                let factor = parseFloat($row.data('factor')) || 0;

                // cs_quantity = slab / precision
                if (slabQty && precision) {
                    $row.find('.cs-quantity').val((slabQty / precision).toFixed(2));
                } else if (!slabQty) {
                    $row.find('.cs-quantity').val('');
                }

                // kg = slab × factor
                if (slabQty && factor) {
                    $row.find('.kg').val((slabQty * factor).toFixed(2));
                } else if (!slabQty) {
                    $row.find('.kg').val('');
                }

                // usd_rate_item = usd_per_kg × kg
                let kg = parseFloat($row.find('.kg').val()) || 0;
                if (kg && usdPerKg) {
                    $row.find('.usd-rate-item').val((usdPerKg * kg).toFixed(2));
                } else {
                    $row.find('.usd-rate-item').val('');
                }

                // usd_rate_item_to_inr = usd_rate_item × dollar_rate
                let usdItem = parseFloat($row.find('.usd-rate-item').val()) || 0;
                if (usdItem && dollarRate) {
                    $row.find('.usd-rate-item-inr').val((usdItem * dollarRate).toFixed(2));
                } else {
                    $row.find('.usd-rate-item-inr').val('');
                }

                // Trigger total calculation
                calculateTotals();
            }

            // When unit changes → fetch precision/factor and recalc
            $(document).on('change', '.unit-select', function () {
                let $row = $(this).closest('.formset-form');
                let unitId = $(this).val();

                if (!unitId) {
                    $row.removeData('precision').removeData('factor');
                    recalcRow($row);
                    return;
                }

                $.getJSON("{% url 'adminapp:get_unit_details_local' %}", { unit_id: unitId }, function (data) {
                    $row.data('precision', data.precision);
                    $row.data('factor', data.factor);
                    recalcRow($row);
                });
            });

            // Trigger recalculation on input changes
            $(document).on('input', '.slab-quantity, .usd-rate-per-kg', function () {
                let $row = $(this).closest('.formset-form');
                recalcRow($row);
            });

            // Initialize existing forms with unit data
            $('.formset-form').each(function() {
                const unitSelect = $(this).find('.unit-select');
                const unitId = unitSelect.val();
                if (unitId) {
                    const $row = $(this);
                    $.getJSON("{% url 'adminapp:get_unit_details_local' %}", { unit_id: unitId }, function (data) {
                        $row.data('precision', data.precision);
                        $row.data('factor', data.factor);
                    });
                }
            });
        });
    </script>

    <!-- Function to calculate totals -->
    <script>
        function calculateTotals() {
            let totalUSD = 0, totalINR = 0, totalSlab = 0, totalCS = 0, totalKG = 0;

            $('.formset-form').each(function () {
                // Skip deleted forms
                if ($(this).find('[name$="DELETE"]').is(':checked')) {
                    return;
                }

                const getVal = (name) => {
                    const val = parseFloat($(this).find(`[name$="${name}"]`).val());
                    return isNaN(val) ? 0 : val;
                };

                const usdRate = getVal('usd_rate_item');
                const inrRate = getVal('usd_rate_item_to_inr');
                const slabQty = getVal('slab_quantity');
                const csQty = getVal('c_s_quantity');
                const kgWeight = getVal('kg');

                totalUSD += usdRate;
                totalINR += inrRate;
                totalSlab += slabQty;
                totalCS += csQty;
                totalKG += kgWeight;
            });

            $('#id_total_usd').val(totalUSD.toFixed(2));
            $('#id_total_inr').val(totalINR.toFixed(2));
            $('#id_total_slab').val(totalSlab.toFixed(2));
            $('#id_total_c_s').val(totalCS.toFixed(2));
            $('#id_total_kg').val(totalKG.toFixed(2));
        }

        $(document).on('input change', '.formset-form :input', calculateTotals);
        $(document).on('change', '.formset-form [name$="DELETE"]', calculateTotals);
        $(document).ready(calculateTotals);
    </script>

    <!-- Load Grades when Species changes -->
    <script>
        $(document).on("change", ".species-select", function () {
            var speciesId = $(this).val();
            var $gradeSelect = $(this).closest(".formset-form").find(".grade-select");

            if (speciesId) {
                $.ajax({
                    url: "{% url 'adminapp:get_grade_for_species' %}",
                    data: { "species_id": speciesId },
                    dataType: "json",
                    success: function (data) {
                        $gradeSelect.empty();
                        $gradeSelect.append($("<option>", { value: "", text: "---------" }));

                        $.each(data.grades, function (index, grade) {
                            $gradeSelect.append($("<option>", {
                                value: grade.id,
                                text: grade.grade
                            }));
                        });
                    },
                    error: function() {
                        console.log("Error loading grades for species " + speciesId);
                    }
                });
            } else {
                $gradeSelect.empty();
                $gradeSelect.append($("<option>", { value: "", text: "---------" }));
            }
        });
    </script>

    <!-- Load Grades when item changes -->
    <script>
    $(document).ready(function () {
        console.log("Item → Grade script loaded");

        // When an item select changes
        $(document).on("change", 'select[name$="-item"], select[name="item"]', function () {
            const itemSelect = $(this);
            const itemId = itemSelect.val();
            const row = itemSelect.closest("tr");
            const gradeSelect = row.find("select[name$='-grade'], select[name='grade']");

            console.log("Item changed. Item ID:", itemId);

            // Reset grade dropdown
            gradeSelect.empty().append('<option value="">---------</option>');

            if (itemId) {
                console.log("Fetching grades for item:", itemId);

                $.get("{% url 'adminapp:get_item_grades' %}", { item_id: itemId })
                    .done(function (data) {
                        console.log("Grades received:", data);

                        // Handle both array and object response types
                        const grades = Array.isArray(data) ? data : data.grades || [];

                        if (grades.length > 0) {
                            grades.forEach(function (grade) {
                                gradeSelect.append(
                                    `<option value="${grade.id}">${grade.grade}</option>`
                                );
                            });
                            console.log(`Loaded ${grades.length} grades`);
                        } else {
                            console.log("No grades found for this item");
                        }
                    })
                    .fail(function (xhr, status, error) {
                        console.error("Error loading grades:", {
                            status: status,
                            error: error,
                            response: xhr.responseText,
                        });
                        gradeSelect.append('<option value="">Error loading grades</option>');
                    });
            } else {
                console.log("No item selected, grade dropdown reset");
            }
        });
    });
    </script>

    <!-- Load peeling and Species -->
    <script>
        $(document).ready(function () {
            console.log("Freezing Entry Local AJAX ready");

            $(document).on("change", "select[name$='-item']", function () {
                let itemId = $(this).val();
                let row = $(this).closest(".formset-form");

                if (!itemId) return;

                $.ajax({
                    url: "{% url 'adminapp:get_species_for_item' %}",
                    data: { item_id: itemId },
                    success: function (response) {
                        let speciesSelect = row.find("select[name$='-species']");
                        speciesSelect.empty().append('<option value="">---------</option>');
                        $.each(response.species, function (i, species) {
                            speciesSelect.append('<option value="' + species.id + '">' + species.name + '</option>');
                        });
                    }
                });

                $.ajax({
                    url: "{% url 'adminapp:get_peeling_for_item' %}",
                    data: { item_id: itemId },
                    success: function (response) {
                        let peelingSelect = row.find("select[name$='-peeling_type']");
                        peelingSelect.empty().append('<option value="">---------</option>');
                        $.each(response.peeling_types, function (i, peeling) {
                            peelingSelect.append('<option value="' + peeling.id + '">' + peeling.name + '</option>');
                        });
                    }
                });
            });
        });
    </script>

    <!-- F1 key shortcut for adding more items -->
    <script>
        $(document).ready(function() {
            $(document).on('keydown', function(e) {
                // Check if F1 key is pressed (keyCode 112)
                if (e.keyCode === 112 || e.which === 112) {
                    e.preventDefault(); // Prevent browser's default F1 help
                    $('#add-more-btn').click(); // Trigger the add more button
                    return false;
                }
            });
        });
    </script>

<!-- Arrow key navigation for form fields -->
    <script>
        $(document).ready(function() {
            function getFocusableElements() {
                return $('input:not([type="hidden"]), select, textarea').filter(':visible');
            }

            $(document).on('keydown', 'input, select, textarea', function(e) {
                if (e.keyCode === 37 || e.which === 37) {
                    if ($(this).is('select') || 
                        ($(this).is('input') && this.selectionStart === 0)) {
                        
                        e.preventDefault();
                        let focusableElements = getFocusableElements();
                        let currentIndex = focusableElements.index(this);
                        
                        if (currentIndex > 0) {
                            focusableElements.eq(currentIndex - 1).focus();
                        }
                        return false;
                    }
                }
                
                if (e.keyCode === 39 || e.which === 39) {
                    if ($(this).is('select') || 
                        ($(this).is('input') && this.selectionStart === this.value.length)) {
                        
                        e.preventDefault();
                        let focusableElements = getFocusableElements();
                        let currentIndex = focusableElements.index(this);
                        
                        if (currentIndex < focusableElements.length - 1) {
                            focusableElements.eq(currentIndex + 1).focus();
                        }
                        return false;
                    }
                }
            });
        });
    </script>


    <!-- Arrow key navigation for form fields -->
    <script>
        $(document).ready(function() {
            // Get all focusable form elements
            function getFocusableElements() {
                return $('input:not([type="hidden"]), select, textarea').filter(':visible');
            }

            // Check if input type should navigate on arrow keys
            function shouldNavigate(element, direction) {
                const $elem = $(element);
                const inputType = $elem.attr('type');
                
                // Always navigate for select, date, and number inputs
                if ($elem.is('select') || inputType === 'date' || inputType === 'number') {
                    return true;
                }
                
                // For text inputs, check cursor position
                if ($elem.is('input') && inputType === 'text') {
                    try {
                        const cursorPos = element.selectionStart;
                        const valueLength = element.value.length;
                        
                        // Left arrow: navigate if cursor at beginning
                        if (direction === 'left' && cursorPos === 0) {
                            return true;
                        }
                        
                        // Right arrow: navigate if cursor at end
                        if (direction === 'right' && cursorPos === valueLength) {
                            return true;
                        }
                    } catch(e) {
                        // If selectionStart fails, just navigate
                        return true;
                    }
                }
                
                // For textarea, don't navigate (allow normal arrow key behavior)
                if ($elem.is('textarea')) {
                    return false;
                }
                
                return false;
            }

            $(document).on('keydown', 'input, select, textarea', function(e) {
                // Left arrow key (keyCode 37)
                if (e.keyCode === 37 || e.which === 37) {
                    if (shouldNavigate(this, 'left')) {
                        e.preventDefault();
                        let focusableElements = getFocusableElements();
                        let currentIndex = focusableElements.index(this);
                        
                        // Move to previous field
                        if (currentIndex > 0) {
                            focusableElements.eq(currentIndex - 1).focus().select();
                        }
                        return false;
                    }
                }
                
                // Right arrow key (keyCode 39)
                if (e.keyCode === 39 || e.which === 39) {
                    if (shouldNavigate(this, 'right')) {
                        e.preventDefault();
                        let focusableElements = getFocusableElements();
                        let currentIndex = focusableElements.index(this);
                        
                        // Move to next field
                        if (currentIndex < focusableElements.length - 1) {
                            focusableElements.eq(currentIndex + 1).focus().select();
                        }
                        return false;
                    }
                }
            });
        });
    </script>

<!-- Limit date input year to 4 digits -->
<script>
$(document).ready(function() {
    $(document).on('input','input[type="date"]',function(){
        let d=$(this).val();
        // Only check if we have at least the year part (first 4 characters)
        if(d && d.length>=4){
            let y=parseInt(d.substring(0,4));
            // Only validate if year has 4 digits AND is complete
            if(d.length>=4 && y.toString().length===4){
                if(y<1900||y>2100){
                    // Clear only the year part, allow user to re-enter
                    $(this).val('');
                }
            }
        }
    });
    
    // Final validation on blur
    $(document).on('blur','input[type="date"]',function(){
        let d=$(this).val();
        if(d && d.length===10){
            let y=parseInt(d.split('-')[0]);
            if(y<1900||y>2100){
                alert('Please enter a valid year (1900-2100)');
                $(this).val('');
            }
        }
    });
});
</script>



<!-- Add this script at the bottom of your template before </body> -->
<script>
    // Fetch dollar rate on page load
    async function fetchDollarRate() {
        try {
            const response = await fetch("{% url 'adminapp:get_dollar_rate_local' %}");
            const data = await response.json();
            
            if (data.dollar_rate_to_inr) {
                document.getElementById('dollarRateDisplay').textContent = 
                    `$1 = ₹${parseFloat(data.dollar_rate_to_inr).toFixed(2)}`;
            } else if (data.error) {
                document.getElementById('dollarRateDisplay').textContent = '$ (Rate not set)';
            }
        } catch (error) {
            console.error('Error fetching dollar rate:', error);
            document.getElementById('dollarRateDisplay').textContent = '$ (Rate not set)';
        }
    }
    
    // Call on page load
    document.addEventListener('DOMContentLoaded', fetchDollarRate);
</script>

{%endblock%}