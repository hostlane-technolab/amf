
{% extends 'admin_base.html' %}
{%block title%} Freezing Entry Spot{%endblock%}
{% block content %}

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        .link-hover:hover{
            color: rgb(254, 248, 248);
        }
        /* Page Header Styles */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 3rem;
            padding: 20px 0;
        }

        .page-header-left {
            flex: 1;
        }

        .page-header-right {
            margin-left: 20px;
            display: flex;
            align-items: flex-start;
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Header Buttons */
        .header-btn {
            display: inline-flex;
            align-items: center;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap;
            min-height: 44px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 
                0 4px 15px rgba(0,0,0,0.1),
                0 2px 4px rgba(0,0,0,0.06),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .header-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .header-btn:hover::before {
            left: 100%;
        }

        .header-btn i {
            margin-right: 10px;
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .header-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.15),
                0 4px 8px rgba(0,0,0,0.08),
                inset 0 1px 0 rgba(255,255,255,0.2);
            text-decoration: none;
        }

        .header-btn:hover i {
            transform: scale(1.1);
        }

        .header-btn:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 
                0 4px 15px rgba(0,0,0,0.2),
                0 2px 4px rgba(0,0,0,0.1),
                inset 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Button Color Variants */
        .btn-primary {
            background: #4A90E2;
            color: white;
            box-shadow: 
                0 4px 15px rgba(74, 144, 226, 0.3),
                0 2px 4px rgba(74, 144, 226, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.15);
        }

        .btn-primary:hover {
            background: #357ABD;
            color: white;
            box-shadow: 
                0 8px 25px rgba(74, 144, 226, 0.4),
                0 4px 8px rgba(74, 144, 226, 0.25),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .btn-secondary {
            background: #8E9AAF;
            color: white;
            box-shadow: 
                0 4px 15px rgba(142, 154, 175, 0.3),
                0 2px 4px rgba(142, 154, 175, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.15);
        }

        .btn-secondary:hover {
            background: #7A8599;
            color: white;
            box-shadow: 
                0 8px 25px rgba(142, 154, 175, 0.4),
                0 4px 8px rgba(142, 154, 175, 0.25),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .btn-info {
            background: #50C9CE;
            color: white;
            box-shadow: 
                0 4px 15px rgba(80, 201, 206, 0.3),
                0 2px 4px rgba(80, 201, 206, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.15);
        }

        .btn-info:hover {
            background: #3FB4B9;
            color: white;
            box-shadow: 
                0 8px 25px rgba(80, 201, 206, 0.4),
                0 4px 8px rgba(80, 201, 206, 0.25),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .btn-warning {
            background: #FFB84D;
            color: #ffffff;
            box-shadow: 
                0 4px 15px rgba(255, 184, 77, 0.3),
                0 2px 4px rgba(255, 184, 77, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .btn-warning:hover {
            background: #FF9F33;
            color: #ffffff;
            box-shadow: 
                0 8px 25px rgba(255, 184, 77, 0.4),
                0 4px 8px rgba(255, 184, 77, 0.25),
                inset 0 1px 0 rgba(255,255,255,0.25);
        }

        .btn-success {
            background: #58D68D;
            color: white;
            box-shadow: 
                0 4px 15px rgba(88, 214, 141, 0.3),
                0 2px 4px rgba(88, 214, 141, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.15);
        }

        .btn-success:hover {
            background: #45B576;
            color: white;
            box-shadow: 
                0 8px 25px rgba(88, 214, 141, 0.4),
                0 4px 8px rgba(88, 214, 141, 0.25),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }

        /* Breadcrumbs */
        .breadcrumbs {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .breadcrumbs li {
            display: flex;
            align-items: center;
            color: #6c757d;
            font-size: 14px;
        }

        .breadcrumbs a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        .breadcrumbs a:hover {
            text-decoration: underline;
        }

        .breadcrumbs .separator {
            margin: 0 10px;
            color: #dee2e6;
        }

        .breadcrumbs .nav-home a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: #f8f9fa;
            border-radius: 6px;
            color: #6c757d;
        }

        .breadcrumbs .nav-home a:hover {
            background: #e9ecef;
            text-decoration: none;
        }

        /* Page Title */
        .fw-bold {
            font-weight: 700 !important;
        }

        .mb-4 {
            margin-bottom: 1.5rem !important;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        /* Responsive Header */
        @media (max-width: 991px) {
            .page-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .page-header-right {
                margin-left: 0;
                margin-top: 20px;
            }
            
            .header-actions {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .header-btn {
                width: 100%;
                justify-content: center;
                min-width: 200px;
            }
        }

        @media (max-width: 576px) {
            .breadcrumbs {
                font-size: 12px;
            }
            
            .breadcrumbs .separator {
                margin: 0 6px;
            }
            
            .header-btn {
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .header-btn i {
                font-size: 12px;
                margin-right: 6px;
            }
        }

        /* Base Styles */
        .freezing-entry-form {
            margin-top: 2rem;
        }

        /* Card Styling */
        .form-card {
            border-radius: 20px;
            background: #ffffff;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            border: none;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        /* Card Header */
        .card-header {
            background: linear-gradient(135deg, #f8f9fd 0%, #ffffff 100%);
            border-bottom: 2px solid #f1f3f7;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
        }

        .icon-wrapper {
            width: 60px;
            height: 60px;
            background: #007bff;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.2);
        }

        .card-title {
            font-size: 26px;
            color: #2c3e50;
            letter-spacing: -0.5px;
            margin-bottom: 0;
        }

        .card-header p {
            color: #6c757d;
            font-size: 14px;
            margin: 0;
        }

        /* Card Body */
        .card-body {
            padding: 30px;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 0;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Input Wrapper */
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            color: #6c757d;
            font-size: 14px;
            z-index: 2;
        }

        /* Form Controls Styling */
        .form-control, input, select, textarea {
            padding: 12px 15px 12px 45px !important;
            border: 2px solid #e9ecef !important;
            /* border-radius: 12px !important; */
            font-size: 14px !important;
            font-weight: 500 !important;
            background: #ffffff !important;
            transition: all 0.3s ease !important;
            width: 100% !important;
            box-sizing: border-box;
        }

        /* Special case for inputs without icons */
        .form-control.no-icon, input.no-icon, select.no-icon {
            padding-left: 15px !important;
        }

        .form-control:focus, input:focus, select:focus, textarea:focus {
            border-color: #007bff !important;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1) !important;
            outline: none !important;
        }

        /* Add Button */
        .add-btn {
            background: #007bff;
            color: white;
            border: 2px solid #007bff;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }

        .add-btn:hover {
            background: #0056b3;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
        }

        /* Table Styling */
        .modern-table {
            width: 100%;
            margin: 0;
            font-size: 14px;
            border-collapse: collapse;
        }

        .table-header {
            background:#007bff;
            border: none;
            padding: 12px 15px;
            font-weight: 700 !important;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 18px;
        }

        .header-content {
            display: flex;
            align-items: center;
        }

        .header-icon {
            color: white;
            margin-right: 10px;
            font-size: 14px;
            display: none;
        }
        .header-text{
            font-size: 12px !important;
            white-space: nowrap;
        }

        /* Table Rows */
        .table-row {
            border: none;
            transition: all 0.3s ease;
            
            
        }

        .table-row:hover {
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.02) 0%, rgba(0, 123, 255, 0.05) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }



        /* Action Buttons */
        .action-btn {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
            border: 2px solid;
            background: none;
            cursor: pointer;
        }

        .delete-btn, .remove-btn {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border-color: rgba(220, 53, 69, 0.2);
        }

        .delete-btn:hover, .remove-btn:hover {
            background: #dc3545;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .action-btn i {
            /* margin-right: 6px; */
            font-size: 17px;
        }

        
        /* Form Actions */
.form-actions {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 40px;
}

.form-actions .row {
  width: 100%;
}

.submit-btn {
  background: #007bff;
  color: white;
  border: 2px solid #007bff;
  padding: 15px 30px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 16px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  text-decoration: none;
  width: 100%;
}

.submit-btn:hover {
            background: #0056b3;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
}

.cancel-btn {
  background: #dc3545;
  color: white;
  border: 2px solid #dc3545;
  padding: 15px 30px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 16px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  width: 100%;
}

.cancel-btn:hover {
  background: #c82333;
  color: white;
  text-decoration: none;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
}


        /* Validation Errors */
        .validation-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            font-weight: 500;
        }

        /* Hidden class */
        .hidden {
            display: none;
        }

        /* Basic Entry Table */
        .basic-entry-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }

        .basic-entry-table th,
        .basic-entry-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f7;
        }

        .basic-entry-table th {
            background:#007bff;
            font-weight: 600;
            color: #ffffff;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .basic-entry-table input,
        .basic-entry-table select {
            padding-left: 15px !important;
        }

        /* Items Container */
        .items-container {
            width: 100%;
            max-width: 100%;
            overflow-x: visible;
            overflow-y: visible;
            margin-bottom: 20px;
            border: 1px solid #f1f3f7;
            border-radius: 12px;
            box-sizing: border-box;
            /* padding: 10px; */
            
        }

        .items-table {
            width: 100%;
            table-layout: auto;
            border-collapse: collapse;
        }

      
        
        /* Make inputs and selects fit within their cells */
        .items-table .table-cell input,
        .items-table .table-cell select {
            margin-top: .5rem;
            width: 100% !important;
            box-sizing: border-box;
            font-size: 12px !important;
            padding: 8px 6px !important;
        }
        

        .items-table .header-content {
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .items-table .table-header {
            white-space: nowrap;
        }
        
        /* Smaller header text for better fit */
        .items-table .header-text {
            font-size: 10px;
        }
        
        .items-table .header-icon {
            font-size: 11px;
            margin-right: 4px;
        }

        /* Column widths */
        .col-pr-centre { min-width: 90px;  max-width: 70px;}
        .col-store { min-width: 70px; max-width: 70px; }
        .col-shed { min-width: 70px; max-width: 70px;  }
        .col-item { min-width: 100px; max-width: 100px;    }
        .col-category { min-width: 120px; }
        .col-unit { min-width: 70px; max-width: 70px;  }
        .col-glaze { min-width: 50px; max-width: 50px;  }
        .col-fr-category { min-width: 110px; max-width: 110px;  }
        .col-brand { min-width: 90px; max-width: 90px;  }
        .col-species { min-width: 70px; max-width: 70px;  }
        .col-type { min-width: 70px; max-width: 70px;  }
        .col-grade { min-width: 100px; max-width: 100px; }
        .col-slab-qty { min-width: 70px; max-width: 70px; }
        .col-cs-qty { min-width: 70px; max-width: 70px; }
        .col-kg { min-width: 70px; max-width: 70px; }
        .col-usd-rate-kg { min-width: 70px; max-width: 70px;  }
        .col-usd-item { min-width: 70px; max-width: 70px;  }
        .col-usd-inr { min-width: 70px; max-width: 70px;  }
        .col-yield { min-width: 70px; max-width: 70px;  }
        .col-action { min-width: 70px; max-width: 70px;  }

        /* Page Title */
        .page-title {
            font-size: 2rem;
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 2rem;
            letter-spacing: -0.5px;
        }

        /* Totals Table */
        .totals-card {
            background: linear-gradient(135deg, #f8f9fd 0%, #ffffff 100%);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        .totals-title {
            color: #007bff;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .totals-title i {
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .totals-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .totals-table th,
        .totals-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #f1f3f7;
        }

        .totals-table th {
            background: #007bff;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .totals-table td {
            font-weight: 500;
            background: #f8f9fd;
        }

        .totals-table input {
            font-weight: 600;
            color: #007bff;
            text-align: center;
            background: #eef4ff;
            border: 2px solid #ccdfff !important;
            border-radius: 8px !important;
            padding: 10px 15px !important;
            padding-left: 15px !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .card-header .d-flex {
                flex-direction: column;
                align-items: stretch !important;
            }
            
            .card-header .d-flex:first-child {
                flex-direction: row !important;
                align-items: center !important;
                margin-bottom: 20px;
            }
            
            .add-btn {
                align-self: center;
                margin-top: 15px;
            }
            
            .icon-wrapper {
                width: 50px;
                height: 50px;
                font-size: 20px;
                margin-right: 15px;
            }
            
            .card-title {
                font-size: 20px;
            }
            
            .form-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .submit-btn, .cancel-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            .card-body {
                padding: 20px;
            }
            
            .card-header {
                padding: 20px;
            }
            
            .table-cell {
                padding: 10px;
            }
        }

        /* Flexbox grid system */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: -0.75rem;
        }

        .col-md-6 { flex: 0 0 50%; max-width: 50%; padding: 0.75rem; }
        .col-lg-2 { flex: 0 0 16.666667%; max-width: 16.666667%; padding: 0.75rem; }
        .col-lg-3 { flex: 0 0 25%; max-width: 25%; padding: 0.75rem; }
        .col-lg-4 { flex: 0 0 33.333333%; max-width: 33.333333%; padding: 0.75rem; }

        @media (max-width: 991.98px) {
            .col-lg-2, .col-lg-3, .col-lg-4 { flex: 0 0 50%; max-width: 50%; }
        }

        @media (max-width: 767.98px) {
            .col-md-6, .col-lg-2, .col-lg-3, .col-lg-4 { flex: 0 0 100%; max-width: 100%; }
        }

        /* Utility classes */
        .d-flex { display: flex; }
        .align-items-center { align-items: center; }
        .justify-content-between { justify-content: space-between; }
        .mb-0 { margin-bottom: 0; }
        .me-4 { margin-right: 1.5rem; }
        .me-2 { margin-right: 0.5rem; }
        .text-center { text-align: center; }
        .text-muted { color: #6c757d; }
    </style>

<style>
    /* ===== PAGE HEADER STYLES ONLY (Prefixed with ph-) ===== */
    :root {
        --ph-primary-color: #2563eb;
        --ph-primary-hover: #1d4ed8;
        --ph-secondary-color: #64748b;
        --ph-bg-secondary: #f8fafc;
        --ph-bg-tertiary: #f1f5f9;
        --ph-bg-accent: #e2e8f0;
        --ph-text-primary: #0f172a;
        --ph-text-secondary: #4a4a4a;
        --ph-text-light: #94a3b8;
        --ph-border-color: #e2e8f0;
        --ph-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --ph-radius-sm: 8px;
        --ph-radius-md: 12px;
        --ph-radius-lg: 16px;
        --ph-spacing-xs: 8px;
        --ph-spacing-sm: 12px;
        --ph-spacing-md: 16px;
        --ph-spacing-lg: 24px;
        --ph-spacing-xl: 32px;
        --ph-spacing-2xl: 48px;
    }

    /* Page Header Section */
    .page-header-section {
        margin-bottom: var(--ph-spacing-2xl);
    }

    .ph-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        /* Changed from flex-start to center */
        flex-wrap: wrap;
        gap: var(--ph-spacing-lg);
    }

    .ph-header-left {
        display: flex;
        align-items: center;
        gap: var(--ph-spacing-md);
        flex-shrink: 0;
    }

    .ph-icon-wrapper {
        width: 64px;
        height: 64px;
        background: var(--ph-primary-color);
        border-radius: var(--ph-radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        box-shadow: var(--ph-shadow-lg);
        flex-shrink: 0;
    }

    .ph-header-text {
        flex: 1;
    }

    .ph-header-title {
        font-weight: 500;
        font-size: 28px;
        color: #2c3e50;
        margin: 0 0 4px 0;
        letter-spacing: -0.02em;
    }

    .ph-header-subtitle {
        font-size: 16px;
        color: var(--ph-text-secondary);
        margin: 0;
        font-weight: 500;
    }

    .ph-header-stats {
        margin-left: auto;
    }

    .ph-stat-badge {
        display: flex;
        align-items: center;

        padding: var(--ph-spacing-sm) var(--ph-spacing-md);
        background: var(--ph-bg-tertiary);
        border: 2px solid var(--ph-border-color);
        border-radius: var(--ph-radius-md);
        font-weight: 600;
        color: var(--ph-text-secondary);
        font-size: 14px;
    }

    /* Breadcrumbs */
    .ph-breadcrumb-nav {
        margin-top: 3rem;
    }

    .ph-breadcrumb-list {
        display: flex;
        align-items: center;
        margin: 0;
        padding: 0;
        list-style: none;
        flex-wrap: wrap;

    }

    .ph-breadcrumb-item {
        display: flex;
        align-items: center;
    }

    .ph-breadcrumb-link {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--ph-bg-secondary);
        border-radius: var(--ph-radius-sm);
        text-decoration: none;
        color: var(--ph-text-secondary);
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .ph-breadcrumb-link:hover {
        background: var(--ph-bg-accent);
        color: var(--ph-text-primary);
        border-color: var(--ph-border-color);
    }

    .ph-breadcrumb-item.active span {
        color: var(--ph-primary-color);
        font-weight: 600;
        padding: 6px 12px;
        background: rgba(37, 99, 235, 0.1);
        border-radius: var(--ph-radius-sm);
        font-size: 14px;
    }

    .ph-breadcrumb-separator {
        color: var(--ph-text-light);
        margin: 0 4px;
        font-size: 12px;
    }

    @media (max-width: 768px) {

        /* adjust breakpoint as needed */
        .ph-header-stats {
            display: none !important;
        }

        .ph-breadcrumb-nav {
            margin-top: 5px;
        }

        .ph-header-title {
            font-size: 1.7rem;
        }
    }
</style>


<style>
    @media (max-width: 768px) {
        .items-container {
            display: block !important;
            overflow-x: scroll !important;
            overflow-y: visible !important;
        }
    }

    /* Mobile Responsive Styles for Freezing Entry Local */
    @media (max-width: 768px) {

        /* Container and page structure */
        .container {
            padding: 10px;
        }

        .page-inner {
            padding: 10px;
        }

        /* Page Header - Mobile */
        .page-header {
            flex-direction: column;
            align-items: stretch;
            margin-bottom: 1.5rem;
            padding: 15px 0;
        }

        .page-header-left {
            margin-bottom: 15px;
        }

        .page-header h3 {
            font-size: 1.5rem !important;
        }

        .page-header-right {
            margin-left: 0;
            width: 100%;
        }

        /* Header Actions - Stack vertically */
        .header-actions {
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .header-btn {
            width: 100%;
            justify-content: center;
            padding: 10px 16px;
            font-size: 13px;
            min-height: 42px;
        }

        .header-btn i {
            font-size: 14px;
            margin-right: 8px;
        }

        /* Form Card */
        .form-card {
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 15px !important;
        }

        .card-header .d-flex {
            flex-direction: column !important;
            align-items: flex-start !important;
        }

        .card-header .d-flex.justify-content-between {
            width: 100%;
        }

        .icon-wrapper {
            width: 45px !important;
            height: 45px !important;
            font-size: 18px !important;
            margin-right: 12px !important;
            margin-bottom: 0 !important;
        }

        .card-title {
            font-size: 18px !important;
        }

        .card-header p {
            font-size: 12px !important;
        }

        /* Add button mobile */
        .add-btn {
            width: 50%;
            margin-top: 12px;
            justify-content: center;
        }

        /* Basic Entry Table - Stack vertically */
        .basic-entry-table {
            display: block;
            width: 100%;
        }

        .basic-entry-table thead {
            display: none;
        }

        .basic-entry-table tbody,
        .basic-entry-table tr,
        .basic-entry-table td {
            display: block;
            width: 100%;
        }

        .basic-entry-table tr {
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fd;
        }

        .basic-entry-table td {
            border: none !important;
            padding: 10px 0 !important;
            position: relative;
            text-align: left;
        }

        .basic-entry-table td:before {
            content: attr(data-label);
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-size: 12px;
            text-transform: uppercase;
        }

        /* Items Container - Horizontal scroll */

        /* Items Container */
        .items-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            overflow-y: visible;
            margin-bottom: 20px;
            border: 1px solid #f1f3f7;
            border-radius: 12px;
            box-sizing: border-box;
            padding-left: 15px;
            padding-right: 15px;
            -webkit-overflow-scrolling: touch;
        }



        .items-table {
            min-width: 1200px;
            table-layout: auto;
        }

        .items-table th,
        .items-table td {
            font-size: 11px !important;
            padding: 8px 6px !important;
        }

        .items-table .table-header {
            padding: 12px 8px !important;
            font-size: 10px !important;
        }

        .items-table .header-icon {
            font-size: 10px !important;
            margin-right: 4px !important;
        }

        /* Table cell inputs */
        .table-cell input,
        .table-cell select {
            font-size: 12px !important;
            padding: 8px 10px !important;
        }

        /* Action buttons in table */
        .action-btn {
            padding: 6px 10px !important;
            font-size: 11px !important;
        }

        .action-btn i {
            font-size: 11px !important;
            margin-right: 4px;
        }

        .action-btn span {
            display: none;
        }

        /* Totals Card - Mobile Responsive */
        .totals-card {
            padding: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .totals-title {
            font-size: 1.25rem !important;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .totals-title i {
            font-size: 1.25rem !important;
            margin-right: 10px;
        }

        /* Totals Table - Make it scrollable OR stack it */

        /* Option 1: Horizontal scroll (keeps table structure) */
        .totals-table {
            min-width: 600px;
            font-size: 11px;
        }

        .totals-table th,
        .totals-table td {
            padding: 10px 8px !important;
            font-size: 11px !important;
            white-space: nowrap;
        }

        .totals-table input {
            padding: 8px 10px !important;
            font-size: 12px !important;
            min-width: 80px;
        }

        /* Option 2: Stack totals vertically (uncomment if preferred) */
        /*
  .totals-table,
  .totals-table thead,
  .totals-table tbody,
  .totals-table tr,
  .totals-table th,
  .totals-table td {
    display: block;
    width: 100%;
  }
  
  .totals-table thead {
    display: none;
  }
  
  .totals-table tr {
    margin-bottom: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 10px;
    background: #f8f9fd;
  }
  
  .totals-table td {
    border: none !important;
    padding: 10px 0 !important;
    text-align: left !important;
    position: relative;
  }
  
  .totals-table td:before {
    content: attr(data-label);
    font-weight: 600;
    display: block;
    margin-bottom: 5px;
    color: #495057;
    font-size: 12px;
    text-transform: uppercase;
  }
  
  .totals-table input {
    width: 100% !important;
    text-align: left !important;
  }
  */

        /* Form Actions */
        .form-actions {
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .submit-btn,
        .cancel-btn {
            width: 120%;
            justify-content: center;
            padding: 12px 20px !important;
            font-size: 14px !important;
        }

        /* Card body */
        .card-body {
            padding: 15px !important;
        }
    }


    /* Add data labels for basic entry table on mobile */
    @media (max-width: 768px) {
        .basic-entry-table tbody tr td:nth-child(1):before {
            content: "Freezing Date";
        }

        .basic-entry-table tbody tr td:nth-child(2):before {
            content: "Voucher Number";
        }

        .basic-entry-table tbody tr td:nth-child(3):before {
            content: "Spot Purchase Date";
        }

        .basic-entry-table tbody tr td:nth-child(4):before {
            content: "Spot";
        }

        .basic-entry-table tbody tr td:nth-child(5):before {
            content: "Spot Agent";
        }

        .basic-entry-table tbody tr td:nth-child(6):before {
            content: "Spot Supervisor";
        }
    }

    /* Add data labels for totals table on mobile (if using stacked version) */
    @media (max-width: 768px) {
        /* Uncomment if using stacked totals table
  .totals-table tbody tr td:nth-child(1):before { content: "Total USD"; }
  .totals-table tbody tr td:nth-child(2):before { content: "Total INR"; }
  .totals-table tbody tr td:nth-child(3):before { content: "Total Slab"; }
  .totals-table tbody tr td:nth-child(4):before { content: "Total C/S"; }
  .totals-table tbody tr td:nth-child(5):before { content: "Total KG"; }
  .totals-table tbody tr td:nth-child(6):before { content: "Freezing Status"; }
  */
    }

    /* Horizontal scroll indicators */
    @media (max-width: 768px) {
        .items-container:after {
            content: "← Scroll horizontally to see all columns →";
            display: block;
            text-align: center;
            color: #6c757d;
            font-size: 11px;
            padding: 10px;
            font-style: italic;
            background: #f8f9fd;
            border-top: 1px solid #e9ecef;
            margin-top: 10px;
        }

        .totals-card:after {
            content: "← Scroll to see all totals →";
            display: block;
            text-align: center;
            color: #6c757d;
            font-size: 11px;
            padding: 8px;
            font-style: italic;
            margin-top: 10px;
        }

        /* Improve scroll visibility */
        .items-container::-webkit-scrollbar,
        .totals-card::-webkit-scrollbar {
            height: 8px;
        }

        .items-container::-webkit-scrollbar-track,
        .totals-card::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .items-container::-webkit-scrollbar-thumb,
        .totals-card::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .items-container::-webkit-scrollbar-thumb:hover,
        .totals-card::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    }

    /* Improved touch targets for mobile */
    @media (max-width: 768px) {

        select,
        input,
        textarea,
        button {
            min-height: 44px;
        }

        .action-btn {
            min-height: 36px;
            min-width: 36px;
        }
    }

    /* Tablet adjustments */
    @media (min-width: 769px) and (max-width: 1024px) {
        .header-actions {
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .header-btn {
            flex: 0 1 calc(50% - 6px);
            min-width: 150px;
        }

        .items-table th,
        .items-table td {
            font-size: 12px !important;
            padding: 10px 8px !important;
        }

        .totals-table th,
        .totals-table td {
            font-size: 12px !important;
            padding: 12px 10px !important;
        }
    }
</style>


    <div class="container">
        <div class="page-inner">
        <div class="page-header-section" style="margin-top: 1rem;">
            <div class="ph-header-content">
                <div class="ph-header-left">
                    <div class="ph-icon-wrapper">
                        <i class="fa-solid fa-snowflake"></i>
                    </div>
                    <div class="ph-header-text">
                        <h3 class="ph-header-title">Freezing Operations</h3>
                        <p class="ph-header-subtitle">Manage your freezing operations.</p>
                    </div>
                </div>

                <!-- Breadcrumbs - Now inline with header -->
                <nav class="ph-breadcrumb-nav">
                    <ol class="ph-breadcrumb-list">
                        <li class="ph-breadcrumb-item">
                            <a href="#" class="ph-breadcrumb-link">
                                <i class="icon-home"></i>
                                <span>Home</span>
                            </a>
                        </li>
                        <li class="ph-breadcrumb-separator">
                            <i class="icon-arrow-right"></i>
                        </li>
                        <li class="ph-breadcrumb-item ">
                            <a href="{%url 'adminapp:freezing_entry_spot_list'%}" class="ph-breadcrumb-link">
                                <i class="fa-solid fa-snowflake"></i>
                                <span>Spot Freezing Entries</span>
                            </a>
                        </li>
                        <li class="ph-breadcrumb-separator">
                            <i class="icon-arrow-right"></i>
                        </li>
                        <li class="ph-breadcrumb-item active">
                            <a href="{%url 'adminapp:freezing_entry_spot_create'%}">
                                <span>Create</span>
                            </a>
                        </li>
                    </ol>
                </nav>
                <div class="ph-header-stats">

                </div>
            </div>
        </div>

            <form method="post" class="freezing-entry-form">
                {% csrf_token %}

                <!-- Basic Details Card -->
                <div class="form-card">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <div class="icon-wrapper me-4">
                                <i class="fas fa-snowflake"></i>
                            </div>
                            <div>
                                <h3 class="card-title">Freezing Details</h3>
                                <p class="text-muted mb-0">Enter basic freezing information</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="">
                        <table class="basic-entry-table">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="header-content">
                                            <i class="fas fa-calendar-alt header-icon"></i>
                                            <span>Freezing Date</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-content">
                                            <i class="fas fa-hashtag header-icon"></i>
                                            <span>Voucher Number</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-content">
                                            <i class="fas fa-calendar header-icon"></i>
                                            <span>Spot Purchase Date</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-content">
                                            <i class="fas fa-map-marker-alt header-icon"></i>
                                            <span>Spot</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-content">
                                            <i class="fas fa-user header-icon"></i>
                                            <span>Spot Agent</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-content">
                                            <i class="fas fa-user-tie header-icon"></i>
                                            <span>Spot Supervisor</span>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>{{ form.freezing_date }} {{ form.freezing_date.errors }}</td>
                                    <td>{{ form.voucher_number }} {{ form.voucher_number.errors }}</td>
                                    <td>{{ form.spot_purchase_date }} {{ form.spot_purchase_date.errors }}</td>
                                    <td>{{ form.spot }} {{ form.spot.errors }}</td>
                                    <td>{{ form.spot_agent }} {{ form.spot_agent.errors }}</td>
                                    <td>{{ form.spot_supervisor }} {{ form.spot_supervisor.errors }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Items Card -->
                <div class="form-card">
                    <div class="card-header">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="icon-wrapper me-4">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div>
                                    <h4 class="card-title mb-0">Items</h4>
                                    <p class="text-muted mb-0">Add items to your freezing entry</p>
                                </div>
                                 <div>
                                    <h4 class="card-title mb-0 p-4" id="dollarRateDisplay">
                                        $ (Loading...)
                                    </h4>           
                                </div>
                            </div>
                            <button type="button" id="add-more-btn" class="add-btn">
                                <i class="fas fa-plus me-2"></i>Add Item
                            </button>
                        </div>
                    </div>

                    {{ formset.management_form }}

                    <div class="card-body p-0">
                        <div class="items-container">
                            <table class="modern items-table" id="formset-table">
                                <thead >
                                    <tr>
                                        <th class="table-header col-pr-centre">
                                            <div class="header-content">
                                                <i class="fas fa-industry header-icon"></i>
                                              <a class="link-hover"  href="{% url 'adminapp:processing_center_create' %}"  target="_blank">
                                                    <span class="header-text">PR Centre</span>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="table-header col-store">
                                            <div class="header-content">
                                                <i class="fas fa-store header-icon"></i>
                                                                                              <a class="link-hover"  href="{% url 'adminapp:store_create' %}" target="_blank">
                                                    <span class="header-text">Store</span>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="table-header col-shed">
                                            <div class="header-content">
                                                <i class="fas fa-warehouse header-icon"></i>
                                                                                              <a class="link-hover"  href="{% url 'adminapp:create_shed' %}" target="_blank">
                                                    <span class="header-text">Shed</span>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="table-header col-item">
                                            <div class="header-content">
                                                <i class="fas fa-tag header-icon"></i>
                                                                                              <a class="link-hover"  href="{% url 'adminapp:item_create' %}" target="_blank">
                                                    <span class="header-text">item</span>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="table-header col-category">
                                            <div class="header-content">
                                                <i class="fas fa-star header-icon"></i>
                                                                                              <a class="link-hover"  href="{% url 'adminapp:item_quality_create' %}" target="_blank">
                                                    <span class="header-text">Item sub</span>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="table-header col-unit">
                                            <div class="header-content">
                                                <i class="fas fa-ruler header-icon"></i>
                                                <a class="link-hover"  href="{% url 'adminapp:packing_unit_create' %}" target="_blank">
                                                    <span class="header-text">Unit</span>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="table-header col-glaze">
                                            <div class="header-content">
                                                
                                                                                              <a class="link-hover"  class="link-hover" href="{% url 'adminapp:glaze_percentage_create' %}" target="_blank">
                                                    <span class="header-text">glaze</span>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="table-header col-fr-category">
                                            <div class="header-content">
                                                <i class="fas fa-list header-icon"></i>
                                                                                              <a class="link-hover"  href="{% url 'adminapp:freezing_category_create' %}" target="_blank">
                                                    <span class="header-text">FR Category</span>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="table-header col-brand">
                                            <div class="header-content">
                                                <i class="fas fa-trademark header-icon"></i>
                                                                                              <a  class="link-hover" href="{% url 'adminapp:item_brand_create' %}" target="_blank">
                                                    <span class="header-text">Brand</span>
                                                </a>
                                            </div>
                                        </th>
                                        <!-- <th class="table-header col-species">
                                            <div class="header-content">
                                                <i class="fas fa-fish header-icon"></i>
                                                <a class="link-hover"  href="{% url 'adminapp:species_create' %}" target="_blank">
                                                    <span class="header-text">Species</span>
                                                </a>
                                            </div>
                                        </th> -->
                                        <th class="table-header col-type">
                                            <div class="header-content">
                                                <i class="fas fa-layer-group header-icon"></i>
                                                                                              <a class="link-hover"  href="{% url 'adminapp:item_type_create' %}" target="_blank">
                                                    <span class="header-text">Type</span>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="table-header col-grade">
                                            <div class="header-content">
                                                <i class="fas fa-certificate header-icon"></i>
                                                                                              <a class="link-hover"  href="{% url 'adminapp:item_grade_create' %}" target="_blank">
                                                    <span class="header-text">Grade</span>
                                                </a>
                                            </div>
                                        </th>
                                        <th class="table-header col-slab-qty">
                                            <div class="header-content">
                                                <i class="fas fa-layer-group header-icon"></i>
                                                <span class="header-text">Slab Qty</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-usd-rate-kg">
                                            <div class="header-content">
                                                <i class="fas fa-dollar-sign header-icon"></i>
                                                <span class="header-text">Price</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-yield">
                                            <div class="header-content">
                                                <i class="fas fa-percentage header-icon"></i>
                                                <span class="header-text">Yield</span>
                                            </div>
                                        </th>
                                        <th class="table-header col-action text-center">
                                            <div class="header-content justify-content-center">
                                                <i class="fas fa-tools header-icon"></i>
                                                <span class="header-text">Action</span>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="formset-container">
                                    {% for form in formset %}
                                    <tr class="formset-form table-row">
                                        <td class="table-cell col-pr-centre">{{ form.processing_center }} {{ form.processing_center.errors }}</td>
                                        <td class="table-cell col-store">{{ form.store }} {{ form.store.errors }}</td>
                                        <td class="table-cell col-shed">{{ form.shed }} {{ form.shed.errors }}</td>
                                        <td class="table-cell col-item">{{ form.item }} {{ form.item.errors }}</td>
                                        <td class="table-cell ">{{ form.item_quality }} {{ form.item_quality.errors }}</td>
                                        <td class="table-cell col-unit">{{ form.unit }} {{ form.unit.errors }}</td>
                                        <td class="table-cell col-glaze">{{ form.glaze }} {{ form.glaze.errors }}</td>
                                        <td class="table-cell col-fr-category">{{ form.freezing_category }} {{ form.freezing_category.errors }}</td>
                                        <td class="table-cell col-brand">{{ form.brand }} {{ form.brand.errors }}</td>
                                        <!-- <td class="table-cell col-species">{{ form.species }} {{ form.species.errors }}</td> -->
                                        <td class="table-cell col-type">{{ form.peeling_type }} {{ form.peeling_type.errors }}</td>
                                        <td class="table-cell col-grade">{{ form.grade }} {{ form.grade.errors }}</td>
                                        <td class="table-cell col-slab-qty">{{ form.slab_quantity }} {{ form.slab_quantity.errors }}</td>
                                        <td class="hidden">{{ form.c_s_quantity }} {{ form.c_s_quantity.errors }}</td>
                                        <td class="hidden">{{ form.kg }} {{ form.kg.errors }}</td>
                                        <td class="table-cell col-usd-rate-kg">{{ form.usd_rate_per_kg }} {{ form.usd_rate_per_kg.errors }}</td>
                                        <td class="hidden">{{ form.usd_rate_item }} {{ form.usd_rate_item.errors }}</td>
                                        <td class="hidden">{{ form.usd_rate_item_to_inr }} {{ form.usd_rate_item_to_inr.errors }}</td>
                                        <td class="table-cell col-yield">{{ form.yield_percentage }} {{ form.yield_percentage.errors }}</td>
                                        <td class="table-cell col-action text-center">
                                            <button type="button" class="action-btn delete-btn remove-btn">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Totals Card -->
                <div class="form-card">
                                        <div class="card-header">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="icon-wrapper me-4">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div>
                                    <h4 class="card-title mb-0">Freezing Entry Summary</h4>
                                    <p class="text-muted mb-0">Overview of spot freezing summary</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="totals-card">

                        <table class="totals-table">
                            <thead>
                                <tr>
                                    <th>Total Yield %</th>
                                    <th>Total USD</th>
                                    <th>Total INR</th>
                                    <th>Total Slab</th>
                                    <th>Total C/S</th>
                                    <th>Total KG</th>
                                    <th>Freezing Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>{{ form.total_yield_percentage }} {{ form.total_yield_percentage.errors }}</td>
                                    <td>{{ form.total_usd }} {{ form.total_usd.errors }}</td>
                                    <td>{{ form.total_inr }} {{ form.total_inr.errors }}</td>
                                    <td>{{ form.total_slab }} {{ form.total_slab.errors }}</td>
                                    <td>{{ form.total_c_s }} {{ form.total_c_s.errors }}</td>
                                    <td>{{ form.total_kg }} {{ form.total_kg.errors }}</td>
                                    <td style="width: 200px;">{{ form.freezing_status }} {{ form.freezing_status.errors }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>


                      <!-- Submit Section -->
      <div class="form-actions">
        <div class="row">
          <div class="col-lg-6 mb-3">
            <button type="submit" class="submit-btn">
              <i class="fas fa-save me-2"></i>Save
            </button>
          </div>
          <div class="col-lg-6 mb-3">
            <a href="{% url 'adminapp:freezing_entry_spot_list' %}" class="cancel-btn">
              <i class="fas fa-times me-2"></i>Cancel
            </a>
          </div>
        </div>
      </div>
            </form>
        </div>
    </div>

    <!-- // ITEM QUALITY LOADER spot-->
    <script>
    $(document).ready(function() {
        console.log('Item Quality Script Loaded');

        // Event handler for item selection change
        $(document).on('change', 'select[name$="-item"]', function() {
            const itemSelect = $(this);
            const itemId = itemSelect.val();
            const row = itemSelect.closest('tr');
            const qualitySelect = row.find('select[name$="-item_quality"]');

            console.log('Item changed. Item ID:', itemId);

            // Reset quality dropdown
            qualitySelect.empty().append('<option value="">---------</option>');

            // If item is selected, fetch its qualities
            if (itemId) {
                console.log('Fetching qualities for item:', itemId);
                
                $.get("{% url 'adminapp:get_item_qualities' %}", { item_id: itemId })
                    .done(function(data) {
                        console.log('Qualities received:', data);
                        
                        // Check if data is an array and has items
                        if (Array.isArray(data) && data.length > 0) {
                            data.forEach(function(quality) {
                                qualitySelect.append(
                                    `<option value="${quality.id}">${quality.quality}</option>`
                                );
                            });
                            console.log(`Loaded ${data.length} qualities`);
                        } else {
                            console.log('No qualities found for this item');
                            // Optionally add a message to the dropdown
                            // qualitySelect.append('<option value="">No qualities available</option>');
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Error loading qualities:', {
                            status: status,
                            error: error,
                            response: xhr.responseText
                        });
                        
                        // Optionally show error message to user
                        qualitySelect.append('<option value="">Error loading qualities</option>');
                    });
            } else {
                console.log('No item selected, quality dropdown reset');
            }
        });

        console.log('Item quality event handler attached');
    });
    </script>
  
    <!-- Clone & Add More Formset with Slab / CS / KG Calculation -->
    <script>
    $(document).ready(function () {
        const formsetContainer = $('#formset-container');
        const totalForms = $('#id_form-TOTAL_FORMS');

        $('#add-more-btn').click(function () {
            let formIndex = parseInt(totalForms.val());
            let lastForm = $('.formset-form:last');
            let newForm = lastForm.clone(false);

            // Fields to preserve
            const fieldsToPreserve = [
                'processing_center','store','shed','item','item_quality','unit',
                'glaze','freezing_category','brand','species','peeling_type'
            ];

            // Fields to completely reset
            const fieldsToCompletelyReset = [
                'usd_rate_per_kg','usd_rate_item','usd_rate_item_to_inr'
            ];

            // Fields to reset normally
            const fieldsToReset = [
                'grade','slab_quantity','c_s_quantity','kg','yield_percentage'
            ];

            // Preserve values from the last form
            let preservedValues = {};
            fieldsToPreserve.forEach(function(fieldName){
                let element = lastForm.find(`[name*="${fieldName}"]`);
                if (element.length > 0) preservedValues[fieldName] = element.val();
            });

            // Update names, ids, reset values
            newForm.find(':input').each(function(){
                let name = $(this).attr('name');
                if(name){
                    let oldFieldName = name.split('-').pop();
                    name = name.replace(/-\d+-/, `-${formIndex}-`);
                    let id = 'id_'+name;
                    $(this).attr({name:name, id:id});

                    if(fieldsToPreserve.includes(oldFieldName) && preservedValues[oldFieldName] !== undefined){
                        $(this).val(preservedValues[oldFieldName]);
                    } else if(fieldsToReset.includes(oldFieldName)){
                        if($(this).is('select')) $(this).prop('selectedIndex', 0);
                        else $(this).val('');
                    } else if(fieldsToCompletelyReset.includes(oldFieldName)){
                        let $newInput = $('<input>').attr({
                            'type': $(this).attr('type') || 'text',
                            'name': name,
                            'id': id,
                            'class': $(this).attr('class') || '',
                            'step': $(this).attr('step') || '',
                            'value': ''
                        });
                        $(this).replaceWith($newInput);
                    }
                }
            });

            // Add calculation classes
            newForm.find('[name*="slab_quantity"]').addClass('slab-quantity');
            newForm.find('[name*="c_s_quantity"]').addClass('cs-quantity');
            newForm.find('[name*="kg"]:not([name*="usd_rate_per_kg"])').addClass('kg');
            newForm.find('[name*="usd_rate_per_kg"]').addClass('usd-rate-per-kg');
            newForm.find('[name*="usd_rate_item"]:not([name*="usd_rate_item_to_inr"])').addClass('usd-rate-item');
            newForm.find('[name*="usd_rate_item_to_inr"]').addClass('usd-rate-item-inr');
            newForm.find('[name*="unit"]').addClass('unit-select');

            // Reset DELETE field
            newForm.find('input[name$="-DELETE"]').prop('checked', false);

            // Fetch unit details again if needed
            let unitId = preservedValues['unit'];
            if (unitId) {
                $.getJSON("{% url 'adminapp:get_unit_details' %}", { unit_id: unitId }, function (data) {
                    newForm.data('precision', data.precision);
                    newForm.data('factor', data.factor);
                });
            }

            // Append new form
            formsetContainer.append(newForm);
            totalForms.val(formIndex + 1);

            // Force clear USD fields
            setTimeout(function() {
                newForm.find('[name*="usd_rate_per_kg"]').val('');
                newForm.find('[name*="usd_rate_item"]:not([name*="usd_rate_item_to_inr"])').val('');
                newForm.find('[name*="usd_rate_item_to_inr"]').val('');
            }, 100);

            // Focus first blank field
            newForm.find('[name*="grade"]').focus();

            console.log('New form cloned from last form, USD fields cleared');
        });
    });
    </script>

    <!-- Remove (event delegation so it works for new forms too) -->
    <script>
    $(document).ready(function () {
        const formsetContainer = $("#formset-container");
        const totalForms = $("#id_form-TOTAL_FORMS");

        // Remove (event delegation so it works for new forms too)
        $(document).on("click", ".remove-btn", function () {
            if ($(".formset-form").length > 1) {
                $(this).closest(".formset-form").remove();

                // Re-number forms
                let forms = $(".formset-form");
                totalForms.val(forms.length);
                forms.each(function (index) {
                    $(this).find("input, select, label").each(function () {
                        if ($(this).attr("name")) {
                            let name = $(this).attr("name").replace(/-\d+-/, "-" + index + "-");
                            $(this).attr("name", name);
                            $(this).attr("id", "id_" + name);
                        }
                        if ($(this).attr("for")) {
                            let newFor = $(this).attr("for").replace(/-\d+-/, "-" + index + "-");
                            $(this).attr("for", newFor);
                        }
                    });
                });
            } else {
                alert("At least one form is required.");
            }
        });
    });
    </script>

    <!-- Unit Calculation -->
    <script>
    $(document).ready(function () {
        let dollarRate = 0;

        // Fetch dollar rate on page load
        $.getJSON("{% url 'adminapp:get_dollar_rate' %}", function (data) {
            if (data.dollar_rate_to_inr) {
                dollarRate = parseFloat(data.dollar_rate_to_inr);
            }
        }).fail(function() {
            console.log('Could not fetch dollar rate, using default 0');
        });

        // Helper to recalc a single formset row
        function recalcRow($row) {
            let slabQty = parseFloat($row.find('.slab-quantity').val()) || 0;
            let usdPerKg = parseFloat($row.find('.usd-rate-per-kg').val()) || 0;
            let precision = parseFloat($row.data('precision')) || 0;
            let factor = parseFloat($row.data('factor')) || 0;

            // Calculate CS Quantity only if we have slab quantity and precision
            if (slabQty && precision) {
                $row.find('.cs-quantity').val((slabQty / precision).toFixed(2));
            } else if (!slabQty) {
                $row.find('.cs-quantity').val('');
            }

            // Calculate KG only if we have slab quantity and factor
            if (slabQty && factor) {
                $row.find('.kg').val((slabQty * factor).toFixed(2));
            } else if (!slabQty) {
                $row.find('.kg').val('');
            }

            // Calculate USD Rate Item only if we have both KG and USD per KG
            let kg = parseFloat($row.find('.kg').val()) || 0;
            if (kg && usdPerKg) {
                $row.find('.usd-rate-item').val((usdPerKg * kg).toFixed(2));
            } else {
                $row.find('.usd-rate-item').val('');
            }

            // Calculate USD Rate Item to INR
            let usdItem = parseFloat($row.find('.usd-rate-item').val()) || 0;
            if (usdItem && dollarRate) {
                $row.find('.usd-rate-item-inr').val((usdItem * dollarRate).toFixed(2));
            } else {
                $row.find('.usd-rate-item-inr').val('');
            }
        }

        // When unit changes → fetch precision/factor and recalc
        $(document).on('change', '.unit-select', function () {
            let $row = $(this).closest('.formset-form');
            let unitId = $(this).val();

            if (!unitId) {
                // Clear data attributes if no unit selected
                $row.removeData('precision').removeData('factor');
                recalcRow($row);
                return;
            }

            $.getJSON("{% url 'adminapp:get_unit_details' %}", { unit_id: unitId }, function (data) {
                $row.data('precision', data.precision);
                $row.data('factor', data.factor);
                recalcRow($row);
            }).fail(function() {
                console.log('Could not fetch unit details for unit ID:', unitId);
            });
        });

        // Trigger recalculation on input changes
        $(document).on('input', '.slab-quantity, .usd-rate-per-kg', function () {
            let $row = $(this).closest('.formset-form');
            recalcRow($row);
        });

        // Clear dependent fields when slab quantity is cleared
        $(document).on('input', '.slab-quantity', function () {
            let $row = $(this).closest('.formset-form');
            if (!$(this).val()) {
                $row.find('.cs-quantity, .kg, .usd-rate-item, .usd-rate-item-inr').val('');
            }
        });

        // Clear dependent fields when USD rate per kg is cleared
        $(document).on('input', '.usd-rate-per-kg', function () {
            let $row = $(this).closest('.formset-form');
            if (!$(this).val()) {
                $row.find('.usd-rate-item, .usd-rate-item-inr').val('');
            }
        });

        // Prevent any automatic filling of USD rate per kg in cloned forms
        $(document).on('focus', '.usd-rate-per-kg', function() {
            // Only allow focus if it's an existing form or user actually clicked
            let $row = $(this).closest('.formset-form');
            if (!$(this).data('user-interaction') && $row.index() > 0) {
                // This is a cloned form and no user interaction yet
                if ($(this).val() !== '') {
                    console.log('Auto-filled value detected, clearing...');
                    $(this).val('');
                }
            }
            $(this).data('user-interaction', true);
        });
    });
    </script>

    <!-- Populate Spots based on Date -->
    <script>
        $('#id_spot_purchase_date').on('change', function () {
            const date = $(this).val();
            $.get("{% url 'adminapp:get_spots_by_date' %}", { date: date }, function (data) {
                const spotSelect = $('#id_spot').empty().append('<option value="">---------</option>');
                data.spots.forEach(spot => {
                    spotSelect.append(`<option value="${spot.id}">${spot.spot__location_name} - ${spot.voucher_number}</option>`);
                });
            });
        });
    </script>

    <!-- Populate Agent & Supervisor based on Spot -->
    <script>
        $('#id_spot').on('change', function () {
            const spotId = $(this).val();
            if (!spotId) return;

            $.get("{% url 'adminapp:get_spot_details' %}", { spot_id: spotId }, function (data) {
                const agent = $('#id_spot_agent');
                const supervisor = $('#id_spot_supervisor');

                if (!agent.find(`option[value="${data.agent_id}"]`).length) {
                    agent.append(`<option value="${data.agent_id}">${data.agent_name}</option>`);
                }
                agent.val(data.agent_id);

                if (!supervisor.find(`option[value="${data.supervisor_id}"]`).length) {
                    supervisor.append(`<option value="${data.supervisor_id}">${data.supervisor_name}</option>`);
                }
                supervisor.val(data.supervisor_id);
            });
        });
    </script>

    <!-- Populate Sheds and Items based on Date -->
    <script>
        $('#id_spot_purchase_date').on('change', function () {
            const selectedDate = $(this).val();
            if (!selectedDate) return;

            $.get("{% url 'adminapp:get_sheds_by_date' %}", { date: selectedDate }, function (data) {
                const shedSet = new Set();

                data.sheds.forEach(supply => {
                    shedSet.add(`<option value="${supply.shed_id}">${supply.shed_name}</option>`);
                });

                $('[name$="-shed"]').each(function () {
                    $(this).empty().append('<option value="">---------</option>');
                    shedSet.forEach(opt => $(this).append(opt));
                });

            }).fail(() => alert("Failed to load sheds/items for the selected date."));
        });
    </script>

<!-- Total Calculation with Sum of Yields / Number of Sheds -->
<script>
    function calculateTotals() {
        let totalYieldSum = 0, totalUSD = 0, totalINR = 0, totalSlab = 0, totalCS = 0, totalKG = 0;
        let uniqueSheds = new Set(); // Track unique sheds

        $('.formset-form').each(function () {
            // Skip deleted forms
            if ($(this).find('[name$="DELETE"]').is(':checked')) {
                return;
            }

            const getVal = (name) => {
                const val = parseFloat($(this).find(`[name$="${name}"]`).val());
                return isNaN(val) ? 0 : val;
            };

            const yieldPercentage = getVal('yield_percentage');
            const usdRate = getVal('usd_rate_item');
            const inrRate = getVal('usd_rate_item_to_inr');
            const slabQty = getVal('slab_quantity');
            const csQty = getVal('c_s_quantity');
            const kgWeight = getVal('kg');

            // Get shed name - try multiple possible selectors
            const shed = $(this).find('[name$="shed"]').val() || 
                        $(this).find('[name$="shed_name"]').val() || 
                        $(this).find('select[name*="shed"]').val() || 
                        $(this).find('input[name*="shed"]').val() ||
                        $(this).find('td:eq(2)').text().trim(); // Fallback: get from 3rd column

            // Sum all yields
            totalYieldSum += yieldPercentage;
            
            // Track unique sheds (only if row has data)
            if ((slabQty > 0 || kgWeight > 0) && shed) {
                uniqueSheds.add(shed);
            }
            
            totalUSD += usdRate;
            totalINR += inrRate;
            totalSlab += slabQty;
            totalCS += csQty;
            totalKG += kgWeight;
        });

        // Calculate average yield: Sum of all yields / Number of unique sheds
        const numberOfSheds = uniqueSheds.size;
        const averageYield = numberOfSheds > 0 ? totalYieldSum / numberOfSheds : 0;

        // Update the total fields
        $('#id_total_yield_percentage').val(averageYield.toFixed(2));
        $('#id_total_usd').val(totalUSD.toFixed(2));
        $('#id_total_inr').val(totalINR.toFixed(2));
        $('#id_total_slab').val(totalSlab.toFixed(2));
        $('#id_total_c_s').val(totalCS.toFixed(2));
        $('#id_total_kg').val(totalKG.toFixed(2));

        console.log('Sum of all yields:', totalYieldSum.toFixed(2));
        console.log('Number of unique sheds:', numberOfSheds);
        console.log('Average yield:', averageYield.toFixed(2));
    }

    // Trigger calculation on any input change
    $(document).on('input change', '.formset-form :input', calculateTotals);
    $(document).on('change', '.formset-form [name$="DELETE"]', calculateTotals);
    $(document).ready(calculateTotals);
</script>

    <!-- WORKING yield-percentage calculation -->
    <script>
    $(document).ready(function () {
        let ajaxCall = null;

        // Function to get spot purchase ID - improved detection
        function getSpotPurchaseId() {
            // Try all possible ways to get spot purchase ID
            let spotId = 
                $("#id_spot_purchase").val() ||          // Standard Django field
                $("#spot_purchase").val() ||              // Simple field
                $("select[name='spot_purchase']").val() || // Form field
                $("select[name='spot']").val() ||         // Short name
                $("input[name='spot_purchase_id']").val() || // Hidden field
                $("[name*='spot'][name*='purchase']:not([name*='date'])").val() || // Any spot purchase field (not date)
                $("select option:selected").filter(function() { // Look for selected options with numeric values
                    return /^\d+$/.test($(this).val()) && $(this).closest('select').attr('name') && 
                        $(this).closest('select').attr('name').includes('spot');
                }).val();

            // Additional check: look for any select with a numeric value that might be spot ID
            if (!spotId) {
                $("select").each(function() {
                    let val = $(this).val();
                    let name = $(this).attr('name') || '';
                    // If it's a select with numeric value and name suggests it's related to spot
                    if (val && /^\d+$/.test(val) && (name.includes('spot') || name.includes('purchase')) && !name.includes('date')) {
                        console.log('Found potential spot ID in select:', name, '=', val);
                        spotId = val;
                        return false; // break
                    }
                });
            }

            console.log('🔍 Searching for spot purchase ID...');
            console.log('Found spot ID:', spotId);
            
            // Validate it's actually a number, not a date
            if (spotId && (spotId.includes('-') || spotId.length > 4)) {
                console.warn('⚠️  Spot ID looks invalid (too long or contains dashes):', spotId);
                return null;
            }
            
            return spotId;
        }

        // Function to get date
        function getSpotDate() {
            return $("#id_spot_purchase_date").val() || 
                $("input[name*='date']").val() ||
                $("input[type='date']").val();
        }

        // Enhanced yield calculation with debugging
        $(document).on("input change", "input, select", function () {
            // Only trigger for relevant fields
            let fieldName = $(this).attr('name') || '';
            if (!fieldName.includes('kg') && !fieldName.includes('quantity') && 
                !fieldName.includes('shed') && !fieldName.includes('item') &&
                !fieldName.includes('weight')) {
                return; // Skip irrelevant fields
            }

            console.log('🔄 Yield calculation triggered by field:', fieldName, 'Value:', $(this).val());
            
            // Find the row containing this field
            let row = $(this).closest('tr, .form-row, .formset-form, .dynamic-form, div').filter(function() {
                return $(this).find('input, select').length > 1; // Must contain multiple form fields
            }).first();
            
            if (row.length === 0) {
                console.log('❌ Could not find form row');
                return;
            }

            console.log('✅ Found form row with', row.find('input, select').length, 'fields');

            // Find fields within this row
            let kgField = row.find("input[name*='kg'], input[name*='quantity'], input[name*='weight']").first();
            let yieldField = row.find("input[name*='yield'], input[name*='percentage']").first();
            let shedSelect = row.find("select[name*='shed']").first();
            let itemSelect = row.find("select[name*='item']").first();

            console.log('📋 Form fields in this row:');
            console.log('  - KG field:', kgField.length ? `${kgField.attr('name')} = ${kgField.val()}` : '❌ NOT FOUND');
            console.log('  - Yield field:', yieldField.length ? `${yieldField.attr('name')} = ${yieldField.val()}` : '❌ NOT FOUND');
            console.log('  - Shed select:', shedSelect.length ? `${shedSelect.attr('name')} = ${shedSelect.val()}` : '❌ NOT FOUND');
            console.log('  - Item select:', itemSelect.length ? `${itemSelect.attr('name')} = ${itemSelect.val()}` : '❌ NOT FOUND');

            // Get values
            let slabQuantity = parseFloat(kgField.val()) || 0;  // This is slab count, not kg!
            let selectedShed = shedSelect.val();
            let selectedItem = itemSelect.val();
            let spotDate = getSpotDate();
            let spotId = getSpotPurchaseId();

            console.log('📊 Calculation inputs:');
            console.log('  - Slabs entered:', slabQuantity);
            console.log('  - Selected shed:', selectedShed);
            console.log('  - Selected item:', selectedItem);
            console.log('  - Spot date:', spotDate);
            console.log('  - Spot ID:', spotId);

            // Check if we have all required data
            if (!slabQuantity || !selectedShed || !selectedItem || !spotDate) {
                console.log('⏸️  Missing required data for yield calculation');
                if (yieldField.length) yieldField.val('');
                return;
            }

            // Make AJAX request for yield calculation
            let requestData = { date: spotDate };
            if (spotId) {
                requestData.spot_id = spotId;
                console.log('🎯 Making FILTERED request for spot ID:', spotId);
            } else {
                console.log('⚠️  Making UNFILTERED request (no spot ID found)');
            }

            console.log('🌐 AJAX Request:', '/adminapp/ajax/get-sheds-by-date/', requestData);

            $.ajax({
                url: "/adminapp/ajax/get-sheds-by-date/",
                data: requestData,
                success: function (response) {
                    console.log('✅ AJAX Response received:', response);
                    
                    let sheds = response.sheds || [];
                    console.log(`📦 Found ${sheds.length} shed records`);

                    if (sheds.length === 0) {
                        console.log('❌ No shed data available');
                        if (yieldField.length) yieldField.val('');
                        return;
                    }

                    // Log all available combinations
                    console.log('🔍 Available shed combinations:');
                    sheds.forEach((s, index) => {
                        console.log(`  ${index + 1}. Shed ID: ${s.shed_id} (${s.shed_name}) + Item ID: ${s.item_id} (${s.item_name}) = ${s.quantity_received_shed}kg`);
                    });

                    // Find matching combination
                    let found = sheds.find(s => 
                        String(s.shed_id) === String(selectedShed) && 
                        String(s.item_id) === String(selectedItem)
                    );

                    if (found) {
                        let receivedKg = parseFloat(found.quantity_received_shed) || 0;
                        let slabCount = slabQuantity;
                        let producedKg = slabCount * 2; // Each slab = 2kg
                        
                        // YIELD CALCULATION: (Produced KG / Received KG) × 100
                        let yieldPercent = 0;
                        if (receivedKg > 0) {
                            yieldPercent = (producedKg / receivedKg) * 100;
                        }
                        
                        console.log('🎉 YIELD CALCULATION SUCCESS!');
                        console.log(`  📦 Received at shed: ${receivedKg}kg (raw material)`);
                        console.log(`  🔢 Slabs entered: ${slabCount} slabs`);
                        console.log(`  ⚖️  Produced weight: ${slabCount} × 2kg = ${producedKg}kg`);
                        console.log(`  📊 Yield Formula: (${producedKg} ÷ ${receivedKg}) × 100 = ${yieldPercent.toFixed(2)}%`);
                        console.log(`  💡 Example: 250 slabs = 500kg from 11,000kg = 4.55% yield`);
                        
                        if (yieldField.length) {
                            yieldField.val(yieldPercent.toFixed(2));
                            // Visual feedback
                            yieldField.css('background-color', '#90EE90');
                            setTimeout(() => yieldField.css('background-color', ''), 2000);
                        } else {
                            console.log('❌ Yield field not found - cannot set result');
                        }
                    } else {
                        console.log('❌ No matching shed/item combination found');
                        console.log(`   Looking for: Shed ID ${selectedShed} + Item ID ${selectedItem}`);
                        if (yieldField.length) yieldField.val('');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('❌ AJAX Error:', error);
                    console.error('Response:', xhr.responseText);
                    if (yieldField.length) yieldField.val('');
                }
            });
        });

        // Debug: Show all form fields on page load
        console.log('🔎 DEBUGGING: All form fields on page:');
        $('input, select').each(function(index) {
            let name = $(this).attr('name') || 'no-name';
            let type = this.tagName.toLowerCase() + ($(this).attr('type') ? `[${$(this).attr('type')}]` : '');
            let value = $(this).val() || 'empty';
            console.log(`  ${index + 1}. ${type} name="${name}" value="${value}"`);
        });

        // Auto-populate spots when date changes
        $(document).on("change", "input[name*='date'], input[type='date']", function() {
            let selectedDate = $(this).val();
            console.log('📅 Date changed to:', selectedDate);
            
            if (selectedDate) {
                // Try to find and populate spot dropdown
                let spotSelect = $("select[name*='spot']:not([name*='date'])").first();
                if (spotSelect.length) {
                    console.log('🔄 Populating spot dropdown...');
                    $.ajax({
                        url: "/adminapp/ajax/get-spots-by-date/",
                        data: { date: selectedDate },
                        success: function(response) {
                            console.log('📋 Spots for date:', response);
                            
                            spotSelect.empty().append('<option value="">Select Spot Purchase</option>');
                            
                            if (response.spots && response.spots.length > 0) {
                                response.spots.forEach(spot => {
                                    spotSelect.append(`<option value="${spot.id}">
                                        ${spot.spot__location_name} - ${spot.voucher_number || spot.id}
                                    </option>`);
                                });
                                console.log(`✅ Added ${response.spots.length} spots to dropdown`);
                            }
                        },
                        error: function(err) {
                            console.error('❌ Error loading spots:', err);
                        }
                    });
                } else {
                    console.log('⚠️  No spot dropdown found to populate');
                }
            }
        });

        console.log('🚀 Yield calculation script loaded and ready!');
    });
    </script>

    <!-- Load grade with species -->
    <script>
    $(document).on("change", "select[name$='species']", function () {
        var speciesId = $(this).val();
        var $gradeSelect = $(this).closest(".formset-form").find("select[name$='grade']");

        if (speciesId) {
            $.ajax({
                url: "{% url 'adminapp:get_grade_for_species' %}",
                data: { "species_id": speciesId },
                dataType: "json",
                success: function (data) {
                    $gradeSelect.empty();
                    $gradeSelect.append($("<option>", { value: "", text: "---------" }));

                    $.each(data.grades, function (index, grade) {
                        $gradeSelect.append($("<option>", {
                            value: grade.id,
                            text: grade.grade
                        }));
                    });
                }
            });
        } else {
            $gradeSelect.empty();
            $gradeSelect.append($("<option>", { value: "", text: "---------" }));
        }
    });
    </script>

    <!-- Load grade with Item -->
    <script>
    $(document).ready(function () {
        console.log("Item → Grade script loaded");

        // When an item select changes
        $(document).on("change", 'select[name$="-item"], select[name="item"]', function () {
            const itemSelect = $(this);
            const itemId = itemSelect.val();
            const row = itemSelect.closest("tr");
            const gradeSelect = row.find("select[name$='-grade'], select[name='grade']");

            console.log("Item changed. Item ID:", itemId);

            // Reset grade dropdown
            gradeSelect.empty().append('<option value="">---------</option>');

            if (itemId) {
                console.log("Fetching grades for item:", itemId);

                $.get("{% url 'adminapp:get_item_grades' %}", { item_id: itemId })
                    .done(function (data) {
                        console.log("Grades received:", data);

                        // Handle both array and object response types
                        const grades = Array.isArray(data) ? data : data.grades || [];

                        if (grades.length > 0) {
                            grades.forEach(function (grade) {
                                gradeSelect.append(
                                    `<option value="${grade.id}">${grade.grade}</option>`
                                );
                            });
                            console.log(`Loaded ${grades.length} grades`);
                        } else {
                            console.log("No grades found for this item");
                        }
                    })
                    .fail(function (xhr, status, error) {
                        console.error("Error loading grades:", {
                            status: status,
                            error: error,
                            response: xhr.responseText,
                        });
                        gradeSelect.append('<option value="">Error loading grades</option>');
                    });
            } else {
                console.log("No item selected, grade dropdown reset");
            }
        });
    });
    </script>

    <!-- Load peeling and Species -->
    <script>
    $(document).ready(function () {
        console.log("Freezing Entry AJAX ready");

        // 🔹 Listen for item change inside each formset row
        $(document).on("change", ".item-select", function () {
            let itemId = $(this).val();
            let row = $(this).closest(".formset-form");

            if (!itemId) return;

            // 🔹 1. Fetch Species for this item
            $.ajax({
                url: "{% url 'adminapp:get_species_for_item' %}",
                data: { item_id: itemId },
                success: function (response) {
                    let speciesSelect = row.find(".species-select");
                    speciesSelect.empty().append('<option value="">---------</option>');
                    $.each(response.species, function (i, species) {
                        speciesSelect.append('<option value="' + species.id + '">' + species.name + '</option>');
                    });
                }
            });

            // 🔹 2. Fetch Peeling Types for this item
            $.ajax({
                url: "{% url 'adminapp:get_peeling_for_item' %}",
                data: { item_id: itemId },
                success: function (response) {
                    let peelingSelect = row.find(".peeling-select");
                    peelingSelect.empty().append('<option value="">---------</option>');
                    $.each(response.peeling_types, function (i, peeling) {
                        peelingSelect.append('<option value="' + peeling.id + '">' + peeling.name + '</option>');
                    });
                }
            });
        });
    });
    </script>

    <!-- F1 key shortcut for adding more items -->
    <script>
        $(document).ready(function() {
        $(document).on('keydown', function(e) {
            // Check if F1 key is pressed (keyCode 112)
            if (e.keyCode === 112 || e.which === 112) {
                e.preventDefault(); // Prevent browser's default F1 help
                $('#add-more-btn').click(); // Trigger the add more button
                return false;
            }
        });
    });
    </script>

    <!-- Delete key shortcut for removing the focused item -->
    <script>
    $(document).ready(function () {
        const formsetContainer = $("#formset-container");
        const totalForms = $("#id_form-TOTAL_FORMS");

        // Remove (event delegation so it works for new forms too)
        function removeForm(form) {
            if ($(".formset-form").length > 1) {
                form.remove();

                // Re-number forms
                let forms = $(".formset-form");
                totalForms.val(forms.length);
                forms.each(function (index) {
                    $(this).find("input, select, label").each(function () {
                        if ($(this).attr("name")) {
                            let name = $(this).attr("name").replace(/-\d+-/, "-" + index + "-");
                            $(this).attr("name", name);
                            $(this).attr("id", "id_" + name);
                        }
                        if ($(this).attr("for")) {
                            let newFor = $(this).attr("for").replace(/-\d+-/, "-" + index + "-");
                            $(this).attr("for", newFor);
                        }
                    });
                });
            } else {
                alert("At least one form is required.");
            }
        }

        // Click delete button
        $(document).on("click", ".remove-btn", function () {
            removeForm($(this).closest(".formset-form"));
        });

        // Keyboard Delete key
        $(document).on("keydown", function (e) {
            if (e.key === "Delete") {
                let activeElement = $(document.activeElement).closest(".formset-form");
                if (activeElement.length) {
                    e.preventDefault();
                    removeForm(activeElement);
                }
            }
        });
    });
    </script>

<!-- Arrow key navigation for form fields -->
    <script>
        $(document).ready(function() {
            // Get all focusable form elements
            function getFocusableElements() {
                return $('input:not([type="hidden"]), select, textarea').filter(':visible');
            }

            // Check if input type should navigate on arrow keys
            function shouldNavigate(element, direction) {
                const $elem = $(element);
                const inputType = $elem.attr('type');
                
                // Always navigate for select, date, and number inputs
                if ($elem.is('select') || inputType === 'date' || inputType === 'number') {
                    return true;
                }
                
                // For text inputs, check cursor position
                if ($elem.is('input') && inputType === 'text') {
                    try {
                        const cursorPos = element.selectionStart;
                        const valueLength = element.value.length;
                        
                        // Left arrow: navigate if cursor at beginning
                        if (direction === 'left' && cursorPos === 0) {
                            return true;
                        }
                        
                        // Right arrow: navigate if cursor at end
                        if (direction === 'right' && cursorPos === valueLength) {
                            return true;
                        }
                    } catch(e) {
                        // If selectionStart fails, just navigate
                        return true;
                    }
                }
                
                // For textarea, don't navigate (allow normal arrow key behavior)
                if ($elem.is('textarea')) {
                    return false;
                }
                
                return false;
            }

            $(document).on('keydown', 'input, select, textarea', function(e) {
                // Left arrow key (keyCode 37)
                if (e.keyCode === 37 || e.which === 37) {
                    if (shouldNavigate(this, 'left')) {
                        e.preventDefault();
                        let focusableElements = getFocusableElements();
                        let currentIndex = focusableElements.index(this);
                        
                        // Move to previous field
                        if (currentIndex > 0) {
                            focusableElements.eq(currentIndex - 1).focus().select();
                        }
                        return false;
                    }
                }
                
                // Right arrow key (keyCode 39)
                if (e.keyCode === 39 || e.which === 39) {
                    if (shouldNavigate(this, 'right')) {
                        e.preventDefault();
                        let focusableElements = getFocusableElements();
                        let currentIndex = focusableElements.index(this);
                        
                        // Move to next field
                        if (currentIndex < focusableElements.length - 1) {
                            focusableElements.eq(currentIndex + 1).focus().select();
                        }
                        return false;
                    }
                }
            });
        });
    </script>

<!-- Limit date input year to 4 digits -->
<script>
$(document).ready(function() {
    $(document).on('input','input[type="date"]',function(){
        let d=$(this).val();
        // Only check if we have at least the year part (first 4 characters)
        if(d && d.length>=4){
            let y=parseInt(d.substring(0,4));
            // Only validate if year has 4 digits AND is complete
            if(d.length>=4 && y.toString().length===4){
                if(y<1900||y>2100){
                    // Clear only the year part, allow user to re-enter
                    $(this).val('');
                }
            }
        }
    });
    
    // Final validation on blur
    $(document).on('blur','input[type="date"]',function(){
        let d=$(this).val();
        if(d && d.length===10){
            let y=parseInt(d.split('-')[0]);
            if(y<1900||y>2100){
                alert('Please enter a valid year (1900-2100)');
                $(this).val('');
            }
        }
    });
});
</script>

<!-- Add this script at the bottom of your template before </body> -->
<script>
    // Fetch dollar rate on page load
    async function fetchDollarRate() {
        try {
            const response = await fetch("{% url 'adminapp:get_dollar_rate_local' %}");
            const data = await response.json();
            
            if (data.dollar_rate_to_inr) {
                document.getElementById('dollarRateDisplay').textContent = 
                    `$1 = ₹${parseFloat(data.dollar_rate_to_inr).toFixed(2)}`;
            } else if (data.error) {
                document.getElementById('dollarRateDisplay').textContent = '$ (Rate not set)';
            }
        } catch (error) {
            console.error('Error fetching dollar rate:', error);
            document.getElementById('dollarRateDisplay').textContent = '$ (Rate not set)';
        }
    }
    
    // Call on page load
    document.addEventListener('DOMContentLoaded', fetchDollarRate);
</script>



{%endblock%}