{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Pre-Shipment WorkOut & Summary</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">

    <h2 class="mb-4">Freezing Workout Summary</h2>

    <!-- Filter Form in Table Design -->
    <form method="get" class="mb-4">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Packing Unit</th>
                    <th>Glaze %</th>
                    <th>Freezing Category</th>
                    <th>Brand</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <select name="item" id="item" class="form-select">
                            <option value="">All</option>
                            {% for obj in items %}
                                <option value="{{ obj.id }}" {% if request.GET.item == obj.id|stringformat:"s" %}selected{% endif %}>
                                    {{ obj.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select name="unit" id="unit" class="form-select">
                            <option value="">All</option>
                            {% for obj in units %}
                                <option value="{{ obj.id }}" {% if request.GET.unit == obj.id|stringformat:"s" %}selected{% endif %}>
                                    {{ obj.unit_code }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select name="glaze" id="glaze" class="form-select">
                            <option value="">All</option>
                            {% for obj in glazes %}
                                <option value="{{ obj.id }}" {% if request.GET.glaze == obj.id|stringformat:"s" %}selected{% endif %}>
                                    {{ obj.percentage }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select name="category" id="category" class="form-select">
                            <option value="">All</option>
                            {% for obj in categories %}
                                <option value="{{ obj.id }}" {% if request.GET.category == obj.id|stringformat:"s" %}selected{% endif %}>
                                    {{ obj.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select name="brand" id="brand" class="form-select">
                            <option value="">All</option>
                            {% for obj in brands %}
                                <option value="{{ obj.id }}" {% if request.GET.brand == obj.id|stringformat:"s" %}selected{% endif %}>
                                    {{ obj.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <button type="submit" class="btn btn-primary">Filter</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </form>

    <!-- Summary Table -->
    {% if combined_summary %}
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>Item</th>
                        <th>Grade</th>
                        <th>Species</th>
                        <th>Peeling Type</th>
                        <th>Brand</th>
                        <th>Glaze %</th>
                        <th>Packing Unit</th>
                        <th>Category</th>
                        <th>Total Slab</th>
                        <th>Total C/S</th>
                        <th>Total KG</th>
                        <th>Total USD</th>
                        <th>Total INR</th>
                        <th>Avg Yield %</th>
                        <th>Avg USD Rate/KG</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in combined_summary %}
                        <tr>
                            <td>{{ row.item_name }}</td>
                            <td>{{ row.grade_name }}</td>
                            <td>{{ row.species_name }}</td>
                            <td>{{ row.peeling_type_name }}</td>
                            <td>{{ row.brand_name }}</td>
                            <td>{{ row.glaze_percentage }}</td>
                            <td>{{ row.unit_code }}</td>
                            <td>{{ row.freezing_category_name }}</td>
                            <td>{{ row.total_slab }}</td>
                            <td>{{ row.total_c_s }}</td>
                            <td>{{ row.total_kg }}</td>
                            <td>{{ row.total_usd }}</td>
                            <td>{{ row.total_inr }}</td>
                            <td>{{ row.avg_yield|floatformat:2 }}</td>
                            <td>{{ row.avg_usd_per_kg|floatformat:2 }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-warning text-center">
            No items found for the selected filters.
        </div>
    {% endif %}

    <hr>

    <h2 class="mb-4">Create Pre-Shipment WorkOut</h2>

<form method="post">
    {% csrf_token %}

    <!-- Main Workout Form -->
    <table class="table table-bordered table-sm mb-4">
        <thead class="table-light">
            <tr>
                <th>Item</th>
                <th>Packing Unit</th>
                <th>Glaze %</th>
                <th>Category</th>
                <th>Brand</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <select id="id_item" name="item" class="form-select">
                        <option value="">---------</option>
                        {% for obj in items %}
                            <option value="{{ obj.id }}"
                                {% if workout_form.item.value == obj.id|stringformat:"s" %}selected{% endif %}>
                                {{ obj.name }}
                            </option>
                        {% endfor %}
                    </select>
                </td>
                <td>{{ workout_form.unit }}</td>
                <td>{{ workout_form.glaze }}</td>
                <td>{{ workout_form.category }}</td>
                <td>{{ workout_form.brand }}</td>
            </tr>
        </tbody>
    </table>


    <!-- Items Formset -->
    {{ formset.management_form }}
    <table id="formset-table" class="table table-bordered table-sm">
        <thead>
            <tr>
                <th>Species</th>
                <th>Peeling</th>
                <th>Grade</th>
                <th>Cartons</th>
                <th>Quantity</th>
                <th> $ KG</th>
                <th> $ Item</th>
                <th>₹ Item</th>
                <th>$ KG-Get</th>
                <th>$ Item-Get</th>
                <th>₹ Item-Get</th>
                <th>Profit</th>
                <th>Loss</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="formset-body">
            {% for form in formset %}
                <tr class="form-row">
                    <td>{{ form.species }}</td>
                    <td>{{ form.peeling_type }}</td>
                    <td>{{ form.grade }}</td>
                    <td>{{ form.cartons }}</td>
                    <td>{{ form.quantity }}</td>
                    <td>{{ form.usd_rate_per_kg }}</td>
                    <td>{{ form.usd_rate_item }}</td>
                    <td>{{ form.usd_rate_item_to_inr }}</td>
                    <td>{{ form.usd_rate_per_kg_get }}</td>
                    <td>{{ form.usd_rate_item_get }}</td>
                    <td>{{ form.usd_rate_item_to_inr_get }}</td>
<td>
<input type="hidden" name="{{ form.profit.name }}" class="profit"><span class="profit-display"></span>
</td>
<td>
<input type="hidden" name="{{ form.loss.name }}" class="loss"><span class="loss-display"></span>
</td>

                    <td>
                        <button type="button" class="btn btn-danger btn-sm remove-row">Remove</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Add & Save Buttons -->
    <div class="text-center">
    <button type="button" class="btn btn-warnnig"><a href="{% url 'adminapp:preshipment_workout_list' %}">Old Summary</a> </button>
    <button type="button" id="add-row" class="btn btn-primary">Add More</button>
    <button type="submit" class="btn btn-success">Save</button>
    </div>
</form>


    <!-- Hidden empty form template -->

        <table style="display:none;">
            <tbody>
                <tr id="empty-form" class="form-row">
                    <td>{{ formset.empty_form.species }}</td>
                    <td>{{ formset.empty_form.peeling_type }}</td>
                    <td>{{ formset.empty_form.grade }}</td>
                    <td>{{ formset.empty_form.cartons }}</td>
                    <td>{{ formset.empty_form.quantity }}</td>
                    <td>{{ formset.empty_form.usd_rate_per_kg }}</td>
                    <td>{{ formset.empty_form.usd_rate_item }}</td>
                    <td>{{ formset.empty_form.usd_rate_item_to_inr }}</td>
                    <td>{{ formset.empty_form.usd_rate_per_kg_get }}</td>
                    <td>{{ formset.empty_form.usd_rate_item_get }}</td>
                    <td>{{ formset.empty_form.usd_rate_item_to_inr_get }}</td>
            <!-- Profit -->
            <td>
                <input type="hidden" name="{{ formset.empty_form.profit.name }}" class="profit">
                <span class="profit-display text-success"></span>
            </td>

            <!-- Loss -->
            <td>
                <input type="hidden" name="{{ formset.empty_form.loss.name }}" class="loss">
                <span class="loss-display text-danger"></span>
            </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm remove-row">Remove</button>
                    </td>
                </tr>
            </tbody>
        </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const addButton = document.getElementById("add-row");
    const formsetBody = document.getElementById("formset-body");
    const totalForms = document.getElementById("id_items-TOTAL_FORMS");
    const emptyFormTemplate = document.getElementById("empty-form").outerHTML;

    // Add new row
    addButton.addEventListener("click", function () {
        let formIndex = parseInt(totalForms.value);
        let template = document.getElementById("empty-form").cloneNode(true);

        // Remove ID & hidden styles
        template.removeAttribute("id");
        template.style.display = ""; // show it

        // Replace prefix in all inputs/selects
        template.querySelectorAll("input, select, textarea").forEach(input => {
            input.name = input.name.replace(/__prefix__/, formIndex);
            input.id = input.id.replace(/__prefix__/, formIndex);
        });

        formsetBody.appendChild(template);
        totalForms.value = formIndex + 1;
    });


    // Remove row
    formsetBody.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-row")) {
            e.preventDefault();
            let row = e.target.closest(".form-row");
            if (row) {
                row.remove();
                let formRows = formsetBody.querySelectorAll(".form-row");
                totalForms.value = formRows.length;

                // Re-index all rows
                formRows.forEach((row, index) => {
                    row.querySelectorAll("input, select, textarea").forEach(input => {
                        input.name = input.name.replace(/items-\d+-/, `items-${index}-`);
                        input.id = input.id.replace(/id_items-\d+-/, `id_items-${index}-`);
                    });
                });
            }
        }
    });

    // Species change → load grades (works for both existing and added rows)
    formsetBody.addEventListener("change", function (e) {
        if (e.target.name.endsWith("species")) {
            let speciesId = e.target.value;
            let row = e.target.closest(".form-row");
            let gradeSelect = row.querySelector("select[name$='grade']");

            if (speciesId) {
                fetch("{% url 'adminapp:get_grade_for_species' %}?species_id=" + speciesId)
                    .then(response => response.json())
                    .then(data => {
                        gradeSelect.innerHTML = '<option value="">---------</option>';
                        data.grades.forEach(grade => {
                            let opt = document.createElement("option");
                            opt.value = grade.id;
                            opt.textContent = grade.grade;
                            gradeSelect.appendChild(opt);
                        });
                    });
            } else {
                gradeSelect.innerHTML = '<option value="">---------</option>';
            }
        }
    });
});
</script>


<!--  load species -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function(){
    $("#id_item").change(function(){
        var itemId = $(this).val();

        if (itemId) {
            $.ajax({
                url: "{% url 'adminapp:get_species_for_item' %}",
                data: {
                    "item_id": itemId
                },
                dataType: "json",
                success: function(data){
                    // Update all species dropdowns in the formset
                    $(".form-row select[name$='species']").each(function(){
                        var $speciesSelect = $(this);
                        $speciesSelect.empty(); // clear existing
                        $speciesSelect.append($("<option>", {value: "", text: "---------"}));

                        $.each(data.species, function(index, species){
                            $speciesSelect.append($("<option>", {
                                value: species.id,
                                text: species.name
                            }));
                        });
                    });
                }
            });
        }
    });
});
</script>

<!--  load peeling type -->
<script>
    $(document).ready(function(){
    $("#id_item").change(function(){
        var itemId = $(this).val();

        if (itemId) {
            $.ajax({
                url: "{% url 'adminapp:get_peeling_for_item' %}",
                data: {
                    "item_id": itemId
                },
                dataType: "json",
                success: function(data){
                    $(".form-row select[name$='peeling_type']").each(function(){
                        var $peelingSelect = $(this);
                        $peelingSelect.empty();
                        $peelingSelect.append($("<option>", {value: "", text: "---------"}));

                        $.each(data.peeling_types, function(index, peeling){
                            $peelingSelect.append($("<option>", {
                                value: peeling.id,
                                text: peeling.name
                            }));
                        });
                    });
                }
            });
        }
    });
});
</script>

<!--  load grade -->
<script>
    $(document).on("change", "select[name$='species']", function(){
    var speciesId = $(this).val();
    var $gradeSelect = $(this).closest(".form-row").find("select[name$='grade']");

    if (speciesId) {
        $.ajax({
            url: "{% url 'adminapp:get_grade_for_species' %}",
            data: { "species_id": speciesId },
            dataType: "json",
            success: function(data){
                $gradeSelect.empty();
                $gradeSelect.append($("<option>", { value: "", text: "---------" }));

                $.each(data.grades, function(index, grade){
                    $gradeSelect.append($("<option>", {
                        value: grade.id,
                        text: grade.grade
                    }));
                });
            }
        });
    } else {
        $gradeSelect.empty();
        $gradeSelect.append($("<option>", { value: "", text: "---------" }));
    }
});

</script>

<!-- load both peeling and species by row  -->
<script>
    function bindSpeciesAndPeelingEvents(row) {
    row.find('.item-select').on('change', function () {
        let itemId = $(this).val();
        let speciesSelect = row.find('.species-select');
        let peelingSelect = row.find('.peeling-select');

        // Species AJAX
        $.get('/adminapp/get-species/', { item_id: itemId }, function (data) {
            speciesSelect.empty().append('<option value="">---------</option>');
            data.species.forEach(s => {
                speciesSelect.append(`<option value="${s.id}">${s.name}</option>`);
            });
        });

        // Peeling AJAX
        $.get('/adminapp/get-peeling/', { item_id: itemId }, function (data) {
            peelingSelect.empty().append('<option value="">---------</option>');
            data.peeling.forEach(p => {
                peelingSelect.append(`<option value="${p.id}">${p.name}</option>`);
            });
        });
    });
}

</script>

<!-- cartons calculation -->
<script>
document.addEventListener("input", function (e) {
    if (e.target && e.target.name.includes("cartons")) {
        let cartonsInput = e.target;
        let quantityInput = cartonsInput
            .closest("tr")
            .querySelector("input[name$='quantity']");

        let cartons = parseFloat(cartonsInput.value) || 0;
        quantityInput.value = (cartons * 20).toFixed(2); // 20 kg per carton
    }
});
</script>

<!-- USD Rate per KG changes -->
<script>
document.addEventListener("input", function (e) {
    let target = e.target;

    // Update quantity if cartons changes
    if (target.name.includes("cartons")) {
        let row = target.closest("tr");
        let cartons = parseFloat(target.value) || 0;
        let quantityInput = row.querySelector("input[name$='quantity']");
        quantityInput.value = (cartons * 20).toFixed(2); // 1 carton = 20 kg

        // Trigger USD item calculation after quantity updates
        let ratePerKgInput = row.querySelector("input[name$='usd_rate_per_kg']");
        if (ratePerKgInput.value) {
            let rateItemInput = row.querySelector("input[name$='usd_rate_item']");
            let ratePerKg = parseFloat(ratePerKgInput.value) || 0;
            rateItemInput.value = (parseFloat(quantityInput.value) * ratePerKg).toFixed(2);
        }
    }

    // Update USD Rate Item if rate per KG changes
    if (target.name.includes("usd_rate_per_kg")) {
        let row = target.closest("tr");
        let quantityInput = row.querySelector("input[name$='quantity']");
        let rateItemInput = row.querySelector("input[name$='usd_rate_item']");

        let quantity = parseFloat(quantityInput.value) || 0;
        let ratePerKg = parseFloat(target.value) || 0;

        rateItemInput.value = (quantity * ratePerKg).toFixed(2);
    }
});
</script>

<!-- USD to INR calculation -->
<script>
        let dollarRateToInr = 0;

    // Fetch the dollar rate from your view
    $.ajax({
        url: "{% url 'adminapp:get_dollar_rate_pre_workout' %}",
        method: "GET",
        success: function(response) {
            if (response.dollar_rate_to_inr) {
                dollarRateToInr = parseFloat(response.dollar_rate_to_inr);
            }
        }
    });

    // Recalculate USD → INR for a row
    function recalcUsdToInr($row) {
        // Quantity
        let quantity = parseFloat($row.find("input[name$='quantity']").val()) || 0;

        // Selling rate/kg → USD item
        let usdRateKg = parseFloat($row.find("input[name$='usd_rate_per_kg']").val()) || 0;
        let usdItem = quantity * usdRateKg;
        $row.find("input[name$='usd_rate_item']").val(usdItem.toFixed(2));

        // Selling USD → INR
        $row.find("input[name$='usd_rate_item_to_inr']").val((usdItem * dollarRateToInr).toFixed(2));

        // Buying rate/kg → USD item get
        let usdRateKgGet = parseFloat($row.find("input[name$='usd_rate_per_kg_get']").val()) || 0;
        let usdItemGet = quantity * usdRateKgGet;
        $row.find("input[name$='usd_rate_item_get']").val(usdItemGet.toFixed(2));

        // Buying USD → INR
        $row.find("input[name$='usd_rate_item_to_inr_get']").val((usdItemGet * dollarRateToInr).toFixed(2));
    }

    // Event listeners: trigger recalculation on quantity, selling rate, or buying rate input
    $(document).on("input", "input[name$='quantity'], input[name$='usd_rate_per_kg'], input[name$='usd_rate_per_kg_get']", function() {
        let $row = $(this).closest("tr");
        recalcUsdToInr($row);
    });
</script>

<!-- loss / profit  -->
<script>
    $(document).ready(function() {
        let dollarRateToInr = 0;

        // Fetch dollar rate
        $.ajax({
            url: "{% url 'adminapp:get_dollar_rate_pre_workout' %}",
            method: "GET",
            success: function(response) {
                if (response.dollar_rate_to_inr) {
                    dollarRateToInr = parseFloat(response.dollar_rate_to_inr);
                }
            }
        });

        function recalcProfitLoss($row) {
            let buyingInr = parseFloat($row.find(".usd-rate-item-inr").val()) || 0;
            let sellingInr = parseFloat($row.find(".usd-rate-item-inr-get").val()) || 0;

            let profitInput = $row.find(".profit");       // hidden or readonly input
            let lossInput = $row.find(".loss");           // hidden or readonly input
            let profitDisplay = $row.find(".profit-display");
            let lossDisplay = $row.find(".loss-display");

            let diff = sellingInr - buyingInr;

            if (diff >= 0) {
                profitInput.val(diff.toFixed(2));
                profitDisplay.text("+" + diff.toFixed(2)).css("color", "green");
                lossInput.val(0);
                lossDisplay.text("");
            } else {
                profitInput.val(0);
                profitDisplay.text("");
                lossInput.val(Math.abs(diff).toFixed(2));
                lossDisplay.text("-" + Math.abs(diff).toFixed(2)).css("color", "red");
            }
        }


        function recalcRow($row) {
            let cartons = parseFloat($row.find(".cartons").val()) || 0;
            let quantity = cartons * 20;
            $row.find(".quantity").val(quantity.toFixed(2));

            // Buying
            let usdRateKg = parseFloat($row.find(".usd-rate-per-kg").val()) || 0;
            let usdItem = quantity * usdRateKg;
            $row.find(".usd-rate-item").val(usdItem.toFixed(2));
            $row.find(".usd-rate-item-inr").val((usdItem * dollarRateToInr).toFixed(2));

            // Selling
            let usdRateKgGet = parseFloat($row.find(".usd-rate-per-kg-get").val()) || 0;
            let usdItemGet = quantity * usdRateKgGet;
            $row.find(".usd-rate-item-get").val(usdItemGet.toFixed(2));
            $row.find(".usd-rate-item-inr-get").val((usdItemGet * dollarRateToInr).toFixed(2));

            recalcProfitLoss($row);
        }

        // Trigger recalculation on input changes
        $(document).on("input", ".cartons, .usd-rate-per-kg, .usd-rate-per-kg-get", function() {
            let $row = $(this).closest("tr");
            recalcRow($row);
        });

        // Recalc on page load
        $("#formset-table tbody tr").each(function() {
            recalcRow($(this));
        });
    });
</script>

</body>
</html>
