{% extends 'admin_base.html' %}

{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">


<!-- Page header style -->
<style>
  /* ===== PAGE HEADER STYLES ONLY (Prefixed with ph-) ===== */
  :root {
    --ph-primary-color: #2563eb;
    --ph-primary-hover: #1d4ed8;
    --ph-secondary-color: #64748b;
    --ph-bg-secondary: #f8fafc;
    --ph-bg-tertiary: #f1f5f9;
    --ph-bg-accent: #e2e8f0;
    --ph-text-primary: #0f172a;
    --ph-text-secondary: #4a4a4a;
    --ph-text-light: #94a3b8;
    --ph-border-color: #e2e8f0;
    --ph-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --ph-radius-sm: 8px;
    --ph-radius-md: 12px;
    --ph-radius-lg: 16px;
    --ph-spacing-xs: 8px;
    --ph-spacing-sm: 12px;
    --ph-spacing-md: 16px;
    --ph-spacing-lg: 24px;
    --ph-spacing-xl: 32px;
    --ph-spacing-2xl: 48px;
  }

  /* Page Header Section */
  .page-header-section {
    margin-bottom: var(--ph-spacing-2xl);
  }

  .ph-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--ph-spacing-lg);
  }

  .ph-header-left {
    display: flex;
    align-items: center;
    gap: var(--ph-spacing-md);
    flex-shrink: 0;
  }

  .ph-icon-wrapper {
    width: 64px;
    height: 64px;
    background: var(--ph-primary-color);
    border-radius: var(--ph-radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    box-shadow: var(--ph-shadow-lg);
    flex-shrink: 0;
  }

  .ph-header-text {
    flex: 1;
  }

  .ph-header-title {
    font-weight: 500;
    font-size: 28px;
    color: #2c3e50;
    margin: 0 0 4px 0;
    letter-spacing: -0.02em;
  }

  .ph-header-subtitle {
    font-size: 16px;
    color: var(--ph-text-secondary);
    margin: 0;
    font-weight: 500;
  }

  .ph-header-stats {
    margin-left: auto;
  }

  .ph-stat-badge {
    display: flex;
    align-items: center;
    padding: var(--ph-spacing-sm) var(--ph-spacing-md);
    background: var(--ph-bg-tertiary);
    border: 2px solid var(--ph-border-color);
    border-radius: var(--ph-radius-md);
    font-weight: 600;
    color: var(--ph-text-secondary);
    font-size: 14px;
  }

  /* Breadcrumbs */
  .ph-breadcrumb-nav {
    margin-top: 3rem;
  }

  .ph-breadcrumb-list {
    display: flex;
    align-items: center;
    margin: 0;
    padding: 0;
    list-style: none;
    flex-wrap: wrap;
  }

  .ph-breadcrumb-item {
    display: flex;
    align-items: center;
  }

  .ph-breadcrumb-link {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--ph-bg-secondary);
    border-radius: var(--ph-radius-sm);
    text-decoration: none;
    color: var(--ph-text-secondary);
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }

  .ph-breadcrumb-link:hover {
    background: var(--ph-bg-accent);
    color: var(--ph-text-primary);
    border-color: var(--ph-border-color);
  }

  .ph-breadcrumb-item.active span {
    color: var(--ph-primary-color);
    font-weight: 600;
    padding: 6px 12px;
    background: rgba(37, 99, 235, 0.1);
    border-radius: var(--ph-radius-sm);
    font-size: 14px;
  }

  .ph-breadcrumb-separator {
    color: var(--ph-text-light);
    margin: 0 4px;
    font-size: 12px;
  }

  @media (max-width: 768px) {
    .ph-header-stats {
      display: none !important;
    }
    .ph-breadcrumb-nav {
      margin-top: 5px;
    }
    .ph-header-title {
      font-size: 1.7rem;
    }
  }
</style>

<style>
/* Page Header Styles */
:root {
    --ph-primary-color: #2563eb;
    --ph-primary-hover: #1d4ed8;
    --ph-secondary-color: #64748b;
    --ph-bg-secondary: #f8fafc;
    --ph-bg-tertiary: #f1f5f9;
    --ph-bg-accent: #e2e8f0;
    --ph-text-primary: #0f172a;
    --ph-text-secondary: #4a4a4a;
    --ph-text-light: #94a3b8;
    --ph-border-color: #e2e8f0;
    --ph-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --ph-radius-sm: 8px;
    --ph-radius-md: 12px;
    --ph-radius-lg: 16px;
    --ph-spacing-xs: 8px;
    --ph-spacing-sm: 12px;
    --ph-spacing-md: 16px;
    --ph-spacing-lg: 24px;
    --ph-spacing-xl: 32px;
    --ph-spacing-2xl: 48px;
}


/* Form Card Styling */
.form-card {
    border-radius: 20px;
    background: #ffffff;
    box-shadow: 0 10px 40px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
    margin-bottom: 2rem;
}

.card-header {
    background: linear-gradient(135deg, #f8f9fd 0%, #ffffff 100%);
    border-bottom: 2px solid #f1f3f7;
    padding: 25px 30px;
    border-radius: 20px 20px 0 0;
}

.icon-wrapper {
    width: 60px;
    height: 60px;
    background: #007bff;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    box-shadow: 0 8px 25px rgba(0, 123, 255, 0.2);
}

.card-title {
    font-size: 26px;
    color: #2c3e50;
    letter-spacing: -0.5px;
    margin-bottom: 0;
}

.card-header p {
    color: #6c757d;
    font-size: 14px;
    margin: 0;
}

/* Stock Display Alerts */
#currentStockDisplay, #newStockDisplay {
    animation: fadeIn 0.5s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Table Styling */
.adjustment-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 0;
}

.adjustment-table thead th {
    background: #007bff;
    font-weight: 600;
    color: #ffffff;
    text-transform: uppercase;
    font-size: 12px;
    padding: 12px !important;
    border: none;
    
}

.adjustment-table tbody td {

    text-align: left;
    border-bottom: 1px solid #f1f3f7;
    vertical-align: middle;
    
}

.adjustment-table tbody tr:hover {
    background: linear-gradient(135deg, rgba(0, 123, 255, 0.02) 0%, rgba(0, 123, 255, 0.05) 100%);
}

.adjustment-table input,
.adjustment-table select,
.adjustment-table textarea {
    padding: 12px 15px !important;
    border: 2px solid #e9ecef !important;
    border-radius: 12px !important;
    font-size: 14px !important;
    margin-bottom: .5rem !important;
    font-weight: 500 !important;
    background: #ffffff !important;
    transition: all 0.3s ease !important;
    width: 100% !important;
    box-sizing: border-box;
}

.adjustment-table input:focus,
.adjustment-table select:focus,
.adjustment-table textarea:focus {
    border-color: #007bff !important;
    box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1) !important;
    outline: none !important;
}

/* Border colors for adjustment inputs */
.border-success {
    border-color: #28a745 !important;
    border-width: 2px !important;
}

.border-danger {
    border-color: #dc3545 !important;
    border-width: 2px !important;
}

.border-warning {
    border-color: #ffc107 !important;
    border-width: 2px !important;
}

.location-disabled {
    opacity: 0.5;
    pointer-events: none;
}

/* Form Actions */
.form-actions {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 40px;
}

.form-actions .row {
  width: 100%;
}


.submit-btn {
    background: #007bff;
    color: white;
    border: 2px solid #007bff;
    padding: 15px 40px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    text-decoration: none;
    width: 100%;
}

.submit-btn:hover {
    background: #0056b3;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
}

.cancel-btn {
    background: #dc3545;
    color: white;
    border: 2px solid #dc3545;
    padding: 15px 40px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    width: 100%;
}

.cancel-btn:hover {
    background: #c82333;
    color: white;
    text-decoration: none;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
}

/* Validation Errors */
.validation-error, .text-danger {
    color: #dc3545;
    font-size: 12px;
    margin-top: 5px;
    font-weight: 500;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .adjustment-table {
        display: block;
        width: 100%;
    }
    
    .adjustment-table thead {
        display: none;
    }
    
    .adjustment-table tbody,
    .adjustment-table tr,
    .adjustment-table td {
        display: block;
        width: 100%;
    }
    
    .adjustment-table tr {
        margin-bottom: 15px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        background: #f8f9fd;
    }
    
    .adjustment-table td {
        border: none !important;
        padding: 10px 0 !important;
    }
    
    .adjustment-table td:before {
        content: attr(data-label);
        font-weight: 600;
        display: block;
        margin-bottom: 5px;
        color: #495057;
        font-size: 12px;
        text-transform: uppercase;
    }
}
</style>

<div class="container">
    <div class="page-inner">
    <div class="page-header-section">
      <div class="ph-header-content">
        <div class="ph-header-left">
          <div class="ph-icon-wrapper">
            <i class="fas fa-boxes"></i>
          </div>
          <div class="ph-header-text">
            <h3 class="ph-header-title">Tenant Stock Adjustment</h3>
            <p class="ph-header-subtitle">Adjust tenant stock quantities</p>
          </div>
        </div>

        <!-- Breadcrumbs -->
        <nav class="ph-breadcrumb-nav">
          <ol class="ph-breadcrumb-list">
            <li class="ph-breadcrumb-item">
              <a href="#" class="ph-breadcrumb-link">
                <i class="icon-home"></i>
                <span>Home</span>
              </a>
            </li>
            <li class="ph-breadcrumb-separator">
              <i class="icon-arrow-right"></i>
            </li>
            <li class="ph-breadcrumb-item">
              <a href="{% url 'adminapp:tenant_stock_list' %}" class="ph-breadcrumb-link">
                <i class="fas fa-warehouse"></i>
                <span>Tenant Stock </span>
              </a>
            </li>
            <li class="ph-breadcrumb-separator">
              <i class="icon-arrow-right"></i>
            </li>
            <li class="ph-breadcrumb-item active">
              <span>Adjustment</span>
            </li>
          </ol>
        </nav>
        <div class="ph-header-stats"></div>
      </div>
    </div>

        <form method="post" id="tenantStockAdjustmentForm" style="margin-top: 2rem;">
            {% csrf_token %}
            
            <!-- Display form errors -->
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <!-- Current Stock Display -->
            <div id="currentStockDisplay" class="alert alert-warning mb-4" style="display: none;">
                <h6 class="alert-heading">
                    <i class="fas fa-warehouse me-2"></i>Current Tenant Stock for Selected Combination:
                </h6>
                <div class="row">
                    <div class="col-md-4">
                        <strong>Slab:</strong> <span id="currentSlab" class="fs-5 text-primary">0</span>
                    </div>
                    <div class="col-md-4">
                        <strong>CS:</strong> <span id="currentCS" class="fs-5 text-primary">0</span>
                    </div>
                    <div class="col-md-4">
                        <strong>KG:</strong> <span id="currentKG" class="fs-5 text-primary">0</span>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <small class="text-muted">
                            <i class="fas fa-arrow-right me-1"></i>
                            After adjustment: 
                            <strong>Slab: <span id="afterSlab">0</span></strong> | 
                            <strong>CS: <span id="afterCS">0</span></strong> | 
                            <strong>KG: <span id="afterKG">0</span></strong>
                        </small>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Original quantities - Slab: <span id="originalSlab">0</span>, 
                            CS: <span id="originalCS">0</span>, 
                            KG: <span id="originalKG">0</span>
                        </small>
                    </div>
                </div>
            </div>

            <div id="newStockDisplay" class="alert alert-success mb-4" style="display: none;">
                <h6 class="alert-heading">
                    <i class="fas fa-plus-circle me-2"></i>New Tenant Stock Will Be Created
                </h6>
                <p class="mb-0">This combination does not exist. A new tenant stock entry will be created with your adjustment values.</p>
            </div>

            <!-- Stock Details Table -->
            <div class="form-card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper me-4">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div>
                            <h3 class="card-title">Stock Details</h3>
                            <p class="text-muted mb-0">Select the stock item to adjust</p>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="adjustment-table">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-building me-1"></i> Tenant</th>
                                    <th><i class="fas fa-industry me-1"></i> PR Center</th>
                                    <th><i class="fas fa-store me-1"></i> Store</th>
                                    <th><i class="fas fa-trademark me-1"></i> Brand</th>
                                    <th><i class="fas fa-tag me-1"></i> Item</th>
                                    <th><i class="fas fa-star me-1"></i> Quality</th>
                                    <th><i class="fas fa-list me-1"></i> Category</th>
                                    <th><i class="fas fa-ruler me-1"></i> Unit</th>
                                    <th><i class="fas fa-sparkles me-1"></i> Glaze</th>
                                    <!-- <th><i class="fas fa-fish me-1"></i> Species</th> -->
                                    <th><i class="fas fa-certificate me-1"></i> Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td data-label="Tenant">
                                        {{ form.tenant_company_name }}
                                        {% if form.tenant_company_name.errors %}
                                            <div class="validation-error">{{ form.tenant_company_name.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td data-label="PR Center">
                                        {{ form.processing_center }}
                                        {% if form.processing_center.errors %}
                                            <div class="validation-error">{{ form.processing_center.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td data-label="Store">
                                        {{ form.store }}
                                        {% if form.store.errors %}
                                            <div class="validation-error">{{ form.store.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td data-label="Brand">
                                        {{ form.brand }}
                                        {% if form.brand.errors %}
                                            <div class="validation-error">{{ form.brand.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td data-label="Item">
                                        {{ form.item }}
                                        {% if form.item.errors %}
                                            <div class="validation-error">{{ form.item.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td data-label="Quality">
                                        {{ form.item_quality }}
                                        {% if form.item_quality.errors %}
                                            <div class="validation-error">{{ form.item_quality.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td data-label="Category">
                                        {{ form.freezing_category }}
                                        {% if form.freezing_category.errors %}
                                            <div class="validation-error">{{ form.freezing_category.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td data-label="Unit">
                                        {{ form.unit }}
                                        {% if form.unit.errors %}
                                            <div class="validation-error">{{ form.unit.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td data-label="Glaze">
                                        {{ form.glaze }}
                                        {% if form.glaze.errors %}
                                            <div class="validation-error">{{ form.glaze.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <!-- <td data-label="Species">
                                        {{ form.species }}
                                        {% if form.species.errors %}
                                            <div class="validation-error">{{ form.species.errors }}</div>
                                        {% endif %}
                                    </td> -->
                                    <td data-label="Grade">
                                        {{ form.grade }}
                                        {% if form.grade.errors %}
                                            <div class="validation-error">{{ form.grade.errors }}</div>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stock Adjustment Section -->
            <div class="form-card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper me-4">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <div>
                            <h3 class="card-title">Stock Adjustment</h3>
                            <p class="text-muted mb-0">Enter positive values to increase, negative to decrease</p>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="adjustment-table">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-layer-group me-1"></i> Slab Adjustment</th>
                                    <th><i class="fas fa-cubes me-1"></i> CS Adjustment</th>
                                    <th><i class="fas fa-weight me-1"></i> KG Adjustment</th>
                                    <th><i class="fas fa-comment me-1"></i> Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td data-label="Slab Adjustment">
                                        {{ form.slab_adjustment }}
                                        {% if form.slab_adjustment.errors %}
                                            <div class="validation-error">{{ form.slab_adjustment.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td data-label="CS Adjustment">
                                        {{ form.cs_adjustment }}
                                        {% if form.cs_adjustment.errors %}
                                            <div class="validation-error">{{ form.cs_adjustment.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td data-label="KG Adjustment">
                                        {{ form.kg_adjustment }}
                                        {% if form.kg_adjustment.errors %}
                                            <div class="validation-error">{{ form.kg_adjustment.errors }}</div>
                                        {% endif %}
                                    </td>
                                    <td data-label="Remarks">
                                        {{ form.remarks }}
                                        {% if form.remarks.errors %}
                                            <div class="validation-error">{{ form.remarks.errors }}</div>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="form-actions">
                <div class="row">
                    <div class="col-lg-6 mb-3">
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-check me-2"></i>{{ action }} Tenant Stock
                        </button>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <a href="{% url 'adminapp:tenant_stock_list' %}" class="cancel-btn">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </div>
            </div>
            </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tenantField = document.getElementById('{{ form.tenant_company_name.id_for_label }}');
        const itemField = document.getElementById('{{ form.item.id_for_label }}');
        const brandField = document.getElementById('{{ form.brand.id_for_label }}');
        const itemQualityField = document.getElementById('{{ form.item_quality.id_for_label }}');
        const unitField = document.getElementById('{{ form.unit.id_for_label }}');
        const glazeField = document.getElementById('{{ form.glaze.id_for_label }}');
        const speciesField = document.getElementById('{{ form.species.id_for_label }}');
        const gradeField = document.getElementById('{{ form.grade.id_for_label }}');
        const freezingCategoryField = document.getElementById('{{ form.freezing_category.id_for_label }}');
        const processingCenterField = document.getElementById('{{ form.processing_center.id_for_label }}');
        const storeField = document.getElementById('{{ form.store.id_for_label }}');
        
        const slabAdjustment = document.getElementById('{{ form.slab_adjustment.id_for_label }}');
        const csAdjustment = document.getElementById('{{ form.cs_adjustment.id_for_label }}');
        const kgAdjustment = document.getElementById('{{ form.kg_adjustment.id_for_label }}');
        
        const currentStockDisplay = document.getElementById('currentStockDisplay');
        const newStockDisplay = document.getElementById('newStockDisplay');
        const currentSlab = document.getElementById('currentSlab');
        const currentCS = document.getElementById('currentCS');
        const currentKG = document.getElementById('currentKG');
        const afterSlab = document.getElementById('afterSlab');
        const afterCS = document.getElementById('afterCS');
        const afterKG = document.getElementById('afterKG');
        const originalSlab = document.getElementById('originalSlab');
        const originalCS = document.getElementById('originalCS');
        const originalKG = document.getElementById('originalKG');

        let currentStockData = {
            available_slab: 0,
            available_c_s: 0,
            available_kg: 0,
            original_slab: 0,
            original_c_s: 0,
            original_kg: 0,
            exists: false
        };

        // Handle location field changes (both can be selected)
        function handleLocationChange() {
            if (processingCenterField) {
                processingCenterField.addEventListener('change', checkCurrentStock);
            }
            if (storeField) {
                storeField.addEventListener('change', checkCurrentStock);
            }
        }

        // Add visual feedback for positive/negative values
        function updateInputStyle(input) {
            const value = parseFloat(input.value) || 0;
            input.classList.remove('border-success', 'border-danger', 'border-warning');
            
            if (value > 0) {
                input.classList.add('border-success');
            } else if (value < 0) {
                input.classList.add('border-danger');
            } else {
                input.classList.add('border-warning');
            }
        }

        function updateAfterValues() {
            const slabAdj = parseFloat(slabAdjustment.value) || 0;
            const csAdj = parseFloat(csAdjustment.value) || 0;
            const kgAdj = parseFloat(kgAdjustment.value) || 0;
            
            const newSlab = currentStockData.available_slab + slabAdj;
            const newCS = currentStockData.available_c_s + csAdj;
            const newKG = currentStockData.available_kg + kgAdj;
            
            afterSlab.textContent = newSlab.toFixed(2);
            afterCS.textContent = newCS.toFixed(2);
            afterKG.textContent = newKG.toFixed(2);
            
            // Color code the "after" values
            afterSlab.className = newSlab < 0 ? 'text-danger fw-bold' : 'text-success fw-bold';
            afterCS.className = newCS < 0 ? 'text-danger fw-bold' : 'text-success fw-bold';
            afterKG.className = newKG < 0 ? 'text-danger fw-bold' : 'text-success fw-bold';
        }
        
        // Attach input event listeners for real-time feedback
        [slabAdjustment, csAdjustment, kgAdjustment].forEach(field => {
            if (field) {
                field.addEventListener('input', function() {
                    updateInputStyle(this);
                    updateAfterValues();
                });
            }
        });

        function checkCurrentStock() {
            const tenant = tenantField ? tenantField.value : '';
            const item = itemField ? itemField.value : '';
            const brand = brandField ? brandField.value : '';
            const itemQuality = itemQualityField ? itemQualityField.value : '';
            const unit = unitField ? unitField.value : '';
            const glaze = glazeField ? glazeField.value : '';
            const species = speciesField ? speciesField.value : '';
            const grade = gradeField ? gradeField.value : '';
            const freezingCategory = freezingCategoryField ? freezingCategoryField.value : '';
            const processingCenter = processingCenterField ? processingCenterField.value : '';
            const store = storeField ? storeField.value : '';

            // Check if required fields are filled
            if (!tenant || !item || !brand) {
                currentStockDisplay.style.display = 'none';
                newStockDisplay.style.display = 'none';
                return;
            }

            // Build URL with parameters - INCLUDE freezing_category
            const params = new URLSearchParams({
                tenant: tenant,
                item: item,
                brand: brand,
                item_quality: itemQuality,
                unit: unit,
                glaze: glaze,
                species: species,
                grade: grade,
                freezing_category: freezingCategory,
                processing_center: processingCenter,
                store: store
            });

            const url = `/adminapp/tenant-stock/get-current/?${params.toString()}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        currentStockData.available_slab = data.available_slab;
                        currentStockData.available_c_s = data.available_c_s;
                        currentStockData.available_kg = data.available_kg;
                        currentStockData.original_slab = data.original_slab;
                        currentStockData.original_c_s = data.original_c_s;
                        currentStockData.original_kg = data.original_kg;
                        currentStockData.exists = true;
                        
                        currentSlab.textContent = data.available_slab.toFixed(2);
                        currentCS.textContent = data.available_c_s.toFixed(2);
                        currentKG.textContent = data.available_kg.toFixed(2);
                        
                        originalSlab.textContent = data.original_slab.toFixed(2);
                        originalCS.textContent = data.original_c_s.toFixed(2);
                        originalKG.textContent = data.original_kg.toFixed(2);
                        
                        currentStockDisplay.style.display = 'block';
                        newStockDisplay.style.display = 'none';
                        
                        updateAfterValues();
                    } else {
                        currentStockData = {
                            available_slab: 0,
                            available_c_s: 0,
                            available_kg: 0,
                            original_slab: 0,
                            original_c_s: 0,
                            original_kg: 0,
                            exists: false
                        };
                        
                        currentStockDisplay.style.display = 'none';
                        newStockDisplay.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error fetching tenant stock:', error);
                    currentStockDisplay.style.display = 'none';
                    newStockDisplay.style.display = 'none';
                });
        }

        // Initialize location handler
        handleLocationChange();

        // Attach event listeners to all fields that affect the stock lookup
        [tenantField, itemField, brandField, itemQualityField, unitField, 
         glazeField, speciesField, gradeField, freezingCategoryField].forEach(field => {
            if (field) {
                field.addEventListener('change', checkCurrentStock);
            }
        });

        // Form submission validation
        document.getElementById('tenantStockAdjustmentForm').addEventListener('submit', function(e) {
            const slabVal = parseFloat(slabAdjustment.value) || 0;
            const csVal = parseFloat(csAdjustment.value) || 0;
            const kgVal = parseFloat(kgAdjustment.value) || 0;
            
            // Check if both locations are selected
            const pcValue = processingCenterField ? processingCenterField.value : '';
            const storeValue = storeField ? storeField.value : '';
            
            if (slabVal === 0 && csVal === 0 && kgVal === 0) {
                e.preventDefault();
                alert('Please enter at least one adjustment value (Slab, CS, or KG).');
                return false;
            }
            
            if (currentStockData.exists) {
                const newSlab = currentStockData.available_slab + slabVal;
                const newCS = currentStockData.available_c_s + csVal;
                const newKG = currentStockData.available_kg + kgVal;
                
                if (newSlab < 0 || newCS < 0 || newKG < 0) {
                    const confirmMsg = 'Warning: This adjustment will result in negative stock quantities.\n' +
                                      `New Slab: ${newSlab.toFixed(2)}\n` +
                                      `New CS: ${newCS.toFixed(2)}\n` +
                                      `New KG: ${newKG.toFixed(2)}\n\n` +
                                      'Do you want to proceed?';
                    
                    if (!confirm(confirmMsg)) {
                        e.preventDefault();
                        return false;
                    }
                }
            }
        });
    });
</script>


<!-- Place this script after your existing DOMContentLoaded script in the template -->

<!-- Arrow key navigation for form fields -->
<script>
    $(document).ready(function() {
        // Get all focusable form elements
        function getFocusableElements() {
            return $('input:not([type="hidden"]):not([readonly]), select:not([disabled]), textarea:not([readonly])').filter(':visible');
        }

        // Check if input type should navigate on arrow keys
        function shouldNavigate(element, direction) {
            const $elem = $(element);
            const inputType = $elem.attr('type');
            
            // Always navigate for select, date, and number inputs
            if ($elem.is('select') || inputType === 'date' || inputType === 'number') {
                return true;
            }
            
            // For text inputs, check cursor position
            if ($elem.is('input') && (inputType === 'text' || !inputType)) {
                try {
                    const cursorPos = element.selectionStart;
                    const valueLength = element.value.length;
                    
                    // Left arrow: navigate if cursor at beginning
                    if (direction === 'left' && cursorPos === 0) {
                        return true;
                    }
                    
                    // Right arrow: navigate if cursor at end
                    if (direction === 'right' && cursorPos === valueLength) {
                        return true;
                    }
                } catch(e) {
                    // If selectionStart fails, just navigate
                    return true;
                }
            }
            
            // For textarea, check cursor position at edges only
            if ($elem.is('textarea')) {
                try {
                    const cursorPos = element.selectionStart;
                    const valueLength = element.value.length;
                    
                    // Navigate only at the very beginning or end
                    if (direction === 'left' && cursorPos === 0) {
                        return true;
                    }
                    if (direction === 'right' && cursorPos === valueLength) {
                        return true;
                    }
                } catch(e) {
                    // If selectionStart fails, don't navigate for textarea
                    return false;
                }
                return false;
            }
            
            return false;
        }

        $(document).on('keydown', 'input, select, textarea', function(e) {
            // Left arrow key (keyCode 37)
            if (e.keyCode === 37 || e.which === 37) {
                if (shouldNavigate(this, 'left')) {
                    e.preventDefault();
                    let focusableElements = getFocusableElements();
                    let currentIndex = focusableElements.index(this);
                    
                    // Move to previous field
                    if (currentIndex > 0) {
                        focusableElements.eq(currentIndex - 1).focus().select();
                    }
                    return false;
                }
            }
            
            // Right arrow key (keyCode 39)
            if (e.keyCode === 39 || e.which === 39) {
                if (shouldNavigate(this, 'right')) {
                    e.preventDefault();
                    let focusableElements = getFocusableElements();
                    let currentIndex = focusableElements.index(this);
                    
                    // Move to next field
                    if (currentIndex < focusableElements.length - 1) {
                        focusableElements.eq(currentIndex + 1).focus().select();
                    }
                    return false;
                }
            }
        });

        // Optional: Add visual feedback when navigating
        $(document).on('focus', 'input, select, textarea', function() {
            $(this).css('box-shadow', '0 0 0 4px rgba(0, 123, 255, 0.15)');
        });

        $(document).on('blur', 'input, select, textarea', function() {
            $(this).css('box-shadow', '');
        });
    });
</script>

{% endblock %}