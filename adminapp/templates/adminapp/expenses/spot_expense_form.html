<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ form.instance.pk|yesno:"Update Expense,Create Expense" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">

  <h2 class="mb-4">{{ form.instance.pk|yesno:"Update Expense,Create Expense" }}</h2>

<a href="{% url 'adminapp:spot_purchase_expense_list' %}" class="btn btn-success mb-2">list</a>

<form method="POST">
  {% csrf_token %}
  
  <div class="mb-3">
    <label for="date-field" class="form-label">Date</label>
    <input type="date" id="date-field" class="form-control" required>
  </div>

  <div class="mb-3">
    <label for="purchase-select" class="form-label">Purchase (Voucher - Spot)</label>
    <select name="purchase" id="purchase-select" class="form-select" required>
      <option value="">Select purchase</option>
    </select>
  </div>

  <div class="mb-3">
    <label for="agent" class="form-label">Agent</label>
    {{ form.agent }}
  </div>

  <div class="mb-3">
    <label>Ice Expense</label>
    {{ form.ice_expense }}
  </div>

  <div class="mb-3">
    <label>Vehicle Rent</label>
    {{ form.vehicle_rent }}
  </div>

  <div class="mb-3">
    <label>Loading and Unloading</label>
    {{ form.loading_and_unloading }}
  </div>

  <div class="mb-3">
    <label>Peeling Charge</label>
    {{ form.peeling_charge }}
  </div>

  <div class="mb-3">
    <label>Other Expense</label>
    {{ form.other_expense }}
  </div>

  <div class="mb-3">
    <label>Total Expense</label>
    <input type="number" step="0.01" id="total-expense" name="total_expense" class="form-control" readonly>
  </div>

  <button type="submit" class="btn btn-primary">Save</button>
</form>

<script>
  document.getElementById('date-field').addEventListener('change', function () {
    const date = this.value;
    const purchaseSelect = document.getElementById('purchase-select');
    purchaseSelect.innerHTML = '<option value="">Select purchase</option>';

    if (date) {
      fetch(`/adminapp/ajax/get-purchases/?date=${date}`)
        .then(response => response.json())
        .then(data => {
          data.purchases.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = `${p.voucher_number} (${p.spot})`;
            purchaseSelect.appendChild(option);
          });
        });
    }
  });

  const expenseFields = [
    'id_ice_expense',
    'id_vehicle_rent',
    'id_loading_and_unloading',
    'id_peeling_charge',
    'id_other_expense'
  ];

  expenseFields.forEach(fieldId => {
    document.getElementById(fieldId).addEventListener('input', updateTotal);
  });

  function updateTotal() {
    let total = 0;
    expenseFields.forEach(fieldId => {
      const val = parseFloat(document.getElementById(fieldId).value) || 0;
      total += val;
    });
    document.getElementById('total-expense').value = total.toFixed(2);
  }
</script>


</body>
</html>
