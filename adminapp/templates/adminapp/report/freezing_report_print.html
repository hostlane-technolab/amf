<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sectioned Freezing Report - Print View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Book Antiqua', 'Palatino Linotype', Palatino, serif;
            font-size: 14px;
            line-height: 1.3;
            color: #000;
            background: #f0f8ff;
            padding: 10px;
        }

        .report-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        @page {
            size: A4 portrait;
            margin: 12mm 8mm;
        }

        .report-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #a2ceff 0%, #add1f7 100%);
            color: #000;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .report-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .report-subtitle {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        .company-info {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .company-name {
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            margin-bottom: 5px;
            color: #155724;
        }

        .company-location {
            font-size: 14px;
            text-align: center;
            margin-bottom: 3px;
            color: #155724;
        }

        .date-range {
            font-size: 15px;
            margin-top: 10px;
            font-weight: bold;
            color: #004085;
        }

        .section {
            margin-bottom: 20px;
            border: 2px solid #add1f7;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            page-break-inside: avoid;
        }

        .section-header {
            background: linear-gradient(135deg, #9ccaff 0%, #add1f7 100%);
            color: #000;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-transform: uppercase;
        }

        .section-summary {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            padding: 10px;
            margin: 10px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            font-weight: bold;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background-color: white;
        }

        .data-table th {
            background: linear-gradient(135deg, #9ccaff 0%, #add1f7 100%);
            color: #000;
            border: 1px solid #add1f7;
            padding: 8px 6px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
        }

        .data-table td {
            border: 1px solid #c5dff5;
            padding: 6px;
            text-align: left;
            vertical-align: middle;
            font-size: 13px;
        }

        .data-table .number-col {
            text-align: right;
            padding-right: 10px;
            font-weight: bold;
        }

        .data-table .center-col {
            text-align: center;
        }

        .data-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .section-total-row {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            font-weight: bold;
        }

        .section-total-row td {
            border-top: 2px solid #28a745;
            border-bottom: 2px solid #28a745;
            font-weight: bold;
            padding: 8px 6px;
            color: #155724;
            font-size: 14px;
        }

        .grand-total-section {
            margin-top: 20px;
            border: 2px solid #dc3545;
            border-radius: 8px;
            overflow: hidden;
            page-break-inside: avoid;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .grand-total-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }

        .grand-total-table {
            width: 100%;
            border-collapse: collapse;
        }

        .grand-total-table td {
            border: 1px solid #dc3545;
            padding: 10px;
            font-weight: bold;
            text-align: right;
            font-size: 14px;
            background: white;
        }

        .grand-total-table .label-col {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            text-align: left;
            width: 65%;
            color: #721c24;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            font-style: italic;
            color: #666;
            border: 2px dashed #dee2e6;
            margin: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .footer {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 2px solid #add1f7;
            text-align: center;
            font-size: 12px;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-family: 'Book Antiqua', 'Palatino Linotype', Palatino, serif;
            font-size: 14px;
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white; 
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-danger:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }

        @media print {
            .action-buttons { display: none !important; }
            body { 
                padding: 0; 
                background: white; 
            }
            .section { 
                page-break-inside: avoid;
            }
            .section-header {
                page-break-after: avoid;
            }
            .data-table {
                page-break-inside: auto;
            }
            .data-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            .grand-total-section {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="report-container">
        <div class="action-buttons">
            <button id="generatePdfBtn" onclick="generatePDF()" class="btn btn-danger">Generate PDF</button>
            <button onclick="window.print()" class="btn btn-danger">Print</button>
            <button onclick="window.close()" class="btn btn-danger">Close</button>
        </div>

        <div class="report-header">
            <div class="report-title">Enhanced Sectioned Freezing Report</div>
            <div class="report-subtitle">
                Detailed Breakdown by {{ section_by|title }}
                {% if entry_type == 'spot' %} - Spot Entries Only
                {% elif entry_type == 'local' %} - Local Entries Only
                {% endif %}
            </div>
            
            <div class="company-info">
                <div class="company-name">BAHRAYA EXPORTS</div>
                <div class="company-location">VANDANAM, ALAPPUZHA</div>
                <div class="company-location">KERALA, INDIA</div>
            </div>
            
            <div class="date-range">
                {% if start_date and end_date %}
                    Period: {{ start_date|date:"d-M-Y" }} to {{ end_date|date:"d-M-Y" }}
                {% elif date_filter == 'today' %}
                    Period: Today ({{ "now"|date:"d-M-Y" }})
                {% elif date_filter == 'week' %}
                    Period: Current Week
                {% elif date_filter == 'month' %}
                    Period: Current Month ({{ "now"|date:"F Y" }})
                {% elif date_filter == 'quarter' %}
                    Period: Current Quarter
                {% elif date_filter == 'year' %}
                    Period: Current Year ({{ "now"|date:"Y" }})
                {% else %}
                    Period: All Records
                {% endif %}
                | Sectioned by: {{ section_by|upper }}
            </div>
        </div>

        {% if sectioned_data %}
            {% for section_name, section_data in sectioned_data.items %}
            <div class="section">
                <div class="section-header">
                    {% if section_by == 'month' %}
                        {{ section_name }}
                    {% elif section_by == 'brand' %}
                        BRAND: {{ section_name|upper }}
                    {% elif section_by == 'peeling type' %}
                        PEELING TYPE: {{ section_name|upper }}
                    {% elif section_by == 'grade' %}
                        GRADE: {{ section_name|upper }}
                    {% elif section_by == 'item' %}
                        ITEM: {{ section_name|upper }}
                    {% elif section_by == 'processing_center' %}
                        PROCESSING CENTER: {{ section_name|upper }}
                    {% elif section_by == 'store' %}
                        STORE: {{ section_name|upper }}
                    {% else %}
                        {{ section_name|upper }}
                    {% endif %}
                </div>

                <div class="section-summary">
                    <strong>Section Summary:</strong> 
                    {{ section_data.items|length }} records | 
                    Total: <span class="format-number">{{ section_data.totals.total_kg|floatformat:2 }}</span> KG | 
                    USD: $<span class="format-number">{{ section_data.totals.total_usd_amount|floatformat:2 }}</span> | 
                    INR: ₹<span class="format-number">{{ section_data.totals.total_inr_amount|floatformat:2 }}</span>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>S.NO</th>
                            <th>DATE</th>
                            <th>TYPE</th>
                            <th>VOUCHER</th>
                            <th>ITEM SUB</th>
                            {% if units %}
                            <th>UNIT</th>
                            {% endif %}
                            {% if glazes %}
                            <th>GLAZE</th>
                            {% endif %}
                            <th>BRAND</th>
                            <th>GRADE</th>
                            <th>QTY (KG)</th>
                            <th>USD AMT</th>
                            <th>INR AMT</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in section_data.items %}
                        <tr>
                            <td class="center-col">{{ forloop.counter }}</td>
                            <td class="center-col">{{ item.freezing_entry__freezing_date|date:"d/m/Y" }}</td>
                            <td class="center-col">{{ item.entry_type|upper }}</td>
                            <td class="center-col">{{ item.freezing_entry__voucher_number|default:"N/A" }}</td>
                            <td class="center-col">{{ item.item_quality__quality|default:"N/A"|truncatechars:20 }}</td>
                            {% if units %}
                            <td class="center-col">{{ item.unit__unit_code|default:item.unit__description|default:"N/A"|truncatechars:10 }}</td>
                            {% endif %}
                            {% if glazes %}
                            <td class="center-col">{% if item.glaze__percentage %}{{ item.glaze__percentage }}%{% else %}N/A{% endif %}</td>
                            {% endif %}
                            <td class="center-col">{{ item.brand__name|default:"N/A"|truncatechars:15 }}</td>
                            <td class="center-col">{{ item.peeling_type__name|default:"N/A"|truncatechars:15 }} - {{ item.grade__grade|default:"N/A" }}</td>
                            <td class="number-col"><span class="format-number">{{ item.total_kg|floatformat:2 }}</span></td>
                            <td class="number-col">$<span class="format-number">{{ item.total_usd_amount|floatformat:2 }}</span></td>
                            <td class="number-col">₹<span class="format-number">{{ item.total_inr_amount|floatformat:2 }}</span></td>
                        </tr>
                        {% endfor %}
                        
                        <tr class="section-total-row">
                            {% if units and glazes %}
                                <td colspan="9" class="center-col"><strong>SECTION TOTAL</strong></td>
                            {% elif units or glazes %}
                                <td colspan="8" class="center-col"><strong>SECTION TOTAL</strong></td>
                            {% else %}
                                <td colspan="7" class="center-col"><strong>SECTION TOTAL</strong></td>
                            {% endif %}
                            <td class="number-col"><strong><span class="format-number">{{ section_data.totals.total_kg|floatformat:2 }}</span></strong></td>
                            <td class="number-col"><strong>$<span class="format-number">{{ section_data.totals.total_usd_amount|floatformat:2 }}</span></strong></td>
                            <td class="number-col"><strong>₹<span class="format-number">{{ section_data.totals.total_inr_amount|floatformat:2 }}</span></strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            {% endfor %}

            <div class="grand-total-section">
                <div class="grand-total-header">GRAND TOTALS - ALL SECTIONS</div>
                <table class="grand-total-table">
                    <tr>
                        <td class="label-col">TOTAL QUANTITY (KG)</td>
                        <td><span class="format-number">{{ grand_totals.total_kg|floatformat:2 }}</span></td>
                    </tr>
                    <tr>
                        <td class="label-col">TOTAL USD AMOUNT</td>
                        <td>$<span class="format-number">{{ grand_totals.total_usd_amount|floatformat:2 }}</span></td>
                    </tr>
                    <tr>
                        <td class="label-col">TOTAL INR AMOUNT</td>
                        <td>₹<span class="format-number">{{ grand_totals.total_inr_amount|floatformat:2 }}</span></td>
                    </tr>
                    <tr>
                        <td class="label-col">TOTAL RECORDS</td>
                        <td>{{ grand_totals.count }}</td>
                    </tr>
                    <tr>
                        <td class="label-col">TOTAL SECTIONS</td>
                        <td>{{ sectioned_data|length }}</td>
                    </tr>
                    {% if grand_totals.avg_kg_per_entry %}
                    <tr>
                        <td class="label-col">AVERAGE QUANTITY PER RECORD (KG)</td>
                        <td><span class="format-number">{{ grand_totals.avg_kg_per_entry|floatformat:2 }}</span></td>
                    </tr>
                    {% endif %}
                    {% if grand_totals.avg_usd_per_kg %}
                    <tr>
                        <td class="label-col">AVERAGE USD PER KG</td>
                        <td>$<span class="format-number">{{ grand_totals.avg_usd_per_kg|floatformat:2 }}</span></td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        {% else %}
            <div class="no-data">
                <h3>No Records Found</h3>
                <p>No freezing records match the current filter criteria.</p>
                <p>Please adjust your filters and try again.</p>
            </div>
        {% endif %}

        <div class="footer">
            Generated on {{ "now"|date:"d-M-Y H:i" }} | BAHRAYA EXPORTS - Enhanced Sectioned Freezing Report
        </div>
    </div>

<script>
// Format numbers with commas on page load
document.addEventListener('DOMContentLoaded', function() {
    formatAllNumbers();
});

function formatAllNumbers() {
    const numberElements = document.querySelectorAll('.format-number');
    numberElements.forEach(el => {
        const text = el.textContent.trim();
        const number = parseFloat(text);
        if (!isNaN(number)) {
            el.textContent = formatNumberWithCommas(number);
        }
    });
}

function formatNumberWithCommas(num) {
    const parts = num.toFixed(2).split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return parts.join('.');
}

async function generatePDF() {
    const button = document.getElementById('generatePdfBtn');
    button.disabled = true;
    button.textContent = 'Generating PDF...';

    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4',
            compress: true
        });

        pdf.setFont('times', 'normal');

        let yPos = 20;
        const pageHeight = pdf.internal.pageSize.height;
        const pageWidth = pdf.internal.pageSize.width;
        const margin = 10;
        const maxY = pageHeight - 15;

        function checkPageBreak(requiredSpace = 20) {
            if (yPos + requiredSpace > maxY) {
                pdf.addPage();
                yPos = 15;
                return true;
            }
            return false;
        }

        function formatNumber(num) {
            if (typeof num === 'string') {
                num = num.replace(/[₹$,\s]/g, '');
                num = parseFloat(num);
            }
            if (isNaN(num)) return num;
            return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Header
        pdf.setFontSize(16);
        pdf.setFont('times', 'bold');
        pdf.setFillColor(162, 206, 255);
        pdf.rect(margin, 10, pageWidth - 2 * margin, 12, 'F');
        pdf.setTextColor(0, 0, 0);
        pdf.text('FREEZING REPORT', pageWidth / 2, 17.5, { align: 'center' });

        const reportSubtitle = document.querySelector('.report-subtitle')?.textContent.trim() || '';
        pdf.setFontSize(11);
        pdf.text(reportSubtitle, pageWidth / 2, 25, { align: 'center' });

        pdf.setFontSize(12);
        pdf.setFont('times', 'bold');
        pdf.setTextColor(21, 87, 36);
        pdf.text('BAHRAYA EXPORTS', pageWidth / 2, 32, { align: 'center' });
        pdf.setFontSize(9);
        pdf.setFont('times', 'normal');
        pdf.text('VANDANAM, ALAPPUZHA, KERALA, INDIA', pageWidth / 2, 37, { align: 'center' });

        const dateRange = document.querySelector('.date-range')?.textContent.trim() || '';
        pdf.setFontSize(9);
        pdf.setFont('times', 'bold');
        pdf.setTextColor(0, 64, 133);
        
        // Split the date range text if it contains a pipe separator
        const dateRangeParts = dateRange.split('|');
        if (dateRangeParts.length > 1) {
            // First part (period)
            pdf.text(dateRangeParts[0].trim(), pageWidth / 2, 43, { align: 'center' });
            // Second part (sectioned by)
            pdf.text(dateRangeParts[1].trim(), pageWidth / 2, 48, { align: 'center' });
            yPos = 55;
        } else {
            pdf.text(dateRange, pageWidth / 2, 43, { align: 'center' });
            yPos = 50;
        }


        // Sections
        const sections = document.querySelectorAll('.section');

        sections.forEach((section, index) => {
            if (index > 0) yPos += 8;
            checkPageBreak(35);

            // Section Header (Category Name)
            const sectionHeader = section.querySelector('.section-header');
            if (sectionHeader) {
                pdf.setFontSize(14);
                pdf.setFont('times', 'bold');
                pdf.setFillColor(162, 206, 255);
                pdf.rect(margin, yPos, pageWidth - 2 * margin, 10, 'F');
                pdf.setTextColor(0, 0, 0);
                pdf.text(sectionHeader.textContent.trim(), pageWidth / 2, yPos + 6.5, { align: 'center' });
                yPos += 12;
            }

            // Section Summary
            const sectionSummary = section.querySelector('.section-summary');
            if (sectionSummary) {
                checkPageBreak(12);
                pdf.setFont('times', 'bold');
                pdf.setFillColor(255, 243, 205);
                pdf.rect(margin, yPos, pageWidth - 2 * margin, 10, 'F');
                pdf.setTextColor(133, 100, 4);
                
                // Get full text and clean it up - replace rupee symbol properly
                let summaryText = sectionSummary.textContent.trim();
                summaryText = summaryText.replace(/\s+/g, ' ');
                // Replace all variations of rupee symbol
                summaryText = summaryText.replace(/₹/g, 'Rs. ');
                summaryText = summaryText.replace(/¹/g, 'Rs. ');
                summaryText = summaryText.replace(/INR:\s*Rs\.\s*Rs\.\s*/g, 'INR: Rs. '); // Fix double Rs.
                
                // Use small font size
                pdf.setFontSize(6.8);
                
                pdf.text(summaryText, pageWidth / 2, yPos + 6, { 
                    align: 'center',
                    maxWidth: pageWidth - 2 * margin - 4
                });
                
                yPos += 12;
            }

            const table = section.querySelector('.data-table');
            if (table) {
                const headers = [];
                const rows = [];

                table.querySelectorAll('thead th').forEach(cell => headers.push(cell.textContent.trim()));

                const bodyRows = table.querySelectorAll('tbody tr');
                bodyRows.forEach(row => {
                    const rowData = [];
                    const cells = row.querySelectorAll('td');

                    cells.forEach(cell => {
                        let text = cell.textContent.trim();
                        if (cell.classList.contains('number-col')) {
                            const num = parseFloat(text.replace(/[^\d.-]/g, ''));
                            if (!isNaN(num)) text = formatNumber(num);
                        }
                        rowData.push(text);
                    });

                    const isTotal = row.classList.contains('section-total-row');
                    rows.push({ data: rowData, isTotal });
                });

                checkPageBreak(20);

                pdf.autoTable({
                    head: [headers],
                    body: rows.map(r => r.data),
                    startY: yPos,
                    margin: { left: margin, right: margin },
                    styles: {
                        font: 'times',
                        fontSize: 7,
                        cellPadding: 1.5,
                        overflow: 'linebreak',
                        lineWidth: 0.1,
                        lineColor: [197, 223, 245],
                        halign: 'center',
                        valign: 'middle'
                    },
                    headStyles: {
                        fillColor: [156, 202, 255],
                        textColor: [0, 0, 0],
                        fontStyle: 'bold',
                        fontSize: 7,
                        halign: 'center'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 249, 250]
                    },
                    didParseCell: function (data) {
                        if (data.section === 'body') {
                            const rowIndex = data.row.index;

                            if (rows[rowIndex] && rows[rowIndex].isTotal) {
                                data.cell.styles.fillColor = [212, 237, 218];
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.textColor = [21, 87, 36];
                            }

                            if (data.column.index >= headers.length - 3) {
                                data.cell.styles.halign = 'right';
                                data.cell.styles.fontStyle = 'bold';
                            } else {
                                data.cell.styles.halign = 'center';
                            }
                        }
                    },
                    theme: 'grid',
                    pageBreak: 'auto',
                    rowPageBreak: 'avoid'
                });

                yPos = pdf.lastAutoTable.finalY + 5;
            }
        });

        // Grand Totals
        const grandTotalSection = document.querySelector('.grand-total-section');
        if (grandTotalSection) {
            checkPageBreak(40);

            pdf.setFontSize(12);
            pdf.setFont('times', 'bold');
            pdf.setFillColor(220, 53, 69);
            pdf.rect(margin, yPos, pageWidth - 2 * margin, 8, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.text('GRAND TOTALS - ALL SECTIONS', pageWidth / 2, yPos + 5.5, { align: 'center' });
            yPos += 10;

            const grandTable = grandTotalSection.querySelector('table');
            if (grandTable) {
                const grandRows = [];
                const tableRows = grandTable.querySelectorAll('tr');

                tableRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length === 2) {
                        const label = cells[0].textContent.trim();
                        let value = cells[1].textContent.trim();
                        
                        // Remove any existing currency symbols and clean the number
                        const cleanValue = value.replace(/[₹$,\s]/g, '');
                        const num = parseFloat(cleanValue);
                        
                        // Format with appropriate currency symbol
                        if (!isNaN(num)) {
                            if (label.includes('USD')) {
                                value = '$' + formatNumber(num);
                            } else if (label.includes('INR')) {
                                value = 'Rs. ' + formatNumber(num); // Use "Rs." instead of ₹
                            } else {
                                value = formatNumber(num);
                            }
                        }
                        
                        grandRows.push([label, value]);
                    }
                });

                pdf.autoTable({
                    body: grandRows,
                    startY: yPos,
                    margin: { left: margin, right: margin },
                    styles: {
                        font: 'times',
                        fontSize: 9,
                        cellPadding: 2.5,
                        lineWidth: 0.5,
                        lineColor: [220, 53, 69],
                        fontStyle: 'bold',
                        textColor: [0, 0, 0]
                    },
                    columnStyles: {
                        0: {
                            cellWidth: 130,
                            fillColor: [248, 215, 218],
                            textColor: [114, 28, 36],
                            halign: 'left',
                            valign: 'middle'
                        },
                        1: {
                            fillColor: [255, 255, 255],
                            textColor: [0, 0, 0],
                            halign: 'right',
                            valign: 'middle'
                        }
                    },
                    theme: 'grid'
                });

                yPos = pdf.lastAutoTable.finalY + 5;
            }
        }
            
        // Footer
        pdf.setFontSize(7);
        pdf.setFont('times', 'normal');
        pdf.setTextColor(102, 102, 102);
        const footerText = `Generated on ${new Date().toLocaleString('en-GB')} | BAHRAYA EXPORTS - Enhanced Sectioned Freezing Report`;
        const totalPages = pdf.internal.getNumberOfPages();
        
        for (let i = 1; i <= totalPages; i++) {
            pdf.setPage(i);
            pdf.text(footerText, pageWidth / 2, pageHeight - 8, { align: 'center' });
            pdf.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
        }

        // Save PDF
        const timestamp = new Date().toISOString().slice(0, 10);
        pdf.save(`Bahraya_Freezing_Report_${timestamp}.pdf`);

        button.textContent = 'Generate PDF';
        button.disabled = false;
        alert('PDF generated successfully!');

    } catch (error) {
        console.error('PDF generation error:', error);
        alert('Error generating PDF: ' + error.message);
        button.textContent = 'Generate PDF';
        button.disabled = false;
    }
}
</script>


</body>
</html>