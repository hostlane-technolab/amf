{% extends "admin_base.html" %}
{% block title %}Create Return Tenant {% endblock %}
{% block content %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<style>
    /* Page Header Styles */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 3rem;
        padding: 20px 0;
    }

    .page-header-left {
        flex: 1;
    }

    .page-header-right {
        margin-left: 20px;
        display: flex;
        align-items: flex-start;
    }

    /* Header Actions */
    .header-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }

    /* Header Buttons */
    .header-btn {
        display: inline-flex;
        align-items: center;
        padding: 12px 20px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 14px;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        white-space: nowrap;
        min-height: 44px;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
        box-shadow: 
            0 4px 15px rgba(0,0,0,0.1),
            0 2px 4px rgba(0,0,0,0.06),
            inset 0 1px 0 rgba(255,255,255,0.1);
    }

    .header-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .header-btn:hover::before {
        left: 100%;
    }

    .header-btn i {
        margin-right: 10px;
        font-size: 16px;
        transition: transform 0.3s ease;
    }

    .header-btn:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 
            0 8px 25px rgba(0,0,0,0.15),
            0 4px 8px rgba(0,0,0,0.08),
            inset 0 1px 0 rgba(255,255,255,0.2);
        text-decoration: none;
    }

    .header-btn:hover i {
        transform: scale(1.1);
    }

    .header-btn:active {
        transform: translateY(-1px) scale(0.98);
    }

    /* Button Color Variants */
    .btn-secondary {
        background: #8E9AAF;
        color: white;
        box-shadow: 
            0 4px 15px rgba(142, 154, 175, 0.3),
            0 2px 4px rgba(142, 154, 175, 0.2),
            inset 0 1px 0 rgba(255,255,255,0.15);
    }

    .btn-secondary:hover {
        background: #7A8599;
        color: white;
    }

    .btn-info {
        background: #50C9CE;
        color: white;
        box-shadow: 
            0 4px 15px rgba(80, 201, 206, 0.3),
            0 2px 4px rgba(80, 201, 206, 0.2),
            inset 0 1px 0 rgba(255,255,255,0.15);
    }

    .btn-info:hover {
        background: #3FB4B9;
        color: white;
    }

    .btn-success {
        background: #58D68D;
        color: white;
        box-shadow: 
            0 4px 15px rgba(88, 214, 141, 0.3),
            0 2px 4px rgba(88, 214, 141, 0.2),
            inset 0 1px 0 rgba(255,255,255,0.15);
    }

    .btn-success:hover {
        background: #45B576;
        color: white;
    }

    /* Base Styles */
    .return-entry-form {
        margin-top: 2rem;
    }

    /* Card Styling */
    .form-card {
        border-radius: 20px;
        background: #ffffff;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        border: none;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    /* Card Header */
    .card-header {
        background: linear-gradient(135deg, #f8f9fd 0%, #ffffff 100%);
        border-bottom: 2px solid #f1f3f7;
        padding: 25px 30px;
        border-radius: 20px 20px 0 0;
    }

    .icon-wrapper {
        width: 60px;
        height: 60px;
        background: #007bff;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.2);
    }

    .card-title {
        font-size: 26px;
        color: #2c3e50;
        letter-spacing: -0.5px;
        margin-bottom: 0;
    }

    .card-header p {
        color: #6c757d;
        font-size: 14px;
        margin: 0;
    }

    /* Card Body */
    .card-body {
        padding-bottom: 30px;
    }

    /* Form Controls Styling */
    .form-control, input, select, textarea {
        padding: 12px 15px !important;
        border: 2px solid #e9ecef !important;
        border-radius: 12px !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        background: #ffffff !important;
        transition: all 0.3s ease !important;
        width: 100% !important;
        box-sizing: border-box;
    }

    .form-control:focus, input:focus, select:focus, textarea:focus {
        border-color: #007bff !important;
        box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1) !important;
        outline: none !important;
    }

    /* Add Button */
    .add-btn {
        background: #007bff;
        color: white;
        border: 2px solid #007bff;
        padding: 12px 20px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
    }

    .add-btn:hover {
        background: #0056b3;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
    }

    /* Table Styling */
    .modern-table {
        width: 100%;
        margin: 0;
        font-size: 14px;
        border-collapse: collapse;
    }

    .table-header {
        background: #f8f9fd;
        border: none;
        padding: 20px 15px;
        font-weight: 700;
        color: #495057;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 12px;
    }

    .header-content {
        display: flex;
        align-items: center;
    }

    .header-icon {
        color: #6c757d;
        margin-right: 10px;
        font-size: 14px;
    }

    /* Table Rows */
    .table-row {
        border: none;
        transition: all 0.3s ease;
    }

    .table-row:hover {
        background: linear-gradient(135deg, rgba(0, 123, 255, 0.02) 0%, rgba(0, 123, 255, 0.05) 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    }

    .table-cell {
        /* padding: 15px; */
        border: none;
        border-bottom: 1px solid #f1f3f7;
        vertical-align: middle;
    }

    .table-cell input, .table-cell select {
        /* padding: 10px 12px !important; */
        margin: 0 !important;
        border: 2px solid #e9ecef !important;
        border-radius: 8px !important;
        font-size: 13px !important;
    }

    /* Action Buttons */
    .action-btn {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        font-size: 12px;
        transition: all 0.3s ease;
        border: 2px solid;
        background: none;
        cursor: pointer;
    }

    .delete-btn, .remove-btn {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border-color: rgba(220, 53, 69, 0.2);
    }

    .delete-btn:hover, .remove-btn:hover {
        background: #dc3545;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    .action-btn i {
        margin-right: 6px;
        font-size: 12px;
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 40px;
    }

    .submit-btn {
        background: #007bff;
        color: white;
        border: 2px solid #007bff;
        padding: 15px 30px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 16px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        text-decoration: none;
    }

    .submit-btn:hover {
        background: #0056b3;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
    }

    .cancel-btn {
        background: transparent;
        color: #6c757d;
        border: 2px solid #e9ecef;
        padding: 15px 30px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        text-decoration: none;
    }

    .cancel-btn:hover {
        background: #6c757d;
        color: white;
        text-decoration: none;
        transform: translateY(-2px);
    }

    /* Items Container */
        .items-container {
            width: 100%;
            max-width: 100%;
            overflow-x: visible;
            overflow-y: visible;
            margin-bottom: 20px;
            border: 1px solid #f1f3f7;
            border-radius: 12px;
            box-sizing: border-box;
            padding-left: 15px;
            padding-right: 15px;
        }

        .items-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }

        /* Column widths - optimized for content */
        .col-original-item { width: 5%; }
        .col-pr-centre { width: 6%; }
        .col-store { width: 5%; }
        .col-item { width: 5%; }
        .col-category { width: 6.5%; }
        .col-unit { width: 4%; }
        .col-glaze { width: 5%; }
        .col-fr-category { width: 7.5%; }
        .col-brand { width: 5%; }
        .col-species { width: 6%; }
        .col-grade { width: 5%; }
        .col-slab-qty { width: 6.5%; }
        .col-cs-qty { width: 6%; }
        .col-kg { width: 4%; }
        .col-rate { width: 5%; }
        .col-amount { width: 6%; }
        .col-action { width: 7%; }

        /* Uniform header text styling */
        .items-table .header-text {
            font-size: 10px;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .items-table .header-icon {
            font-size: 10px;
            margin-right: 3px;
        }
        
        .items-table .header-content {
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }
        
        .items-table .table-header {
            white-space: nowrap;
            padding: 12px 5px !important;
        }

    /* Totals Table */
    .totals-card {
        background: linear-gradient(135deg, #f8f9fd 0%, #ffffff 100%);
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }

    .totals-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .totals-table th,
    .totals-table td {
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #f1f3f7;
    }

    .totals-table th {
        background: #007bff;
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.5px;
    }

    .totals-table td {
        font-weight: 500;
        background: #f8f9fd;
    }

    .totals-table input, .totals-table select {
        font-weight: 600;
        color: #007bff;
        text-align: center;
        background: #eef4ff;
        border: 2px solid #ccdfff !important;
        border-radius: 8px !important;
        padding: 10px 15px !important;
    }

    /* Basic Entry Table */
    .basic-entry-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0;
    }

    .basic-entry-table th,
    .basic-entry-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #f1f3f7;
    }

    .basic-entry-table th {
        background: #f8f9fd;
        font-weight: 600;
        color: #495057;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.5px;
    }

    /* Utility classes */
    .d-flex { display: flex; }
    .align-items-center { align-items: center; }
    .justify-content-between { justify-content: space-between; }
    .mb-0 { margin-bottom: 0; }
    .me-4 { margin-right: 1.5rem; }
    .text-muted { color: #6c757d; }
    .fw-semibold { font-weight: 600; }
    .mb-4 { margin-bottom: 1.5rem; }

    /* Responsive Design */
    @media (max-width: 991px) {
        .page-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .page-header-right {
            margin-left: 0;
            margin-top: 20px;
        }
        
        .header-actions {
            justify-content: center;
        }
    }

    @media (max-width: 768px) {
        .header-actions {
            flex-direction: column;
            width: 100%;
        }
        
        .header-btn {
            width: 100%;
            justify-content: center;
            min-width: 200px;
        }

        .card-body {
            padding: 20px;
        }
        
        .card-header {
            padding: 20px;
        }
    }
</style>


<style>
    /* Responsive Design */
    @media (max-width: 991px) {
        .page-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .page-header-right {
            margin-left: 0;
            margin-top: 20px;
        }
        
        .header-actions {
            justify-content: center;
        }
    }

    @media (max-width: 768px) {
        .header-actions {
            flex-direction: column;
            width: 100%;
        }
        
        .header-btn {
            width: 100%;
            justify-content: center;
            min-width: 200px;
        }

        .card-body {
            padding: 15px;
        }
        
        .card-header {
            padding: 15px;
        }

        .card-title {
            font-size: 20px;
        }

        .icon-wrapper {
            width: 45px;
            height: 45px;
            font-size: 20px;
        }

        /* Make basic entry table responsive */
        .basic-entry-table {
            display: block;
            overflow-x: visible;
        }

        .basic-entry-table thead {
            display: none;
        }

        .basic-entry-table tbody,
        .basic-entry-table tr {
            display: block;
            width: 100%;
        }

        .basic-entry-table td {
            display: block;
            width: 100% !important;
            padding: 0 0 15px 0 !important;
            border: none !important;
            position: relative;
        }

        .basic-entry-table td::before {
            content: attr(data-label);
            display: block;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .basic-entry-table tr {
            margin-bottom: 0;
            border: none;
            padding: 0;
            background: transparent;
        }

        .basic-entry-table input,
        .basic-entry-table select {
            width: 100% !important;
            margin: 0 !important;
        }

        /* Items table responsive - horizontal scroll */
        .items-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 15px 10px;
            border: none;
        }

        .items-table {
            min-width: 1400px; /* Ensure table doesn't collapse */
        }

        .items-table .table-header {
            font-size: 9px;
            padding: 10px 4px !important;
        }

        .items-table .header-icon {
            font-size: 9px;
            margin-right: 2px;
        }

        .items-table .table-cell {
            padding: 8px 4px !important;
        }

        .items-table input,
        .items-table select {
            font-size: 12px !important;
            padding: 8px !important;
        }

        .action-btn {
            padding: 6px 10px;
            font-size: 11px;
        }

        /* Totals table responsive */
        .totals-table {
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .totals-table thead,
        .totals-table tbody,
        .totals-table tr {
            display: block;
            width: 100%;
        }

        .totals-table thead {
            display: none;
        }

        .totals-table tr {
            margin-bottom: 15px;
        }

        .totals-table td {
            display: block;
            width: 100%;
            padding: 12px 15px !important;
            text-align: left !important;
            position: relative;
            padding-left: 45% !important;
        }

        .totals-table td::before {
            content: attr(data-label);
            position: absolute;
            left: 15px;
            top: 12px;
            font-weight: 600;
            color: #007bff;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        .totals-card {
            padding: 15px;
        }

        /* Form actions responsive */
        .form-actions {
            flex-direction: column;
            gap: 12px;
        }

        .submit-btn,
        .cancel-btn {
            width: 100%;
            justify-content: center;
            padding: 14px 20px;
        }

        /* Add horizontal scroll indicator */
        .items-container::after {
            content: '← Scroll horizontally to view all fields →';
            display: block;
            text-align: center;
            padding: 10px;
            color: #6c757d;
            font-size: 12px;
            font-style: italic;
            background: #f8f9fd;
            border-radius: 8px;
            margin-top: 10px;
        }
    }

    @media (max-width: 576px) {
        .page-header h3 {
            font-size: 1.5rem !important;
        }

        .card-title {
            font-size: 18px;
        }

        .form-card {
            margin-bottom: 1rem;
        }

        .add-btn {
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }

        .card-header {
            flex-direction: column;
        }

        .card-header .d-flex {
            flex-direction: column;
            text-align: center;
        }

        .icon-wrapper {
            margin: 0 auto 15px !important;
        }

        .items-table {
            min-width: 1200px; /* Slightly reduce on very small screens */
        }
    }
</style>

    <!-- Page header style -->
<style>
  /* ===== PAGE HEADER STYLES ONLY (Prefixed with ph-) ===== */
  :root {
    --ph-primary-color: #2563eb;
    --ph-primary-hover: #1d4ed8;
    --ph-secondary-color: #64748b;
    --ph-bg-secondary: #f8fafc;
    --ph-bg-tertiary: #f1f5f9;
    --ph-bg-accent: #e2e8f0;
    --ph-text-primary: #0f172a;
    --ph-text-secondary: #4a4a4a;
    --ph-text-light: #94a3b8;
    --ph-border-color: #e2e8f0;
    --ph-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --ph-radius-sm: 8px;
    --ph-radius-md: 12px;
    --ph-radius-lg: 16px;
    --ph-spacing-xs: 8px;
    --ph-spacing-sm: 12px;
    --ph-spacing-md: 16px;
    --ph-spacing-lg: 24px;
    --ph-spacing-xl: 32px;
    --ph-spacing-2xl: 48px;
  }

  /* Page Header Section */
  .page-header-section {
    margin-bottom: var(--ph-spacing-2xl);
  }

  .ph-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    /* Changed from flex-start to center */
    flex-wrap: wrap;
    gap: var(--ph-spacing-lg);
  }

  .ph-header-left {
    display: flex;
    align-items: center;
    gap: var(--ph-spacing-md);
    flex-shrink: 0;
  }

  .ph-icon-wrapper {
    width: 64px;
    height: 64px;
    background: var(--ph-primary-color);
    border-radius: var(--ph-radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    box-shadow: var(--ph-shadow-lg);
    flex-shrink: 0;
  }

  .ph-header-text {
    flex: 1;
  }

  .ph-header-title {
    font-weight: 500;
    font-size: 28px;
    color: #2c3e50;
    margin: 0 0 4px 0;
    letter-spacing: -0.02em;
  }

  .ph-header-subtitle {
    font-size: 16px;
    color: var(--ph-text-secondary);
    margin: 0;
    font-weight: 500;
  }

  .ph-header-stats {
    margin-left: auto;
  }

  .ph-stat-badge {
    display: flex;
    align-items: center;

    padding: var(--ph-spacing-sm) var(--ph-spacing-md);
    background: var(--ph-bg-tertiary);
    border: 2px solid var(--ph-border-color);
    border-radius: var(--ph-radius-md);
    font-weight: 600;
    color: var(--ph-text-secondary);
    font-size: 14px;
  }

  /* Breadcrumbs */
  .ph-breadcrumb-nav {
    margin-top: 3rem;
  }

  .ph-breadcrumb-list {
    display: flex;
    align-items: center;
    margin: 0;
    padding: 0;
    list-style: none;
    flex-wrap: wrap;

  }

  .ph-breadcrumb-item {
    display: flex;
    align-items: center;
  }

  .ph-breadcrumb-link {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--ph-bg-secondary);
    border-radius: var(--ph-radius-sm);
    text-decoration: none;
    color: var(--ph-text-secondary);
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }

  .ph-breadcrumb-link:hover {
    background: var(--ph-bg-accent);
    color: var(--ph-text-primary);
    border-color: var(--ph-border-color);
  }

  .ph-breadcrumb-item.active span {
    color: var(--ph-primary-color);
    font-weight: 600;
    padding: 6px 12px;
    background: rgba(37, 99, 235, 0.1);
    border-radius: var(--ph-radius-sm);
    font-size: 14px;
  }

  .ph-breadcrumb-separator {
    color: var(--ph-text-light);
    margin: 0 4px;
    font-size: 12px;
  }
  @media (max-width: 768px) { /* adjust breakpoint as needed */
  .ph-header-stats {
    display: none !important;
  }
  .ph-breadcrumb-nav {
    margin-top: 5px;
  }
  .ph-header-title {
    font-size: 1.7rem;
  }
}
</style>


<div class="container">
    <div class="page-inner">
        <div class="page-header-section" style="margin-top: 1rem;">
            <div class="ph-header-content">
                <div class="ph-header-left">
                    <div class="ph-icon-wrapper">
                        <i class="fa-solid fa-snowflake"></i>
                    </div>
                    <div class="ph-header-text">
                        <h3 class="ph-header-title">{% if form.instance.pk %}Update Return Tenant Freezing{% else %}Create Return Tenant Freezing{% endif %}</h3>
                        <p class="ph-header-subtitle">Manage your freezing operations.</p>
                    </div>
                </div>

                <!-- Breadcrumbs - Now inline with header -->
                <nav class="ph-breadcrumb-nav">
                    <ol class="ph-breadcrumb-list">
                        <li class="ph-breadcrumb-item">
                            <a href="#" class="ph-breadcrumb-link">
                                <i class="icon-home"></i>
                                <span>Home</span>
                            </a>
                        </li>
                        <li class="ph-breadcrumb-separator">
                            <i class="icon-arrow-right"></i>
                        </li>
                        <li class="ph-breadcrumb-item ">
                            <a href="{%url 'adminapp:list_return_tenant'%}" class="ph-breadcrumb-link">
                                <i class="fa-solid fa-snowflake"></i>
                                <span> Return Tenat Freezing Entries</span>
                            </a>
                        </li>
                        <li class="ph-breadcrumb-separator">
                            <i class="icon-arrow-right"></i>
                        </li>
                        <li class="ph-breadcrumb-item active">
                            <a href="{%url 'adminapp:create_return_tenant'%}">
                                <span>Create</span>
                            </a>
                        </li>
                    </ol>
                </nav>
                <div class="ph-header-stats">

                </div>
            </div>
        </div>

        <form method="post" novalidate id="return-form" class="return-entry-form">
            {% csrf_token %}

            <!-- Return Entry Details Card -->
            <div class="form-card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper me-4">
                            <i class="fas fa-undo-alt"></i>
                        </div>
                        <div>
                            <h3 class="card-title">Return Entry Details</h3>
                            <p class="text-muted mb-0">Enter basic return information</p>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <table class="basic-entry-table">
                        <thead>
                            <tr>
                                <th>
                                    <div class="header-content">
                                        <i class="fas fa-calendar-alt header-icon"></i>
                                        <span>Return Date</span>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <i class="fas fa-hashtag header-icon"></i>
                                        <span>Voucher Number</span>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <i class="fas fa-building header-icon"></i>
                                        <span>Tenant Company</span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    {{ form.return_date }}
                                    {% if form.return_date.errors %}
                                        <div class="text-danger">{{ form.return_date.errors }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.voucher_number }}
                                    {% if form.voucher_number.errors %}
                                        <div class="text-danger">{{ form.voucher_number.errors }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    <select id="tenant-company" name="tenant_company_name" class="tenant-select">
                                        <option value="">Select Tenant</option>
                                    </select>
                                    {% if form.tenant_company_name.errors %}
                                        <div class="text-danger">{{ form.tenant_company_name.errors }}</div>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Returned Items Card -->
            <div class="form-card">
                <div class="card-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="icon-wrapper me-4">
                                <i class="fas fa-boxes"></i>
                            </div>
                            <div>
                                <h4 class="card-title mb-0">Returned Items</h4>
                                <p class="text-muted mb-0">Add items to your return entry</p>
                            </div>
                        </div>
                        <button type="button" id="add-row" class="add-btn">
                            <i class="fas fa-plus me-2"></i>Add Item
                        </button>
                    </div>
                </div>

                {{ formset.management_form }}

                <div class="card-body p-0">
                    <div class="items-container">
                        <table class="modern-table items-table" id="formset-table">
                            <thead>
                                <tr>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-cube header-icon"></i>
                                            <span>OG Item</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-industry header-icon"></i>
                                            <span>PR Center</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-store header-icon"></i>
                                            <span>Store</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-tag header-icon"></i>
                                            <span>Item</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-star header-icon"></i>
                                            <span>Category</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-ruler header-icon"></i>
                                            <span>Unit</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-sparkles header-icon"></i>
                                            <span>Glaze</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-list header-icon"></i>
                                            <span>FR CTRY</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-trademark header-icon"></i>
                                            <span>Brand</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-fish header-icon"></i>
                                            <span>Species</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-certificate header-icon"></i>
                                            <span>Grade</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-layer-group header-icon"></i>
                                            <span>Slab Qty</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-boxes header-icon"></i>
                                            <span>CS Qty</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-weight header-icon"></i>
                                            <span>KG</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-dollar-sign header-icon"></i>
                                            <span>Rate</span>
                                        </div>
                                    </th>
                                    <th class="table-header">
                                        <div class="header-text">
                                            <i class="fas fa-calculator header-icon"></i>
                                            <span>Amount</span>
                                        </div>
                                    </th>
                                    <th class="table-header text-center">
                                        <div class="header-text justify-content-center">
                                            <i class="fas fa-tools header-icon"></i>
                                            <span>Action</span>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for form in formset %}
                                <tr class="form-row formset-form data-row table-row">
                                    <td class="table-cell">
                                        <div class="original-item-container">
                                            {{ form.original_item }}
                                        </div>
                                        {{ form.original_item.errors }}
                                    </td>
                                    <td class="table-cell">{{ form.processing_center }} {{ form.processing_center.errors }}</td>
                                    <td class="table-cell">{{ form.store }} {{ form.store.errors }}</td>
                                    <td class="table-cell">{{ form.item }} {{ form.item.errors }}</td>
                                    <td class="table-cell">{{ form.item_quality }} {{ form.item_quality.errors }}</td>
                                    <td class="table-cell">{{ form.unit }} {{ form.unit.errors }}</td>
                                    <td class="table-cell">{{ form.glaze }} {{ form.glaze.errors }}</td>
                                    <td class="table-cell">{{ form.freezing_category }} {{ form.freezing_category.errors }}</td>
                                    <td class="table-cell">{{ form.brand }} {{ form.brand.errors }}</td>
                                    <td class="table-cell">{{ form.species }} {{ form.species.errors }}</td>
                                    <td class="table-cell">{{ form.grade }} {{ form.grade.errors }}</td>
                                    <td class="table-cell">{{ form.slab_quantity }} {{ form.slab_quantity.errors }}</td>
                                    <td class="table-cell">{{ form.c_s_quantity }} {{ form.c_s_quantity.errors }}</td>
                                    <td class="table-cell">{{ form.kg }} {{ form.kg.errors }}</td>
                                    <td class="table-cell">
                                        <input type="text" class="tariff-display" readonly placeholder="₹0.00">
                                    </td>
                                    <td class="table-cell">
                                        <input type="text" class="amount-display" readonly placeholder="₹0.00">
                                    </td>
                                    <td class="table-cell text-center">
                                        <button type="button" class="action-btn delete-btn remove-row">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>Remove</span>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Totals Card -->
            <div class="form-card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper me-4">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <h4 class="card-title mb-0">Return Entry Summary</h4>
                            <p class="text-muted mb-0">Overview of return totals</p>
                        </div>
                    </div>
                </div>
                <div class="totals-card">
                    <table class="totals-table">
                        <thead>
                            <tr>
                                <th>Total Slab</th>
                                <th>Total C/S</th>
                                <th>Total KG</th>
                                <th>Total Amount</th>
                                <th>Return Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{{ form.total_slab }} {{ form.total_slab.errors }}</td>
                                <td>{{ form.total_c_s }} {{ form.total_c_s.errors }}</td>
                                <td>{{ form.total_kg }} {{ form.total_kg.errors }}</td>
                                <td>
                                    <input type="number" id="id_total_amount" readonly>
                                </td>
                                <td>{{ form.return_status }} {{ form.return_status.errors }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Submit Section -->
            <div class="form-actions">
                <button type="submit" class="submit-btn">
                    <i class="fas fa-save me-2"></i>Save Return Entry
                </button>
                <a href="{% url 'adminapp:list_return_tenant' %}" class="cancel-btn">
                    <i class="fas fa-times me-2"></i>Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- All your existing JavaScript remains the same -->
<script>
            // Initialize functions for row management
            function initializeRow($row) {
                // Add CSS classes for easier selection
                $row.find('select[name*="original_item"]').addClass('original-item-select');
                $row.find('select[name*="item"]:not([name*="original_item"])').addClass('item-select');
                $row.find('select[name*="species"]').addClass('species-select');
                $row.find('select[name*="unit"]').addClass('unit-select');
                $row.find('input[name*="slab_quantity"]').addClass('slab-quantity');
                $row.find('input[name*="c_s_quantity"]').addClass('cs-quantity');
                $row.find('input[name*="kg"]').addClass('kg kg-input');
                $row.find('select[name*="freezing_category"]').addClass('freezing-category-select');
            }
            
            function initializeNewRow($row) {
                initializeRow($row);
                // Load original items for new row if tenant is already selected
                let tenantId = $('.tenant-select').val();
                if (tenantId) {
                    loadOriginalItemsForRow($row, tenantId);
                }
                // Focus on the first field
                $row.find('select, input').first().focus();
            }
    
            $(document).ready(function () {
                // Initialize existing rows
                $('.formset-form').each(function() {
                    initializeRow($(this));
                });
            });
    
            // Load Original Items based on selected tenant for all rows
            function loadOriginalItems(tenantId = null) {
                $('.original-item-select').each(function() {
                    let $select = $(this);
                    let $container = $select.closest('.original-item-container');
                    
                    if (!tenantId) {
                        // Clear the dropdown if no tenant selected
                        $select.html('<option value="">Select Tenant First</option>');
                        $container.find('.change-selection-btn').remove();
                        return;
                    }
                    
                    loadOriginalItemsForRow($select.closest('.formset-form'), tenantId);
                });
            }
    
            // Load Original Items for a specific row
            function loadOriginalItemsForRow($row, tenantId) {
                let $select = $row.find('.original-item-select');
                let $container = $select.closest('.original-item-container');
                
                if (!tenantId) {
                    $select.html('<option value="">Select Tenant First</option>');
                    $container.find('.change-selection-btn').remove();
                    return;
                }
                
                // Show loading
                $select.html('<option value="">Loading...</option>');
                
                $.ajax({
                    url: "{% url 'adminapp:get_tenant_original_items' %}",
                    data: { tenant_id: tenantId },
                    success: function(data) {
                        $select.empty();
                        $select.append('<option value="">Select Original Item</option>');
                        
                        if (data.items && data.items.length > 0) {
                            data.items.forEach(function(item) {
                                $select.append('<option value="' + item.id + '">' + item.display_name + '</option>');
                            });
                        } else {
                            $select.append('<option value="">No items found for this tenant</option>');
                        }
                    },
                    error: function() {
                        $select.html('<option value="">Error loading items</option>');
                        console.error('Failed to load original items for tenant:', tenantId);
                    }
                });
            }
    
            // Updated tenant selection handler
            $(document).on('change', '.tenant-select', function() {
                let tenantId = $(this).val();
                
                // Clear all existing selections in original item dropdowns
                $('.original-item-select').each(function() {
                    let $select = $(this);
                    let $container = $select.closest('.original-item-container');
                    let $row = $select.closest('.formset-form');
                    
                    // Remove change button and clear stored options
                    $container.find('.change-selection-btn').remove();
                    $select.removeData('original-options');
                    
                    // Clear all populated fields
                    $row.find('select, input').not('[name*="DELETE"]').val('');
                    $row.find('.tariff-display, .amount-display').val('');
                });
                
                // Load new items for the selected tenant
                loadOriginalItems(tenantId);
                
                // Update tariffs for all rows
                $('.formset-form').each(function() {
                    updateRowTariff($(this));
                });
            });
    
            // Auto-populate fields when original item is selected
            $(document).on('change', '.original-item-select', function() {
                let $row = $(this).closest('.formset-form');
                let $select = $(this);
                let $container = $(this).closest('.original-item-container');
                let originalItemId = $(this).val();
                
                if (originalItemId) {
                    // Store all options for potential restoration
                    if (!$select.data('original-options')) {
                        $select.data('original-options', $select.html());
                    }
                    
                    // AJAX call to get original item details
                    $.getJSON("{% url 'adminapp:get_tenant_original_items' %}", {
                        item_id: originalItemId
                    }, function(data) {
                        if (data.success) {
                            // Replace dropdown with only the selected item
                            let selectedOptionText = data.item_name || data.full_description || 'Selected Item';
                            let emptyOption = $select.find('option[value=""]').length > 0 ? '<option value="">---------</option>' : '';
                            $select.html(emptyOption + '<option value="' + originalItemId + '" selected>' + selectedOptionText + '</option>');
                            
                            
                            // Auto-populate form fields with IDs
                            $row.find('select[name*="item"]:not([name*="original_item"])').val(data.item).trigger('change');
                            $row.find('select[name*="store"]').val(data.store);
                            $row.find('select[name*="item_quality"]').val(data.item_quality);
                            $row.find('select[name*="unit"]').val(data.unit).trigger('change');
                            $row.find('select[name*="species"]').val(data.species).trigger('change');
                            $row.find('select[name*="grade"]').val(data.grade);
                            $row.find('select[name*="glaze"]').val(data.glaze);
                            $row.find('select[name*="freezing_category"]').val(data.freezing_category).trigger('change');
                            $row.find('select[name*="brand"]').val(data.brand);
                            $row.find('select[name*="processing_center"]').val(data.processing_center);
                            
                            console.log('Original item details loaded successfully');
                        } else {
                            console.error('Error loading item details:', data.error);
                            alert('Error loading item details: ' + data.error);
                            // Restore original options on error
                            if ($select.data('original-options')) {
                                $select.html($select.data('original-options'));
                            }
                        }
                    }).fail(function(xhr, status, error) {
                        console.error('Failed to load original item details:', error);
                        alert('Failed to load original item details. Please try again.');
                        // Restore original options on error
                        if ($select.data('original-options')) {
                            $select.html($select.data('original-options'));
                        }
                    });
                } else {
                    // Restore all options if no item selected
                    if ($select.data('original-options')) {
                        $select.html($select.data('original-options'));
                    }
                    
                    // Remove change button
                    $container.find('.change-selection-btn').remove();
                    
                    // Clear all fields if no original item selected
                    $row.find('select, input').not('[name*="DELETE"]').val('');
                    $row.find('.tariff-display, .amount-display').val('');
                }
            });
    
            // Handle "Change Selection" button click
            $(document).on('click', '.change-selection-btn', function() {
                let $container = $(this).closest('.original-item-container');
                let $select = $container.find('.original-item-select');
                let $row = $(this).closest('.formset-form');
                let tenantId = $('.tenant-select').val();
                
                // Remove the change button
                $(this).remove();
                
                // Clear all populated fields
                $row.find('select, input').not('[name*="DELETE"]').val('');
                $row.find('.tariff-display, .amount-display').val('');
                
                // Reload original items for this tenant
                if (tenantId) {
                    loadOriginalItemsForRow($row, tenantId);
                } else {
                    $select.html('<option value="">Select Tenant First</option>');
                }
                
                // Focus back on the select after items are loaded
                setTimeout(function() {
                    $select.focus();
                }, 500);
            });
        </script>
    
        <!-- Total Calculation Script -->
        <script>
            function calculateTotals() {
                let totalSlab = 0, totalCS = 0, totalKG = 0;
    
                $('.formset-form:visible').each(function () {
                    // Skip deleted forms
                    if ($(this).find('[name*="DELETE"]').is(':checked')) {
                        return;
                    }
    
                    const getVal = (selector) => {
                        const val = parseFloat($(this).find(selector).val()) || 0;
                        return isNaN(val) ? 0 : val;
                    };
    
                    const slabQty = getVal('[name*="slab_quantity"]');
                    const csQty = getVal('[name*="c_s_quantity"]');
                    const kgWeight = getVal('[name*="kg"]');
                    
                    totalSlab += slabQty;
                    totalCS += csQty;
                    totalKG += kgWeight;
                });
    
                // Update the total fields
                $('#id_total_slab').val(totalSlab.toFixed(2));
                $('#id_total_c_s').val(totalCS.toFixed(2));
                $('#id_total_kg').val(totalKG.toFixed(2));
                
                console.log("Totals calculated - Slab:", totalSlab, "CS:", totalCS, "KG:", totalKG);
            }
    
            // Trigger calculation on any input change
            $(document).on('input change', '.formset-form :input', function() {
                // Debounce the calculation to avoid too many calls
                clearTimeout(window.calcTimeout);
                window.calcTimeout = setTimeout(function() {
                    calculateTotals();
                    calculateTotalAmount();
                }, 300);
            });
            
            $(document).on('change', '.formset-form [name*="DELETE"]', function() {
                calculateTotals();
                calculateTotalAmount();
            });
            
            $(document).ready(function() {
                calculateTotals();
                calculateTotalAmount();
            });
        </script>
    
        <!-- Unit Calculation Script -->
        <script>
            $(document).ready(function () {
                // Helper to recalc a single formset row
                function recalcRow($row) {
                    let slabQty = parseFloat($row.find('.slab-quantity').val()) || 0;
                    let precision = parseFloat($row.data('precision')) || 0;
                    let factor = parseFloat($row.data('factor')) || 0;
    
                    // Calculate CS Quantity only if we have slab quantity and precision
                    if (slabQty && precision) {
                        $row.find('.cs-quantity').val((slabQty / precision).toFixed(2));
                    } else if (!slabQty) {
                        $row.find('.cs-quantity').val('');
                    }
    
                    // Calculate KG only if we have slab quantity and factor
                    if (slabQty && factor) {
                        $row.find('.kg').val((slabQty * factor).toFixed(2));
                    } else if (!slabQty) {
                        $row.find('.kg').val('');
                    }
                    
                    updateRowAmount($row);
                    
                    // Trigger total calculation
                    calculateTotals();
                }
    
                // When unit changes → fetch precision/factor and recalc
                $(document).on('change', '.unit-select', function () {
                    let $row = $(this).closest('.formset-form');
                    let unitId = $(this).val();
    
                    if (!unitId) {
                        // Clear data attributes if no unit selected
                        $row.removeData('precision').removeData('factor');
                        recalcRow($row);
                        return;
                    }
    
                    $.getJSON("{% url 'adminapp:get_unit_details' %}", { unit_id: unitId }, function (data) {
                        $row.data('precision', data.precision || 0);
                        $row.data('factor', data.factor || 0);
                        console.log('Unit details loaded - Precision:', data.precision, 'Factor:', data.factor);
                        recalcRow($row);
                    }).fail(function(xhr, status, error) {
                        console.error('Could not fetch unit details for unit ID:', unitId, error);
                    });
                });
    
                // Trigger recalculation on input changes
                $(document).on('input', '.slab-quantity', function () {
                    let $row = $(this).closest('.formset-form');
                    // Debounce the recalculation
                    clearTimeout($row.data('recalcTimeout'));
                    $row.data('recalcTimeout', setTimeout(function() {
                        recalcRow($row);
                    }, 200));
                });
    
                // Clear dependent fields when slab quantity is cleared
                $(document).on('input', '.slab-quantity', function () {
                    let $row = $(this).closest('.formset-form');
                    if (!$(this).val()) {
                        $row.find('.cs-quantity, .kg').val('');
                        $row.find('.amount-display').val('');
                        $row.data('amount', 0);
                        calculateTotals();
                        calculateTotalAmount();
                    }
                });
    
                // Initialize existing rows with unit data
                $('.formset-form').each(function() {
                    let $row = $(this);
                    let $unitSelect = $row.find('.unit-select');
                    if ($unitSelect.val()) {
                        $unitSelect.trigger('change');
                    }
                });
            });
        </script>
    
        <!-- Tariff Calculation Script -->
        <script>
            // Track pending tariff requests
            let pendingTariffRequests = 0;
            
            // Update tariff for individual row
            function updateRowTariff($row) {
                let tenantId = $('.tenant-select').val();
                let freezingCategoryId = $row.find('.freezing-category-select').val();
                let $tariffDisplay = $row.find('.tariff-display');
                let $amountDisplay = $row.find('.amount-display');
                
                if (!tenantId || !freezingCategoryId) {
                    $tariffDisplay.val('');
                    $amountDisplay.val('');
                    $row.data('tariff', 0);
                    updateRowAmount($row);
                    calculateTotalAmount();
                    return;
                }
                
                // Show loading
                $tariffDisplay.val('Loading...');
                pendingTariffRequests++;
                
                $.getJSON("{% url 'adminapp:get_tenant_tariff' %}", {
                    tenant_id: tenantId,
                    freezing_category_id: freezingCategoryId
                }, function(data) {
                    if (data.success) {
                        let tariff = parseFloat(data.tariff) || 0;
                        $tariffDisplay.val('₹' + tariff.toFixed(2));
                        $row.data('tariff', tariff);
                        
                        // Calculate amount for this row
                        updateRowAmount($row);
                    } else {
                        $tariffDisplay.val('₹0.00');
                        $row.data('tariff', 0);
                        $amountDisplay.val('₹0.00');
                        console.warn('No tariff found:', data.error);
                    }
                }).fail(function(xhr, status, error) {
                    $tariffDisplay.val('Error');
                    $row.data('tariff', 0);
                    $amountDisplay.val('₹0.00');
                    console.error('Failed to get tariff:', error);
                }).always(function() {
                    pendingTariffRequests--;
                    if (pendingTariffRequests === 0) {
                        calculateTotalAmount();
                    }
                });
            }
            
            // Update amount for individual row
            function updateRowAmount($row) {
                let tariff = parseFloat($row.data('tariff')) || 0;
                let kg = parseFloat($row.find('.kg-input').val()) || 0;
                let amount = tariff * kg;
                
                $row.find('.amount-display').val('₹' + amount.toFixed(2));
                $row.data('amount', amount);
                
                if (pendingTariffRequests === 0) {
                    calculateTotalAmount();
                }
            }
            
            // Calculate total amount from all rows
            function calculateTotalAmount() {
                let totalAmount = 0;
                
                $('.formset-form:visible').each(function() {
                    // Skip deleted forms
                    if ($(this).find('[name*="DELETE"]').is(':checked')) {
                        return;
                    }
                    
                    let rowAmount = parseFloat($(this).data('amount')) || 0;
                    totalAmount += rowAmount;
                });
                
                $('#id_total_amount').val(totalAmount.toFixed(2));
                
                // Update calculation status
                let $status = $('#calculation-status span');
                if (totalAmount > 0) {
                    $status.text('✅').removeClass('text-muted').addClass('text-success');
                } else {
                    $status.text('💰').removeClass('text-success').addClass('text-muted');
                }
                
                console.log("Total amount calculated:", totalAmount);
            }
            
            // Event handlers for tariff calculation
            $(document).on('change', '.freezing-category-select', function() {
                let $row = $(this).closest('.formset-form');
                updateRowTariff($row);
            });
            
            $(document).on('input change', '.kg-input', function() {
                let $row = $(this).closest('.formset-form');
                // Debounce the amount calculation
                clearTimeout($row.data('amountTimeout'));
                $row.data('amountTimeout', setTimeout(function() {
                    updateRowAmount($row);
                }, 300));
            });
            
            $(document).ready(function() {
                // First calculate basic totals
                calculateTotals();
                
                // Then initialize tariffs for existing rows that have data
                $('.formset-form').each(function() {
                    let $row = $(this);
                    let tenantId = $('.tenant-select').val();
                    let freezingCategoryId = $row.find('.freezing-category-select').val();
                    
                    if (tenantId && freezingCategoryId) {
                        updateRowTariff($row);
                    } else {
                        // If no tariff data, still calculate with zero tariff
                        $row.data('tariff', 0);
                        updateRowAmount($row);
                    }
                });
                
                setTimeout(function() {
                    if (pendingTariffRequests === 0) {
                        calculateTotalAmount();
                    }
                }, 1000);
            });
        </script>
    
        <!-- Form Validation Script -->
        <script>
            $(document).ready(function() {
                $('#return-form').on('submit', function(e) {
                    let isValid = true;
                    let errorMessages = [];
                    
                    // Check if at least one item exists
                    let visibleRows = $('.formset-form:visible').filter(function() {
                        return !$(this).find('[name*="DELETE"]').is(':checked');
                    });
                    
                    if (visibleRows.length === 0) {
                        isValid = false;
                        errorMessages.push('At least one item is required.');
                    }
                    
                    // Validate each visible row
                    visibleRows.each(function(index) {
                        let $row = $(this);
                        let rowErrors = [];
                        let rowIndex = index + 1;
                        
                        // Check if item is selected
                        let $itemField = $row.find('select[name*="item"]:not([name*="original_item"])');
                        let itemValue = $itemField.val();
                        
                        if (!itemValue || itemValue.toString().trim() === '' || itemValue === 'null') {
                            rowErrors.push('Item is required');
                            $itemField.addClass('is-invalid');
                        } else {
                            $itemField.removeClass('is-invalid');
                        }
                        
                        // Check freezing category
                        let $freezingField = $row.find('select[name*="freezing_category"]');
                        let freezingValue = $freezingField.val();
                        
                        if (!freezingValue || freezingValue.toString().trim() === '' || freezingValue === 'null') {
                            rowErrors.push('Freezing Category is required');
                            $freezingField.addClass('is-invalid');
                        } else {
                            $freezingField.removeClass('is-invalid');
                        }
                        
                        // Check KG value
                        let $kgField = $row.find('input[name*="kg"]');
                        let kgValue = $kgField.val();
                        let kg = parseFloat(kgValue) || 0;
                        
                        if (kg <= 0) {
                            rowErrors.push('KG must be greater than 0');
                            $kgField.addClass('is-invalid');
                        } else {
                            $kgField.removeClass('is-invalid');
                        }
                        
                        // Check slab quantity
                        let $slabField = $row.find('input[name*="slab_quantity"]');
                        let slabValue = $slabField.val();
                        let slab = parseFloat(slabValue) || 0;
                        
                        if (slab <= 0) {
                            rowErrors.push('Slab quantity must be greater than 0');
                            $slabField.addClass('is-invalid');
                        } else {
                            $slabField.removeClass('is-invalid');
                        }
                        
                        if (rowErrors.length > 0) {
                            isValid = false;
                            errorMessages.push(`Row ${rowIndex}: ${rowErrors.join(', ')}`);
                        }
                    });
                    
                    if (!isValid) {
                        e.preventDefault();
                        
                        // Scroll to first invalid field
                        let $firstInvalid = $('.is-invalid').first();
                        if ($firstInvalid.length) {
                            $firstInvalid[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Focus on the field after scrolling
                            setTimeout(() => $firstInvalid.focus(), 500);
                        }
                        
                        alert('Please fix the following errors:\n\n' + errorMessages.join('\n'));
                        return false;
                    }
                    
                    // Remove any remaining invalid styling
                    $('.is-invalid').removeClass('is-invalid');
                    
                    // Show loading state
                    $(this).find('button[type="submit"]').prop('disabled', true).text('Saving...');
                });
                
                // Remove invalid styling when user starts typing/selecting
                $(document).on('input change', '.form-control', function() {
                    $(this).removeClass('is-invalid');
                });
            });
        </script>
    
        <!-- Add/Remove Rows Script -->
        <script>
            $(document).ready(function () {
                // Get the correct formset prefix from the management form
                let formIndex = parseInt($('#id_items-TOTAL_FORMS').val()) || 0;
                
                // Add row functionality
                $("#add-row").click(function () {
                    let currentTotal = parseInt($('#id_items-TOTAL_FORMS').val());
                    
                    // Clone the first row (template)
                    let emptyFormHtml = $('#formset-table tbody tr.formset-form:first').clone(true);
                    
                    // Update all form indices in the cloned row
                    emptyFormHtml.find("input, select, textarea").each(function () {
                        let name = $(this).attr("name");
                        let id = $(this).attr("id");
                        
                        if (name) {
                            // Replace the form index in name attribute
                            let newName = name.replace(/items-\d+-/, "items-" + currentTotal + "-");
                            $(this).attr("name", newName);
                            
                            if (id) {
                                let newId = id.replace(/items-\d+-/, "items-" + currentTotal + "-");
                                $(this).attr("id", newId);
                            }
                            
                            // Clear values except for DELETE checkbox
                            if (!name.includes('DELETE')) {
                                if ($(this).is('select')) {
                                    $(this).val('').trigger('change');
                                } else {
                                    $(this).val('');
                                }
                            } else {
                                $(this).prop('checked', false);
                            }
                        }
                    });
                    
                    // Remove any error states from cloned form
                    emptyFormHtml.find('.is-invalid').removeClass('is-invalid');
                    emptyFormHtml.find('.text-danger').remove();
                    
                    // Clear display fields
                    emptyFormHtml.find('.tariff-display, .amount-display').val('');
                    
                    // Reset the original item container
                    let $originalContainer = emptyFormHtml.find('.original-item-container');
                    $originalContainer.find('.change-selection-btn').remove();
                    
                    // Append to table
                    emptyFormHtml.appendTo("#formset-table tbody");
                    
                    // Update total forms count
                    $('#id_items-TOTAL_FORMS').val(currentTotal + 1);
                    
                    console.log('Added row with index:', currentTotal);
                    console.log('New total forms:', currentTotal + 1);
                    
                    // Initialize the new row
                    initializeNewRow(emptyFormHtml);
                });
    
                // Remove row functionality
                $(document).on('click', '.remove-row', function () {
                    let $row = $(this).closest("tr");
                    
                    if ($("#formset-table tbody tr.formset-form:visible").length > 1) {
                        // Check if this is an existing record (has an ID field with value)
                        let deleteField = $row.find('[name*="DELETE"]');
                        let idField = $row.find('[name*="id"]');
                        
                        if (deleteField.length > 0 && idField.val()) {
                            // Mark for deletion instead of removing
                            deleteField.prop('checked', true);
                            $row.hide();
                        } else {
                            // Actually remove the row for new items
                            $row.remove();
                            
                            // Reindex all remaining forms
                            reindexForms();
                        }
                        
                        // Recalculate totals
                        calculateTotals();
                        calculateTotalAmount();
                    } else {
                        alert("At least one item is required.");
                    }
                });
                
                // Function to reindex all forms after removal
                function reindexForms() {
                    let formIndex = 0;
                    $('#formset-table tbody tr.formset-form:visible').each(function() {
                        let $row = $(this);
                        
                        // Skip if this row is marked for deletion
                        if ($row.find('[name*="DELETE"]').is(':checked')) {
                            return;
                        }
                        
                        $row.find('input, select, textarea').each(function() {
                            let name = $(this).attr('name');
                            let id = $(this).attr('id');
                            
                            if (name) {
                                let newName = name.replace(/items-\d+-/, 'items-' + formIndex + '-');
                                $(this).attr('name', newName);
                                
                                if (id) {
                                    let newId = id.replace(/items-\d+-/, 'items-' + formIndex + '-');
                                    $(this).attr('id', newId);
                                }
                            }
                        });
                        
                        formIndex++;
                    });
                    
                    // Update the total forms count
                    $('#id_items-TOTAL_FORMS').val(formIndex);
                    console.log('Reindexed forms, new total:', formIndex);
                }
            });
        </script>
    
        <!-- Load Tenant Companies Script -->
        <script>
            $(document).ready(function(){
                $.ajax({
                    url: "{% url 'adminapp:get_tenant_companies' %}",
                    success: function(data){
                        var tenantSelect = $("#tenant-company");
                        tenantSelect.empty();
                        tenantSelect.append('<option value="">Select Tenant</option>');
                        data.tenants.forEach(function(tenant){
                            tenantSelect.append('<option value="'+tenant.id+'">'+tenant.name+'</option>');
                        });
                    },
                    error: function() {
                        console.error('Failed to load tenant companies');
                    }
                });
            });
        </script>
    
        <script>
    $(document).ready(function() {
        // Disable DataTables auto-initialization
        $.fn.dataTable.ext.errMode = 'none';
        
        // Or if you want to be more specific, you can also add:
        $.extend($.fn.dataTable.defaults, {
            "autoWidth": false,
            "searching": false,
            "paging": false,
            "info": false
        });
    });
    </script>
   </div>

{%endblock%}