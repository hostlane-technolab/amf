<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Freezing Entry Form</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f5f5f5;
        }

        .formset {
            margin-bottom: 10px;
        }

        .formset-form {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        .button {
            margin-top: 10px;
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        #add-more-btn {
            background-color: #008CBA; /* Different color for add button */
        }        
    </style>
</head>

<body>

    <h2>Create Freezing Entry</h2>
    <a href="{% url 'adminapp:freezing_entry_spot_list' %}">Back to List</a>

    <form method="post">
        {% csrf_token %}

        <table>
            <tr>
                <th>Freezing Date</th>
                <td>{{ form.freezing_date }} {{ form.freezing_date.errors }}</td>
            </tr>
            <tr>
                <th>Voucher Number</th>
                <td>{{ form.voucher_number }} {{ form.voucher_number.errors }}</td>
            </tr>
            <tr>
                <th>Spot Purchase Date</th>
                <td>{{ form.spot_purchase_date }} {{ form.spot_purchase_date.errors }}</td>
            </tr>
            <tr>
                <th>Spot</th>
                <td>{{ form.spot }} {{ form.spot.errors }}</td>
            </tr>
            <tr>
                <th>Spot Agent</th>
                <td>{{ form.spot_agent }} {{ form.spot_agent.errors }}</td>
            </tr>
            <tr>
                <th>Spot Supervisor</th>
                <td>{{ form.spot_supervisor }} {{ form.spot_supervisor.errors }}</td>
            </tr>
            <tr>
                <th>Total Yield Percentage</th>
                <td>{{ form.total_yield_percentage }} {{ form.total_yield_percentage.errors }}</td>
            </tr>
            <tr>
                <th>Total USD</th>
                <td>{{ form.total_usd }} {{ form.total_usd.errors }}</td>
            </tr>
            <tr>
                <th>Total INR</th>
                <td>{{ form.total_inr }} {{ form.total_inr.errors }}</td>
            </tr>
            <tr>
                <th>Total Slab</th>
                <td>{{ form.total_slab }} {{ form.total_slab.errors }}</td>
            </tr>
            <tr>
                <th>Total C/S</th>
                <td>{{ form.total_c_s }} {{ form.total_c_s.errors }}</td>
            </tr>
            <tr>
                <th>Total KG</th>
                <td>{{ form.total_kg }} {{ form.total_kg.errors }}</td>
            </tr>
            <tr>
                <th>Freezing Status</th>
                <td>{{ form.freezing_status }} {{ form.freezing_status.errors }}</td>
            </tr>
        </table>

        <fieldset>
            <legend>Items</legend>
            {{ formset.management_form }}
            <div id="formset-container">
                {% for form in formset %}
                <div class="formset-form">

                    <table>
                        <tr>
                            <th>Processing Centre</th>
                            <td>{{ form.processing_center }} {{ form.processing_center.errors }}</td>
                        </tr>
                        <tr>
                            <th>Store</th>
                            <td>{{ form.store }} {{ form.store.errors }}</td>
                        </tr>
                        <tr>
                            <th>Shed</th>
                            <td>{{ form.shed }} {{ form.shed.errors }}</td>
                        </tr>
                        <tr>
                            <th>Item Name</th>
                            <td>{{ form.item }} {{ form.item.errors }}</td>
                        </tr>
                        <tr>
                            <th>Unit</th>
                            <td>{{ form.unit }} {{ form.unit.errors }}</td>
                        </tr>
                        <tr>
                            <th>Glaze</th>
                            <td>{{ form.glaze }} {{ form.glaze.errors }}</td>
                        </tr>
                        <tr>
                            <th>Freezing Category</th>
                            <td>{{ form.freezing_category }} {{ form.freezing_category.errors }}</td>
                        </tr>
                        <tr>
                            <th>Brand</th>
                            <td>{{ form.brand }} {{ form.brand.errors }}</td>
                        </tr>
                        <tr>
                            <th>Species</th>
                            <td>{{ form.species }} {{ form.species.errors }}</td>
                        </tr>
                        <tr>
                            <th>Peeling Type</th>
                            <td>{{ form.peeling_type }} {{ form.peeling_type.errors }}</td>
                        </tr>
                        <tr>
                            <th>Grade</th>
                            <td>{{ form.grade }} {{ form.grade.errors }}</td>
                        </tr>
                        <tr>
                            <th>Slab Quantity</th>
                            <td>{{ form.slab_quantity }} {{ form.slab_quantity.errors }}</td>
                        </tr>
                        <tr>
                            <th>C/S Quantity</th>
                            <td>{{ form.c_s_quantity }} {{ form.c_s_quantity.errors }}</td>
                        </tr>
                        <tr>
                            <th>Kg</th>
                            <td>{{ form.kg }} {{ form.kg.errors }}</td>
                        </tr>
                        <tr>
                            <th>USD Rate per Kg</th>
                            <td>{{ form.usd_rate_per_kg }} {{ form.usd_rate_per_kg.errors }}</td>
                        </tr>
                        <tr>
                            <th>USD Rate Item</th>
                            <td>{{ form.usd_rate_item }} {{ form.usd_rate_item.errors }}</td>
                        </tr>
                        <tr>
                            <th>USD Rate Item to INR</th>
                            <td>{{ form.usd_rate_item_to_inr }} {{ form.usd_rate_item_to_inr.errors }}</td>
                        </tr>
                        <tr>
                            <th>Yield Percentage</th>
                            <td>{{ form.yield_percentage }} {{ form.yield_percentage.errors }}</td>
                        </tr>
                        <tr>
                            <th>Delete</th>
                            <td>{{ form.DELETE }}</td>
                        </tr>
                    </table>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-more-btn" class="button">+ Add More Item</button>
        </fieldset>

        <br>
        <button type="submit" class="button">Save</button>
    </form>

    <!-- Clone & Add More Formset -->
    <script>
        $(document).ready(function () {
            const formsetContainer = $('#formset-container');
            const totalForms = $('#id_form-TOTAL_FORMS');

            $('#add-more-btn').click(function () {
                let formIndex = parseInt(totalForms.val());
                let newForm = $('.formset-form:first').clone(false);

                newForm.find(':input').each(function () {
                    let name = $(this).attr('name').replace(/-\d+-/, `-${formIndex}-`);
                    let id = 'id_' + name;
                    $(this).attr({ name: name, id: id }).val('');
                    if ($(this).is(':checkbox') || $(this).is(':radio')) {
                        $(this).prop('checked', false);
                    }
                });

                formsetContainer.append(newForm);
                totalForms.val(formIndex + 1);
            });
        });
    </script>

    <!-- Populate logic for spots, agents, supervisors, etc., remains the same -->
    <!-- Include other existing scripts for functionality here -->

<!-- Clone & Add More Formset -->
<script>
    $(document).ready(function () {
        const formsetContainer = $('#formset-container');
        const totalForms = $('#id_form-TOTAL_FORMS');

        $('#add-more-btn').click(function () {
            let formIndex = parseInt(totalForms.val());
            let newForm = $('.formset-form:first').clone(false);

            newForm.find(':input').each(function () {
                let name = $(this).attr('name').replace(/-\d+-/, `-${formIndex}-`);
                let id = 'id_' + name;
                $(this).attr({ name: name, id: id }).val('');
                if ($(this).is(':checkbox') || $(this).is(':radio')) {
                    $(this).prop('checked', false);
                }
            });

            formsetContainer.append(newForm);
            totalForms.val(formIndex + 1);
        });
    });
</script>

<!-- Populate Spots based on Date -->
<script>
    $('#id_spot_purchase_date').on('change', function () {
        const date = $(this).val();
        $.get("{% url 'adminapp:get_spots_by_date' %}", { date: date }, function (data) {
            const spotSelect = $('#id_spot').empty().append('<option value="">---------</option>');
            data.spots.forEach(spot => {
                spotSelect.append(`<option value="${spot.id}">${spot.spot__location_name} - ${spot.voucher_number}</option>`);
            });
        });
    });
</script>

<!-- Populate Agent & Supervisor based on Spot -->
<script>
    $('#id_spot').on('change', function () {
        const spotId = $(this).val();
        if (!spotId) return;

        $.get("{% url 'adminapp:get_spot_details' %}", { spot_id: spotId }, function (data) {
            const agent = $('#id_spot_agent');
            const supervisor = $('#id_spot_supervisor');

            if (!agent.find(`option[value="${data.agent_id}"]`).length) {
                agent.append(`<option value="${data.agent_id}">${data.agent_name}</option>`);
            }
            agent.val(data.agent_id);

            if (!supervisor.find(`option[value="${data.supervisor_id}"]`).length) {
                supervisor.append(`<option value="${data.supervisor_id}">${data.supervisor_name}</option>`);
            }
            supervisor.val(data.supervisor_id);
        });
    });
</script>

<!-- Populate Sheds and Items based on Date -->
<script>
    $('#id_spot_purchase_date').on('change', function () {
        const selectedDate = $(this).val();
        if (!selectedDate) return;

        $.get("{% url 'adminapp:get_sheds_by_date' %}", { date: selectedDate }, function (data) {
            const shedSet = new Set();
            const itemSet = new Set();

            data.sheds.forEach(supply => {
                shedSet.add(`<option value="${supply.shed_id}">${supply.shed_name}</option>`);
                itemSet.add(`<option value="${supply.item_id}">${supply.item_name}</option>`);
            });

            $('[name$="-shed"]').each(function () {
                $(this).empty().append('<option value="">---------</option>');
                shedSet.forEach(opt => $(this).append(opt));
            });

            $('[name$="-item"]').each(function () {
                $(this).empty().append('<option value="">---------</option>');
                itemSet.forEach(opt => $(this).append(opt));
            });
        }).fail(() => alert("Failed to load sheds/items for the selected date."));
    });
</script>

<!-- Total Calculation -->
<script>
    function calculateTotals() {
        let totalYield = 0, totalUSD = 0, totalINR = 0, totalSlab = 0, totalCS = 0, totalKG = 0, count = 0;

        $('.formset-form').each(function () {
            const getVal = (name) => parseFloat($(this).find(`[name$="${name}"]`).val()) || 0;

            const yieldVal = getVal('yield_percentage');
            if (yieldVal > 0) {
                totalYield += yieldVal;
                count++;
            }

            totalUSD += getVal('usd_rate_item');
            totalINR += getVal('usd_rate_item_to_inr');
            totalSlab += getVal('slab_quantity');
            totalCS += getVal('c_s_quantity');
            totalKG += getVal('kg');
        });

        $('#id_total_yield_percentage').val(count ? (totalYield / count).toFixed(2) : 0);
        $('#id_total_usd').val(totalUSD.toFixed(2));
        $('#id_total_inr').val(totalINR.toFixed(2));
        $('#id_total_slab').val(totalSlab.toFixed(2));
        $('#id_total_c_s').val(totalCS.toFixed(2));
        $('#id_total_kg').val(totalKG.toFixed(2));
    }

    $(document).on('input', '.formset-form :input', calculateTotals);
    $(document).ready(calculateTotals);
</script>


<!-- unit calculation -->
<script>
$(document).ready(function () {
    let dollarRate = 0;

    // 1️⃣ Fetch dollar rate on page load
    $.getJSON("{% url 'adminapp:get_dollar_rate' %}", function (data) {
        if (data.dollar_rate_to_inr) {
            dollarRate = parseFloat(data.dollar_rate_to_inr);
        }
    });

    // Helper to recalc a single formset row
    function recalcRow($row) {
        let slabQty = parseFloat($row.find('.slab-quantity').val()) || 0;
        let usdPerKg = parseFloat($row.find('.usd-rate-per-kg').val()) || 0;
        let precision = parseFloat($row.data('precision')) || 0;
        let factor = parseFloat($row.data('factor')) || 0;

        // cs_quantity = slab / precision
        if (slabQty && precision) {
            $row.find('.cs-quantity').val((slabQty / precision).toFixed(2));
        }

        // kg = slab × factor
        if (slabQty && factor) {
            $row.find('.kg').val((slabQty * factor).toFixed(2));
        }

        // usd_rate_item = usd_per_kg × kg
        let kg = parseFloat($row.find('.kg').val()) || 0;
        $row.find('.usd-rate-item').val((usdPerKg * kg).toFixed(2));

        // usd_rate_item_to_inr = usd_rate_item × dollar_rate
        let usdItem = parseFloat($row.find('.usd-rate-item').val()) || 0;
        $row.find('.usd-rate-item-inr').val((usdItem * dollarRate).toFixed(2));
    }

    // 2️⃣ When unit changes → fetch precision/factor and recalc
    $(document).on('change', '.unit-select', function () {
        let $row = $(this).closest('.formset-form');
        let unitId = $(this).val();

        if (!unitId) return;

        $.getJSON("{% url 'adminapp:get_unit_details' %}", { unit_id: unitId }, function (data) {
            $row.data('precision', data.precision);
            $row.data('factor', data.factor);
            recalcRow($row);
        });
    });

    // 3️⃣ Trigger recalculation on input changes
    $(document).on('input', '.slab-quantity, .usd-rate-per-kg', function () {
        let $row = $(this).closest('.formset-form');
        recalcRow($row);
    });
});
</script>


</body>
</html>
