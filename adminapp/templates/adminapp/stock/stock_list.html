{% extends 'admin_base.html' %}
{% block title %}Stock List - Admin Panel{% endblock %}

{% block content %}
<h2>Stock List</h2>

<!-- Search & Filters -->
<form method="get" class="form-inline mb-3">
    <input type="text" name="search" placeholder="Search by Item/Brand/Store" 
           value="{{ search_query }}" class="form-control mr-2">

    <select name="store" class="form-control mr-2">
        <option value="">-- Select Store --</option>
        {% for store in stores %}
            <option value="{{ store.id }}" {% if store.id|stringformat:"s" == selected_store %}selected{% endif %}>
                {{ store.name }}
            </option>
        {% endfor %}
    </select>

    <select name="category" class="form-control mr-2">
        <option value="">-- Select Category --</option>
        {% for category in categories %}
            <option value="{{ category.id }}" {% if category.id|stringformat:"s" == selected_category %}selected{% endif %}>
                {{ category.name }}
            </option>
        {% endfor %}
    </select>

    <select name="brand" class="form-control mr-2">
        <option value="">-- Select Brand --</option>
        {% for brand in brands %}
            <option value="{{ brand.id }}" {% if brand.id|stringformat:"s" == selected_brand %}selected{% endif %}>
                {{ brand.name }}
            </option>
        {% endfor %}
    </select>

    <select name="low_stock" class="form-control mr-2">
        <option value="">-- Stock Filter --</option>
        <option value="true" {% if low_stock_filter == "true" %}selected{% endif %}>Low Stock (&lt;10)</option>
    </select>

    <select name="source" class="form-control mr-2">
        <option value="">-- Source --</option>
        <option value="spot" {% if source_filter == "spot" %}selected{% endif %}>Spot</option>
        <option value="local" {% if source_filter == "local" %}selected{% endif %}>Local</option>
    </select>

    <button type="submit" class="btn btn-primary">Filter</button>
    <a href="{% url 'adminapp:list' %}" class="btn btn-secondary ml-2">Reset</a>
</form>

<!-- Summary -->
<div class="mb-3">
    <strong>Total Stocks:</strong> {{ total_stocks }} |
    <strong>Low Stock:</strong> {{ low_stock_count }}
</div>

<!-- Stock Table -->
<div class="table-responsive">
    <table class="table table-bordered table-striped">
<thead>
    <tr>
        <th>Item</th>
        <th>Brand</th>
        <th>Category</th>
        <th>FR Category</th>
        <th>Unit</th>
        <th>Glaze</th>
        <th>Species</th>
        <th>Grade</th>
        <th>CS Qty</th>
        <th>KG Qty</th>
        <th>Actions</th>
    </tr>
</thead>
<tbody>
    {% for stock in stocks %}
        <tr {% if stock.cs_quantity < 10 or stock.kg_quantity < 10 %}class="table-danger"{% endif %}>
            <td>{{ stock.item.name }}</td>
            <td>{{ stock.brand.name }}</td>
            <td>{{ stock.item_quality.quality }}</td>
            <td>{{ stock.freezing_category.name }}</td>
            <td>{{ stock.unit.unit_code }}</td>
            <td>{{ stock.glaze.percentage }}%</td>
            <td>{{ stock.species.name }}</td>
            <td>{{ stock.item_grade.grade }}</td>
            <td>{{ stock.cs_quantity }}</td>
            <td>{{ stock.kg_quantity }}</td>
            <td>
                <form method="post" action="{% url 'adminapp:stock_delete_direct' stock.id %}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this stock?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </form>
            </td>
        </tr>
    {% empty %}
        <tr>
            <td colspan="12" class="text-center">No stocks found.</td>
        </tr>
    {% endfor %}
</tbody>

    </table>
</div>

<!-- Pagination -->
{% if is_paginated %}
<nav>
    <ul class="pagination">
        {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a></li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        {% for i in paginator.page_range %}
            {% if page_obj.number == i %}
                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
            {% else %}
                <li class="page-item"><a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ i }}">{{ i }}</a></li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a></li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% endblock %}
